```sql
-- MVP 통합 마이그레이션 (2026-01-29)
-- 모든 이전 마이그레이션을 하나로 통합

-- 1. ENUM Types
CREATE TYPE admin_action_enum AS ENUM ('create', 'update', 'banned', 'reorder', 'publish', 'unpublish', 'delete');
CREATE TYPE user_auth_enum AS ENUM ('HYMN', 'admin', 'manager', 'learner');
CREATE TYPE user_language_enum AS ENUM ('ko', 'en');
CREATE TYPE user_gender_enum AS ENUM ('none', 'male', 'female', 'other');
CREATE TYPE user_action_log_enum AS ENUM ('signup', 'find_id', 'reset_pw', 'update');
CREATE TYPE user_set_language_enum AS ENUM ('ko', 'en');
CREATE TYPE login_device_enum AS ENUM ('mobile', 'tablet', 'desktop', 'other');
CREATE TYPE login_method_enum AS ENUM ('email', 'google', 'apple');
CREATE TYPE login_state_enum AS ENUM ('active', 'revoked', 'expired', 'logged_out', 'compromised');
CREATE TYPE login_event_enum AS ENUM ('login', 'logout', 'refresh', 'rotate', 'fail', 'reuse_detected');
CREATE TYPE video_state_enum AS ENUM ('ready', 'open', 'close');
CREATE TYPE video_access_enum AS ENUM ('public', 'paid', 'private', 'promote');
CREATE TYPE study_state_enum AS ENUM ('ready', 'open', 'close');
CREATE TYPE study_access_enum AS ENUM ('public', 'paid', 'private', 'promote');
CREATE TYPE study_program_enum AS ENUM ('basic_pronunciation', 'basic_word', 'basic_900', 'topik_read', 'topik_listen', 'topik_write', 'tbc');
CREATE TYPE study_task_kind_enum AS ENUM ('choice', 'typing', 'voice');
CREATE TYPE study_task_log_action_enum AS ENUM ('view', 'start', 'answer', 'finish', 'explain', 'status');
CREATE TYPE lesson_item_kind_enum AS ENUM ('video', 'task');
CREATE TYPE lesson_state_enum AS ENUM ('ready', 'open', 'close');
CREATE TYPE lesson_access_enum AS ENUM ('public', 'paid', 'private', 'promote');
CREATE TYPE course_type_enum AS ENUM ('video', 'study', 'live', 'package');
CREATE TYPE course_state_enum AS ENUM ('active', 'inactive', 'deleted');

-- 2. Tables

-- 2.0 admin_action_log : 관리자 활동 기록 [접근, 조회]
CREATE TABLE admin_action_log (
  log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 기록 id : 관리자 활동 기록 DB 고유 번호(PK)
  admin_id BIGINT NOT NULL,                                    -- 관리자 id : 활동을 수행한 관리자 id(FK)
  action_type VARCHAR(50) NOT NULL,                            -- 활동 종류 : 수행한 활동 유형 (예: view, create, update)
  target_table VARCHAR(50),                                    -- 대상 테이블 : 작업 대상 테이블명 (선택)
  target_id BIGINT,                                            -- 대상 id : 작업 대상 레코드 id (선택)
  details JSONB,                                               -- 상세 정보 : 추가 활동 정보 (JSON)
  ip_address INET,                                             -- 접속 IP : 관리자 접속 IP
  user_agent TEXT,                                             -- User-Agent : 관리자 브라우저/앱 정보
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()                -- 기록 생성 시간 : 활동 기록 생성 시간
);

-- 2.1 user table : 사용자 테이블

-- 2.1.1 users : 사용자 기본 정보 
CREATE TABLE users (
  user_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 사용자 id : 사용자별 DB 고유 번호(PK)
  user_auth user_auth_enum NOT NULL DEFAULT 'learner',          -- 사용자 권한 : 개발자 - 관리자 - 매니저 - 학습자 순으로 구성
  user_state boolean NOT NULL DEFAULT true,                     -- 사용자 상태 : 서비스를 이용할 수 있는지 없는지 여부 판단
  user_email varchar(255) UNIQUE NOT NULL,                      -- 사용자 이메일 : 사용자 로그인 시 사용하는 아이디(변경불가)
  user_password text NOT NULL,                                  -- 사용자 비빌번호 : 암호화 후 DB 저장, 복호화를 통해 사용
  user_name varchar(100) NOT NULL,                              -- 사용자 이름 : 모든 언어로 저장 가능
  user_nickname varchar(100) NOT NULL,                          -- 사용자 별명 : 모든 언어로 저장 가능
  user_language user_language_enum NOT NULL DEFAULT 'ko',       -- 사용자 언어 : 서비스에서 사용할 언어 선택
  user_country varchar(50) NOT NULL,                            -- 사용자 국가 : 사용자가 속해 있는 국가
  user_birthday date NOT NULL,                                  -- 사용자 생년월일 : 사용자 기본 정보
  user_gender user_gender_enum NOT NULL DEFAULT 'none',         -- 사용자 성별 : 사용자 기본 정보
  user_check_email boolean NOT NULL DEFAULT false,              -- 사용자 이메일 확인 : 사용하는 이메일 점검 및 보안, 복구 로직을 위한 상태 판단
  user_terms_service boolean NOT NULL DEFAULT false,            -- 사용자 이용약관 : 서비스 이용 시 사용자 이용약관 동의 여부
  user_terms_personal boolean NOT NULL DEFAULT false,           -- 사용자 개인정보 약관 : 서비스 이용 시 사용자 개인정보 약관 동의 여부 
  user_created_at timestamptz NOT NULL DEFAULT (now()),         -- 사용자 가입 일시 : 가입 후 자동으로 DB에 생성
  user_quit_at timestamptz                                      -- 사용자 탈퇴 일시 : 탈퇴 후 user_state : false로 전환, 추후 DB에서 삭제
);

-- 2.1.2 users_log : 사용자 기본 정보 활동 기록
CREATE TABLE users_log (
  user_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 사용자 기록 id : 사용자들의 활동 기록 DB 고유 번호(PK)
  updated_by_user_id bigint,                                        -- 사용자를 수정한 사용자 id : 자신이 직접 활동(본인 id), 관리자가 활동(관리자 id)
  user_action_log user_action_log_enum NOT NULL,                    -- 사용자 활동 기록  : 회원가입, id 찾기, pw 재설정, 사용자 정보 업데이트
  user_action_success boolean NOT NULL DEFAULT true,                -- 사용자 활동 성공 여부 : user_action_log가 적용(true), user_action_log가 미적용(false)
  user_id bigint NOT NULL,                                          -- 사용자 id : 사용자별 DB 고유 번호(FK)
  user_auth_log user_auth_enum,                                     -- 사용자 권한 기록 : 사용자 권한 변동 기록(관리자 작업)
  user_state_log boolean,                                           -- 사용자 상태 기록 : 서비스 이용 여부 기록(관리자 작업)
  user_email_log varchar(255),                                      -- 사용자 이메일 기록 : 사용자가 등록한 이메일
  user_certify_log timestamptz,                                     -- 사용자 이메일 검증 기록 : 사용자가 실제 사용하는 이메일 검증 확인 시간 기록
  user_password_log boolean DEFAULT false,                          -- 사용자 비밀번호 변경 기록 : 변경(ture), 미변경(false)
  user_nickname_log varchar(100),                                   -- 사용자 별명 변경 기록 : 별명 변경 기록
  user_language_log user_language_enum,                             -- 사용자 언어 변경 기록 : 언어 변경 기록
  user_country_log varchar(50),                                     -- 사용자 국가 변경 기록 : 국가 변경 기록
  user_birthday_log date,                                           -- 사용자 생년월일 변경 기록 : 생년월일 변경 기록
  user_gender_log user_gender_enum,                                 -- 사용자 성별 변경 기록 : 성별 변경 기록
  user_terms_service_log boolean,                                   -- 사용자 서비스 이용약관 동의 기록 : 동의(true), 미동의(false)
  user_terms_personal_log boolean,                                  -- 사용자 개인 정보 이용약관 동의 기록 : 동의(true), 미동의(false)
  user_log_created_at timestamptz,                                  -- 사용자 활동 기록 생성 시간 : 활동 기록 생성 시간
  user_log_quit_at timestamptz,                                     -- 사용자 탈퇴 기록 시간 : 탈퇴 기록 시간
  user_log_updated_at timestamptz NOT NULL DEFAULT (now())          -- 사용자 활동 기록 수정 시간 : 활동 기록 수정 시간
);

-- 2.1.3 users_setting : 사용자 설정
CREATE TABLE users_setting (
  user_id bigint PRIMARY KEY,                                      -- 사용자 설정 id : 사용자 설정 DB 고유 번호(PK)
  user_set_language user_set_language_enum NOT NULL DEFAULT 'ko',  -- 사용자 설정 언어 : UI에서 사용할 언어(현재 ko, en만 있음 추후 확장 예정)
  user_set_timezone varchar(64),                                   -- 사용자 설정 시간대 : 다국어 사용자를 위한 시간 설정
  user_set_note_email boolean NOT NULL DEFAULT false,              -- 사용자 이메일 수신 여부 : 사용자가 사용하는 email 수신 여부
  user_set_note_push boolean NOT NULL DEFAULT false,               -- 사용자 알림 여부 : 사용자에게 Web or App으로 알림 수신 여부
  user_set_created_at timestamptz NOT NULL DEFAULT (now()),        -- 사용자 설정 생성 시간 : 처음으로 사용자가 설정을 설정한 시간
  user_set_updated_at timestamptz NOT NULL DEFAULT (now())         -- 사용자 설정 수정 시간 : 사용자가 설정을 수정한 시간
);

-- 2.1.4 admin_users_log : 관리자 활동 기록 [사용자]
CREATE TABLE admin_users_log (
  admin_user_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 관리자 활동 기록 [사용자] id : 관리자 활동 기록 [사용자] DB 고유 번호(PK)
  admin_user_id bigint NOT NULL,                                          -- 관리자 id : 사용자 관련 작업을 진행한 관리자 id
  admin_pick_user_id bigint NOT NULL,                                     -- 관리자 작업 사용자 id : 관리자가 작업한 사용자의 id
  admin_user_action admin_action_enum NOT NULL,                           -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_user_before jsonb,                                                -- 관리자 작업전 사용자 내역 : 관리자가 작업한 사용자의 이전 정보 
  admin_user_after jsonb,                                                 -- 관리자 작업후 사용자 내역 : 관리자가 작업후 사용자의 수정 정보
  admin_user_created_at timestamptz NOT NULL DEFAULT (now()),             -- 관리자 사용자 작업 생성 시간 : 관리자가 사용자 작업을 생성한 시간
  admin_user_updated_at timestamptz NOT NULL DEFAULT (now())              -- 관리자 사용자 작업 수정 시간 : 관리자가 사용자 작업을 수정한 시간
);

-- 2.1.4 user_export_data : 사용자 요청 데이터(학습 이력, 수료증 등)
CREATE TABLE user_export_data (
  user_data_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,       -- 사용자 요청 데이터 id : 사용자 요청 데이터 DB 고유 번호(PK)
  user_id bigint NOT NULL,                                                -- 사용자 id : 사용자별 DB 고유 번호(FK)
  user_data_status boolean NOT NULL DEFAULT true,                         -- 사용자 요청 데이터 상태 : 요청 성공(true), 요청 실패(false) 
  user_data_course jsonb,                                                 -- 사용자 요청 데이터 [수강] : 사용자 수강(결제) 관련 정보
  user_data_lesson jsonb,                                                 -- 사용자 요청 데이터 [수업] : 사용자 수업 관련 정보
--user_data_study jsonb, // 추후 추가                                      -- 사용자 요청 데이터 [학습] : 사용자 학습 관련 정보 
--user_data_video jsonb, // 추후 추가                                      -- 사용자 요청 데이터 [영상] : 사용자 영상 관련 정보
  user_data_created_at timestamptz,                                       -- 사용자 요청 데이터 생성 시간 : 요청 데이터 생성 시간
  user_data_expires_at timestamptz,                                       -- 사용자 요청 데이터 만료 시간 : 요청 데이터 만료 시간
  user_data_updated_at timestamptz NOT NULL DEFAULT (now())               -- 사용자 요청 데이터 수정 시간 : 요청 데이터 수정 시간
);

-- 2.2 login table : 로그인 테이블

-- 2.1.1 login : 로그인 기본 정보
CREATE TABLE login (
  login_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 로그인 id : 로그인 DB 고유 번호(PK)
  user_id bigint NOT NULL,                                      -- 사용자 id : 사용자별 DB 고유 번호(FK)
  login_country char(2) NOT NULL,                               -- 로그인 국가 : 로그인을 시도한 국가
  login_asn bigint NOT NULL,                                    -- 로그인 ASN : ASN(Autonomous System Number) Network 정보
  login_org varchar(200) NOT NULL,                              -- 로그인 ORG : organization 정보
  login_ip inet NOT NULL,                                       -- 로그인 IP : 로그인 Internet Protocol 정보
  login_os varchar(100),                                        -- 로그인 OS : window, mac, linux 등으로 구분 예정
  login_browser varchar(100),                                   -- 로그인 브라우저 : chrome, safari 등으로 구분 예정
  login_device login_device_enum NOT NULL DEFAULT 'other',      -- 로그인 장치 : 모바일, 테블릿, 데스크탑, 기타로 구분
  login_method login_method_enum NOT NULL DEFAULT 'email',      -- 로그인 방법 : 구글(소셜), 애플(소셜), 이메일(자체)로 진행 예정
  login_session_id uuid UNIQUE NOT NULL,                        -- 로그인 세션 id : Redis ak:session:<sid> 의 <sid>
  login_refresh_hash varchar(128) UNIQUE,                       -- 로그인 새로고침 해쉬 : Redis ak:refresh:<hash> 의 <hash> — UNIQUE 권장(Null 허용)
  login_user_agent text,                                        -- 로그인 사용자 에이전트 : 로그인 사용자 접속 브라우저/앱 정보
  login_begin_at timestamptz NOT NULL DEFAULT (now()),          -- 로그인 시작 시간 : 로그인 시작 시간
  login_active_at timestamptz,                                  -- 로그인 적용 시간 : 로그인 적용 시간
  login_expire_at timestamptz,                                  -- 로그인 만료 시간 : 로그인 만료 시간
  login_state login_state_enum NOT NULL DEFAULT 'active',       -- 로그인 상태 : 적용, 철회, 만료, 로그아웃, 침해?로 구분
  login_revoked_reason text,                                    -- 로그인 철회 이유 : 로그인 철회 이유
  login_created_at timestamptz NOT NULL DEFAULT (now()),        -- 로그인 생성 시간 : 로그인 생성 시간
  login_updated_at timestamptz NOT NULL DEFAULT (now())         -- 로그인 수정 시간 : 로그인 수정 시간
);

-- 2.1.1 login : 로그인 기본 정보 활동 기록
CREATE TABLE login_log (
  login_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 로그인 기록 id : 로그인 로그 DB 고유 번호(PK)
--login_id fk 추가?  
  user_id bigint,                                                   -- 사용자 id : 사용자별 DB 고유 번호(FK)
  login_event_log login_event_enum,                                 -- 로그인 활동 기록 : 로그인, 로그아웃, 토근 갱신, 토큰 교체, 로그인 실패, 로그인 금지로 구분
  login_success_log boolean,                                        -- 로그인 성공 기록 : 성공(ture), 실패(false)
  login_access_log char(64),                                        -- 로그인 접근 기록 : login_event_log&&login&&login_success_log -> false 일때 잘 못 시도된 아이디 기록
  login_country_log char(2),                                        -- 로그인 국가 기록 : 로그인 국가 기록
  login_asn_log bigint,                                             -- 로그인 ASN 기록 : 로그인 ASN 기록
  login_org_log varchar(200),                                       -- 로그인 ORG 기록 : 로그인 ORG 기록
  login_ip_log inet,                                                -- 로그인 ip 기록 : 로그인 ip 기록
  login_os_log varchar(100),                                        -- 로그인 os 기록 : 로그인 os 기록
  login_browser_log varchar(100),                                   -- 로그인 브라우저 기록 : 로그인 브라우저 기록
  login_device_log login_device_enum,                               -- 로그인 기기 기록 : 모바일, 테블릿, 데스크탑, 기타로 구분
  login_method_log login_method_enum,                               -- 로그인 방법 기록 : 구글(소셜), 애플(소셜), 이메일(자체)로 진행 예정
  login_session_id_log uuid,                                        -- 로그인 세션 id 기록 : Redis ak:session:<sid> 의 <sid> 로그
  login_refresh_hash_log varchar(128),                              -- 로그인 새로고침 해쉬 기록 : Redis ak:refresh:<hash> 의 <hash> — UNIQUE 권장(Null 허용)의 로그
  login_user_agent_log text,                                        -- 로그인 사용자 에이전트 기록 : 로그인 사용자 접속 브라우저/앱 정보 기록
  login_begin_at_log timestamptz NOT NULL DEFAULT (now()),          -- 로그인 시작 시간 기록 : 로그인 시작 시간 기록
  login_expire_at_log timestamptz,                                  -- 로그인 적용 시간 기록 : 로그인 적용 시간 기록
  login_token_id_log varchar,                                       -- 로그인 토근 id 기록 : 로그인 토근 id 기록
  login_fail_reason_log text,                                       -- 로그인 실패 이유 기록 : 로그인 실패 이유 기록
  login_created_at_log timestamptz NOT NULL DEFAULT (now())         -- 로그인 기록 생성 시간 : 로그인 기록 생성 시간
);

-- 2.1.2 Redis 테이블들 : Redis 세션 데이터의 PostgreSQL 백업/동기화용 테이블

-- 2.1.2.1 redis_session : 사용자 세션 정보 (Redis ak:session:<sid> 백업)
CREATE TABLE redis_session (
  redis_key varchar(128) PRIMARY KEY,                   -- Redis 키 : ak:session:<session_id> 형식
  session_id uuid UNIQUE NOT NULL,                      -- 세션 id : 로그인 세션 고유 식별자(UUID)
  user_id bigint NOT NULL,                              -- 사용자 id : 세션 소유 사용자(FK)
  login_id bigint NOT NULL,                             -- 로그인 id : 연결된 로그인 기록(FK)
  state login_state_enum NOT NULL DEFAULT 'active',     -- 세션 상태 : active, revoked, expired, logged_out, compromised
  issued_at timestamptz NOT NULL DEFAULT (now()),       -- 세션 발급 시간 : 세션이 생성된 시간
  expire_at timestamptz NOT NULL,                       -- 세션 만료 시간 : 세션 유효 기간 종료 시간
  revoked_at timestamptz,                               -- 세션 철회 시간 : 강제 로그아웃/보안 철회 시간
  ip inet,                                              -- 접속 IP : 세션 생성 시 클라이언트 IP
  user_agent text,                                      -- User-Agent : 접속 브라우저/앱 정보
  device login_device_enum,                             -- 접속 기기 : mobile, tablet, desktop, other
  method login_method_enum,                             -- 로그인 방법 : email, google, apple
  created_at timestamptz NOT NULL DEFAULT (now()),      -- 레코드 생성 시간 : DB 레코드 생성 시간
  updated_at timestamptz NOT NULL DEFAULT (now())       -- 레코드 수정 시간 : DB 레코드 수정 시간
);

-- 2.1.2.2 redis_refresh : Refresh 토큰 정보 (Redis ak:refresh:<hash> 백업)
CREATE TABLE redis_refresh (
  redis_key varchar(160) PRIMARY KEY,                   -- Redis 키 : ak:refresh:<refresh_hash> 형식
  refresh_hash varchar(128) UNIQUE NOT NULL,            -- Refresh 해시 : 토큰의 SHA-256 해시값
  session_id uuid NOT NULL,                             -- 세션 id : 연결된 세션 식별자(FK)
  user_id bigint,                                       -- 사용자 id : 토큰 소유 사용자(FK)
  issued_at timestamptz NOT NULL DEFAULT (now()),       -- 토큰 발급 시간 : Refresh 토큰 발급 시간
  expire_at timestamptz NOT NULL,                       -- 토큰 만료 시간 : Refresh 토큰 유효 기간 종료
  reused_at timestamptz,                                -- 토큰 재사용 감지 시간 : 토큰 탈취 감지용 (이미 사용된 토큰 재사용 시)
  created_at timestamptz NOT NULL DEFAULT (now()),      -- 레코드 생성 시간 : DB 레코드 생성 시간
  updated_at timestamptz NOT NULL DEFAULT (now())       -- 레코드 수정 시간 : DB 레코드 수정 시간
);

-- 2.1.2.3 redis_user_sessions : 사용자별 활성 세션 목록 (Redis ak:user_sessions:<user_id> 백업)
CREATE TABLE redis_user_sessions (
  redis_key varchar(128) PRIMARY KEY,                   -- Redis 키 : ak:user_sessions:<user_id>:<session_id> 형식
  user_id bigint NOT NULL,                              -- 사용자 id : 세션 소유 사용자(FK)
  session_id uuid NOT NULL,                             -- 세션 id : 활성 세션 식별자(FK)
  added_at timestamptz NOT NULL DEFAULT (now()),        -- 세션 추가 시간 : 사용자 세션 목록에 추가된 시간
  expire_at timestamptz NOT NULL                        -- 세션 만료 시간 : 목록에서 자동 제거될 시간
);

-- 2.3 video table : 동영상 강의 테이블

-- 2.3.1 video : 동영상 강의 기본 정보(링크, 상태, 접근)
CREATE TABLE video (
  video_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 영상 id : 영상 DB 고유 번호(PK)
  updated_by_user_id bigint NOT NULL,                         -- 영상 업로드 id : 영상을 DB에 올린 사용자 id
  video_idx varchar(100) UNIQUE NOT NULL,                     -- 영상 인덱스 : 외부 공개용 인덱스
  video_state video_state_enum NOT NULL DEFAULT 'ready',      -- 영상 상태 : 영상 준비, 영상 공개, 영상 비공개로 구분
  video_access video_access_enum NOT NULL DEFAULT 'public',   -- 영상 접근 : 공용, 유료, 일부공개, 광고로 구분
  video_url_vimeo text NOT NULL,                              -- 영상 url : vimeo url
  video_thumbnail text,                                       -- 영상 썸네일 : vimeo url
  video_duration text,                                        -- 영상 길이 : 초단위로 입력
  video_created_at timestamptz NOT NULL DEFAULT (now()),      -- 영상 생성일 : 등록한 일시
  video_updated_at timestamptz NOT NULL DEFAULT (now())       -- 영상 수정일 : 수정한 일시
);

-- 2.3.2 video_log : 동영상 강의 시청 정보
CREATE TABLE video_log (
  video_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 영상 기록 id : 영상 기록 DB 고유 번호(PK)
  video_id int NOT NULL,                                            -- 영상 id : 영상 DB 고유 번호(FK)
  user_id bigint NOT NULL,                                          -- 사용자 id : 사용자별 DB 고유 번호
  video_progress_log int,                                           -- 영상 진행 기록 : 1-100까지 진행도 표시
  video_completed_log boolean NOT NULL DEFAULT false,               -- 영상 완료 기록 : 완료(ture), 진행중(false)
  video_watch_count_log int NOT NULL DEFAULT 0,                     -- 영상 재생 횟수 기록 : 영상을 반복해서 본 횟수 기록
  video_watch_duration_sec int NOT NULL DEFAULT 0,                  -- 영상 누적 시청 시간 : 초 단위 누적 시청 시간 (분석/통계용)
  video_first_watched_at_log timestamptz,                           -- 영상 시청 시작 시간 기록 : 영상 시청 시작 시간 기록
  video_last_watched_at_log timestamptz,                            -- 영상 시청 종료 시간 기록 : 영상 시청 종료 시간 기록
  video_last_ip_log inet,                                           -- 영상 시청 IP 기록 : 영상 시청 IP 기록
  video_last_device_log login_device_enum,                          -- 영상 시청 기기 기록 : 영상 시청 기기 기록
  video_last_user_agent_log jsonb                                   -- 영상 시청 사용자 기록 : 영상 시청 사용자 기록
);

-- 2.3.2 video_tag : 동영상 강의 메타 정보
CREATE TABLE video_tag (
  video_tag_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 영상 태그 id : 영상 태그 DB 고유 번호(PK)
  video_tag_key varchar(30) UNIQUE NOT NULL,                      -- 영상 태그키 : 외부 공개용 인덱스
  video_tag_title varchar(50) NOT NULL,                           -- 영상 제목 : 제목(vimeo api::name에서 받아옴)
  video_tag_subtitle varchar(100),                                -- 영상 부제목 : 부제목(vimeo api::description에서 받아옴)
  video_tag_created_at timestamptz NOT NULL DEFAULT (now())       -- 영상 태그 생성 시간 : 영상 태그 생성 시간
);

-- 2.3.3 video_tag_map : 동영상 강의 맵핑(video - video_tag / 1:1 맵핑)
CREATE TABLE video_tag_map (
  video_id int NOT NULL,      -- 영상 id : 영상 DB 고유 번호
  video_tag_id int NOT NULL   -- 영상 태그 id : 영상 태그 DB 고유 번호
);

-- 2.3.4 video_stat_daily : 동영상 강의 통계
CREATE TABLE video_stat_daily (
  video_stat_date date,                       -- 영상 시청 일자 : 영상 시청 일자
  video_id int NOT NULL,                      -- 영상 id : 영상 DB 고유 번호
  video_stat_views int NOT NULL DEFAULT 0,    -- 영상 시청 조회수 : 영상 시청 조회수
  video_stat_completes int NOT NULL DEFAULT 0 -- 영상 시청 완료수 : 영상 시청 완료수
);

-- 2.3.5 admin_video_log : 관리자 활동 기록 [동영상 강의]
CREATE TABLE admin_video_log (
  admin_video_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 관리자 활동 기록 [영상] id : 관리자 활동 기록 [영상] DB 고유 번호(PK)
  admin_user_id bigint NOT NULL,                                          -- 관리자 id : 영상 관련 작업을 진행한 관리자 id
  admin_pick_video_id int,                                                -- 관리자 작업 영상 id : 관리자가 작업한 영상의 id
  admin_pick_video_tag_id int,                                            -- 관리자 작업 영상 태그 id : 관리자가 작업한 영상 태그의 id
  admin_video_action admin_action_enum NOT NULL,                          -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_video_before jsonb,                                               -- 관리자 작업전 영상 내역 : 관리자가 작업한 영상의 이전 정보 
  admin_video_after jsonb,                                                -- 관리자 작업후 영상 내역 : 관리자가 작업후 영상의 수정 정보
  admin_video_created_at timestamptz NOT NULL DEFAULT (now()),            -- 관리자 영상 작업 생성 시간 : 관리자가 영상 작업을 생성한 시간
  admin_video_updated_at timestamptz NOT NULL DEFAULT (now())             -- 관리자 영상 작업 수정 시간 : 관리자가 영상 작업을 수정한 시간
);

-- 2.4 study table : 학습 테이블

-- 2.4.1 study : 학습 문제 기본 정보(상태, 접근, 지문)
CREATE TABLE study (
  study_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 학습 문제 id : 학습 DB 고유 번호(PK)
  updated_by_user_id bigint NOT NULL,                         -- 학습 문제 업로드 id : 학습을 DB에 올린 사용자 id 
  study_idx varchar(100) UNIQUE NOT NULL,                     -- 학습 문제 인덱스 : 외부 공개용 인덱스
  study_state study_state_enum NOT NULL DEFAULT 'ready',      -- 학습 문제 상태 : 학습 문제 준비, 학습 문제 공개, 학습 문제 비공개로 구분
  study_access study_access_enum NOT NULL DEFAULT 'public',   -- 학습 문제 접근 : 공용, 유료, 일부공개, 광고로 구분
  study_program study_program_enum NOT NULL DEFAULT 'tbc',    -- 학습 문제 프로그램 : 기초 발음, 기초 단어, 기초 900문장, 토픽 읽기, 토픽 듣기, 토픽 쓰기, 추후 확정으로 구분
  study_title varchar(80),                                    -- 학습 문제 제목 : 학습 문제들을 모아놓은 
  study_subtitle varchar(120),                                -- 학습 문제 부제목 : 
  study_description text,                                     -- 학습 문제 설명 : 
  study_created_at timestamptz NOT NULL DEFAULT (now()),
  study_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.4.2 study_task : 학습 문제 세부 정보(study - study_task // 1:N 맵핑, study_task - study_task_* // 1:N 맵핑)
CREATE TABLE study_task (
  study_task_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 학습 문제 id : 학습 문제 DB 고유 번호(PK)
  study_id int NOT NULL,                                           -- 학습 id : 소속 학습 세트 id(FK)
  updated_by_user_id bigint NOT NULL,                              -- 문제 업로드 id : 문제를 생성/수정한 관리자 id(FK)
  study_task_kind study_task_kind_enum NOT NULL,                   -- 문제 종류 : choice(객관식), typing(쓰기), voice(말하기)
  study_task_seq int NOT NULL DEFAULT 1,                           -- 문제 순서 : 학습 세트 내 문제 표시 순서
  study_task_created_at timestamptz NOT NULL DEFAULT (now()),      -- 문제 생성 시간 : 문제 등록 시간
  study_task_updated_at timestamptz NOT NULL DEFAULT (now())       -- 문제 수정 시간 : 문제 정보 수정 시간
);

-- 2.4.3 study_task_choice : 학습 문제 [객관식 4지 선다]
CREATE TABLE study_task_choice (
  study_task_id int PRIMARY KEY,            -- 학습 문제 id : 학습 문제 DB 고유 번호(PK, FK)
  study_task_choice_question text NOT NULL, -- 문제 질문 : 객관식 문제 질문 텍스트
  study_task_choice_1 text NOT NULL,        -- 선택지 1 : 첫 번째 선택지
  study_task_choice_2 text NOT NULL,        -- 선택지 2 : 두 번째 선택지
  study_task_choice_3 text NOT NULL,        -- 선택지 3 : 세 번째 선택지
  study_task_choice_4 text NOT NULL,        -- 선택지 4 : 네 번째 선택지
  study_task_choice_answer int NOT NULL,    -- 정답 번호 : 1-4 중 정답 선택지 번호
  study_task_choice_audio_url text,         -- 오디오 URL : 듣기 문제용 음성 파일 URL (선택)
  study_task_choice_image_url text          -- 이미지 URL : 문제용 이미지 파일 URL (선택)
);

-- 2.4.4 study_task_typing : 학습 문제 [쓰기/타이핑]
CREATE TABLE study_task_typing (
  study_task_id int PRIMARY KEY,           -- 학습 문제 id : 학습 문제 DB 고유 번호(PK, FK)
  study_task_typing_question text,         -- 문제 질문 : 쓰기 문제 질문 텍스트
  study_task_typing_answer text,           -- 정답 : 사용자가 입력해야 할 정답 텍스트
  study_task_typing_image_url text         -- 이미지 URL : 문제용 이미지 파일 URL (선택)
);

-- 2.4.5 study_task_voice : 학습 문제 [발음/말하기]
CREATE TABLE study_task_voice (
  study_task_id int PRIMARY KEY,           -- 학습 문제 id : 학습 문제 DB 고유 번호(PK, FK)
  study_task_voice_question text,          -- 문제 질문 : 발음 문제 질문 텍스트
  study_task_voice_answer text,            -- 정답 : 사용자가 발음해야 할 정답 텍스트
  study_task_voice_audio_url text,         -- 오디오 URL : 발음 예시 음성 파일 URL (선택)
  study_task_voice_image_url text          -- 이미지 URL : 문제용 이미지 파일 URL (선택)
);

-- 2.4.6 study_task_explain : 학습 문제 해설 (다국어 지원)
CREATE TABLE study_task_explain (
  study_task_id int NOT NULL,                                 -- 학습 문제 id : 학습 문제 DB 고유 번호(FK)
  explain_lang user_set_language_enum NOT NULL DEFAULT 'ko',  -- 해설 언어 : ko(한국어), en(영어)
  explain_title varchar(120),                                 -- 해설 제목 : 해설 제목 (선택)
  explain_text text,                                          -- 해설 내용 : 문제 해설 텍스트
  explain_media_url text,                                     -- 미디어 URL : 해설 관련 미디어 URL (선택)
  explain_created_at timestamptz NOT NULL DEFAULT (now()),    -- 해설 생성 시간 : 해설 등록 시간
  explain_updated_at timestamptz NOT NULL DEFAULT (now())     -- 해설 수정 시간 : 해설 정보 수정 시간
);

-- 2.4.7 study_task_status : 학습 상태(사용자별 문제 풀이 상태)
CREATE TABLE study_task_status (
  study_task_id INT NOT NULL,                                   -- 학습 문제 id : 학습 문제 DB 고유 번호(FK)
  user_id BIGINT NOT NULL,                                      -- 사용자 id : 사용자 DB 고유 번호(FK)
  study_task_status_try_count INT NOT NULL DEFAULT 0,           -- 시도 횟수 : 해당 문제 풀이 시도 횟수
  study_task_status_is_solved BOOLEAN NOT NULL DEFAULT false,   -- 풀이 여부 : true(정답), false(미풀이/오답)
  study_task_status_last_attempt_at TIMESTAMPTZ DEFAULT (now()) -- 마지막 시도 시간 : 최근 풀이 시도 시간
);

-- 2.4.8 study_task_log : 학습 문제 풀이 기록(이력, 횟수, 정답여부)
CREATE TABLE study_task_log (
  study_task_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 학습 기록 id : 학습 기록 DB 고유 번호(PK)
  study_task_id INT NOT NULL,                                            -- 학습 문제 id : 학습 문제 DB 고유 번호(FK)
  user_id BIGINT NOT NULL,                                               -- 사용자 id : 사용자 DB 고유 번호(FK)
  login_id BIGINT NOT NULL,                                              -- 로그인 id : 활동 시 로그인 세션(FK)
  study_task_action_log study_task_log_action_enum NOT NULL,             -- 활동 종류 : view, start, answer, finish, explain, status
  study_task_try_no_log INT NOT NULL DEFAULT 1,                          -- 시도 번호 : 해당 문제 N번째 시도
  study_task_is_correct_log BOOLEAN,                                     -- 정답 여부 : true(정답), false(오답), null(미제출)
  study_task_answer_log JSONB,                                           -- 사용자 답변 : 사용자가 제출한 답변 (JSON)
  study_task_created_at_log TIMESTAMPTZ NOT NULL DEFAULT (now()),        -- 기록 생성 시간 : 풀이 기록 생성 시간
  study_task_ip_log INET,                                                -- 접속 IP : 풀이 시 클라이언트 IP
  study_task_device_log login_device_enum,                               -- 접속 기기 : mobile, tablet, desktop, other
  study_task_user_agent_log JSONB                                        -- User-Agent : 접속 브라우저/앱 정보 (JSON)
);

-- 2.4.9 admin_study_log : 관리자 활동 기록 [학습]
CREATE TABLE admin_study_log (
  admin_study_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 관리자 학습 기록 id : 관리자 학습 기록 DB 고유 번호(PK)
  admin_user_id bigint NOT NULL,                                          -- 관리자 id : 학습 작업을 수행한 관리자 id(FK)
  admin_pick_study_id int NOT NULL,                                       -- 작업 학습 id : 관리자가 작업한 학습 세트 id(FK)
  admin_pick_task_id int,                                                 -- 작업 문제 id : 관리자가 작업한 문제 id(FK, 선택)
  admin_study_action admin_action_enum NOT NULL,                          -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_study_before jsonb,                                               -- 작업 전 학습 정보 : 수정 전 학습 정보 (JSON)
  admin_study_after jsonb,                                                -- 작업 후 학습 정보 : 수정 후 학습 정보 (JSON)
  admin_study_created_at timestamptz NOT NULL DEFAULT (now()),            -- 학습 작업 생성 시간 : 관리자 작업 기록 생성 시간
  admin_study_updated_at timestamptz NOT NULL DEFAULT (now())             -- 학습 작업 수정 시간 : 관리자 작업 기록 수정 시간
);

-- 2.5 lesson table : 수업 테이블

-- 2.5.1 lesson : 수업 구성 [video + study // N:M 맵핑]
CREATE TABLE lesson (
  lesson_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,      -- 수업 id : 수업 DB 고유 번호(PK)
  updated_by_user_id bigint NOT NULL,                              -- 수업 업로드 id : 수업을 생성/수정한 관리자 id(FK)
  lesson_idx varchar(100) UNIQUE NOT NULL,                         -- 수업 인덱스 : 외부 공개용 인덱스
  lesson_state lesson_state_enum NOT NULL DEFAULT 'ready',         -- 수업 상태 : ready(준비), open(공개), close(비공개)
  lesson_access lesson_access_enum NOT NULL DEFAULT 'public',      -- 수업 접근 : public(공개), paid(유료), private(비공개), promote(홍보)
  lesson_title varchar(120) NOT NULL,                              -- 수업 제목 : 수업 이름
  lesson_subtitle varchar(200),                                    -- 수업 부제목 : 수업 부가 설명 (선택)
  lesson_description text,                                         -- 수업 설명 : 수업 상세 설명
  lesson_created_at timestamptz NOT NULL DEFAULT (now()),          -- 수업 생성 시간 : 수업 등록 시간
  lesson_updated_at timestamptz NOT NULL DEFAULT (now())           -- 수업 수정 시간 : 수업 정보 수정 시간
);

-- 2.5.2 lesson_item : 수업 순서 (수업 내 영상/학습 배치)
CREATE TABLE lesson_item (
  lesson_id int NOT NULL,                                          -- 수업 id : 수업 DB 고유 번호(FK)
  lesson_item_seq int NOT NULL DEFAULT 1,                          -- 아이템 순서 : 수업 내 표시 순서
  lesson_item_kind lesson_item_kind_enum NOT NULL DEFAULT 'video', -- 아이템 종류 : video(영상), task(학습 문제)
  video_id int,                                                    -- 영상 id : 연결된 영상 id(FK, video 타입일 때)
  study_task_id int                                                -- 학습 문제 id : 연결된 학습 문제 id(FK, task 타입일 때)
);

-- 2.5.3 lesson_progress : 수업 진도 (사용자별 수업 진행 현황)
CREATE TABLE lesson_progress (
  lesson_id int NOT NULL,                           -- 수업 id : 수업 DB 고유 번호(FK)
  user_id bigint NOT NULL,                          -- 사용자 id : 사용자 DB 고유 번호(FK)
  lesson_progress_percent int NOT NULL DEFAULT 0,   -- 수업 진도율 : 0-100% 수업 진행률
  lesson_progress_last_item_seq int,                -- 마지막 아이템 순서 : 최근 학습한 아이템 순서
  lesson_progress_last_progress_at timestamptz      -- 마지막 진행 시간 : 최근 학습 활동 시간
);

-- 2.5.4 admin_lesson_log : 관리자 활동 기록 [수업]
CREATE TABLE admin_lesson_log (
  admin_lesson_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 관리자 수업 기록 id : 관리자 수업 기록 DB 고유 번호(PK)
  admin_user_id bigint NOT NULL,                                           -- 관리자 id : 수업 작업을 수행한 관리자 id(FK)
  admin_pick_lesson_id int NOT NULL,                                       -- 작업 수업 id : 관리자가 작업한 수업 id(FK)
  admin_pick_item_seq int,                                                 -- 작업 아이템 순서 : 수업 아이템 순서 (선택)
  admin_pick_video_id int,                                                 -- 작업 영상 id : 관리자가 작업한 영상 id(FK, 선택)
  admin_pick_task_id int,                                                  -- 작업 학습 문제 id : 관리자가 작업한 학습 문제 id(FK, 선택)
  admin_lesson_action admin_action_enum NOT NULL,                          -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_lesson_before jsonb,                                               -- 작업 전 수업 정보 : 수정 전 수업 정보 (JSON)
  admin_lesson_after jsonb,                                                -- 작업 후 수업 정보 : 수정 후 수업 정보 (JSON)
  admin_lesson_created_at timestamptz NOT NULL DEFAULT (now()),            -- 수업 작업 생성 시간 : 관리자 작업 기록 생성 시간
  admin_lesson_updated_at timestamptz NOT NULL DEFAULT (now())             -- 수업 작업 수정 시간 : 관리자 작업 기록 수정 시간
);

-- 2.6 course table : 수강권 테이블 (결제 후 콘텐츠 접근 관리)

-- 2.6.1 course : 코스(수강권) 기본 정보
CREATE TABLE course (
  course_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 코스 id : 코스 DB 고유 번호(PK)
  updated_by_user_id BIGINT NOT NULL,                          -- 코스 업로드 id : 코스를 생성/수정한 관리자 id(FK)
  course_idx VARCHAR(100) UNIQUE NOT NULL,                     -- 코스 인덱스 : 비즈니스 식별 코드 (예: COURSE-001)
  course_title VARCHAR(150) NOT NULL,                          -- 코스 제목 : 수강권 상품명
  course_subtitle VARCHAR(250),                                -- 코스 부제목 : 수강권 부제목 (선택)
  course_description TEXT,                                     -- 코스 설명 : 수강권 상세 설명
  course_type course_type_enum NOT NULL DEFAULT 'video',       -- 코스 타입 : video(영상), study(학습), live(실시간), package(묶음)
  course_state course_state_enum NOT NULL DEFAULT 'inactive',  -- 코스 상태 : active(판매중), inactive(비활성), deleted(삭제됨)
  course_price INT NOT NULL DEFAULT 0,                         -- 코스 가격 : 원화 기준 가격 (0이면 무료)
  course_discount_price INT,                                   -- 코스 할인가 : 할인 적용 시 가격 (선택)
  course_currency VARCHAR(3) NOT NULL DEFAULT 'KRW',           -- 코스 통화 : KRW, USD 등 통화 코드
  course_valid_days INT,                                       -- 코스 유효 기간 : 수강 가능 일수 (NULL이면 무제한)
  course_thumbnail_url TEXT,                                   -- 코스 썸네일 : 상품 이미지 URL
  course_preview_url TEXT,                                     -- 코스 미리보기 : 미리보기 영상 URL
  course_created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),        -- 코스 생성 시간 : 코스 등록 시간
  course_updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()         -- 코스 수정 시간 : 코스 정보 수정 시간
);

-- 2.6.2 course_lesson : 코스-레슨 매핑 (하나의 코스에 여러 레슨 포함 / N:M 관계)
CREATE TABLE course_lesson (
  course_id INT NOT NULL,                                      -- 코스 id : 코스 DB 고유 번호(FK)
  lesson_id INT NOT NULL,                                      -- 수업 id : 수업 DB 고유 번호(FK)
  course_lesson_seq INT NOT NULL DEFAULT 1,                    -- 코스 내 레슨 순서 : 수업 표시 순서
  course_lesson_created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), -- 매핑 생성 시간 : 코스-레슨 연결 시간
  PRIMARY KEY (course_id, lesson_id)                           -- 복합 PK : 동일 조합 중복 방지
);

-- 2.6.3 user_course : 사용자 수강권 (구매/부여된 코스)
CREATE TABLE user_course (
  user_course_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 사용자 수강권 id : 사용자 수강권 DB 고유 번호(PK)
  user_id BIGINT NOT NULL,                                             -- 사용자 id : 수강권 보유 사용자(FK)
  course_id INT NOT NULL,                                              -- 코스 id : 구매/부여된 코스(FK)
  user_course_active BOOLEAN NOT NULL DEFAULT true,                    -- 수강 활성 여부 : true(수강 가능), false(중지/만료)
  user_course_start_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),             -- 수강 시작일 : 수강권 시작 시간
  user_course_expire_at TIMESTAMPTZ,                                   -- 수강 만료일 : 수강권 만료 시간 (NULL이면 무제한)
  user_course_progress_percent INT NOT NULL DEFAULT 0,                 -- 전체 진도율 : 0-100% 코스 전체 진행률
  user_course_last_lesson_id INT,                                      -- 마지막 학습 수업 : 최근 학습한 수업 id(FK)
  user_course_last_progress_at TIMESTAMPTZ,                            -- 마지막 학습 시간 : 최근 학습 활동 시간
  user_course_granted_by_user_id BIGINT,                               -- 수강권 부여자 : 수동 부여 시 관리자 id(FK, 선택)
  user_course_pay_id BIGINT,                                           -- 결제 id : 결제 시스템 연동용 id (추후 pay 테이블 연동)
  user_course_created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),           -- 수강권 생성 시간 : 수강권 발급/구매 시간
  user_course_updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()            -- 수강권 수정 시간 : 수강권 정보 수정 시간
);

-- 2.6.4 admin_course_log : 관리자 활동 기록 [코스]
CREATE TABLE admin_course_log (
  admin_course_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- 관리자 코스 기록 id : 관리자 코스 기록 DB 고유 번호(PK)
  admin_user_id BIGINT NOT NULL,                                           -- 관리자 id : 코스 작업을 수행한 관리자 id(FK)
  admin_pick_course_id INT,                                                -- 작업 코스 id : 관리자가 작업한 코스 id(FK, 선택)
  admin_pick_user_course_id BIGINT,                                        -- 작업 사용자 수강권 id : 관리자가 작업한 사용자 수강권 id(FK, 선택)
  admin_course_action admin_action_enum NOT NULL,                          -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_course_before JSONB,                                               -- 작업 전 코스 정보 : 수정 전 코스 정보 (JSON)
  admin_course_after JSONB,                                                -- 작업 후 코스 정보 : 수정 후 코스 정보 (JSON)
  admin_course_created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),              -- 코스 작업 생성 시간 : 관리자 작업 기록 생성 시간
  admin_course_updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()               -- 코스 작업 수정 시간 : 관리자 작업 기록 수정 시간
);

-- 3. Foreign Keys
ALTER TABLE users_log ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE users_setting ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE admin_users_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_users_log ADD FOREIGN KEY (admin_pick_user_id) REFERENCES users (user_id);
ALTER TABLE user_export_data ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE login ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE login_log ADD FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE SET NULL;
ALTER TABLE redis_session ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE redis_session ADD FOREIGN KEY (login_id) REFERENCES login (login_id);
ALTER TABLE redis_refresh ADD FOREIGN KEY (session_id) REFERENCES login (login_session_id);
ALTER TABLE redis_refresh ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE redis_user_sessions ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE redis_user_sessions ADD FOREIGN KEY (session_id) REFERENCES login (login_session_id);
ALTER TABLE redis_session ADD FOREIGN KEY (session_id) REFERENCES login (login_session_id);
ALTER TABLE video ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE video_log ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE video_log ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE video_tag_map ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE video_tag_map ADD FOREIGN KEY (video_tag_id) REFERENCES video_tag (video_tag_id);
ALTER TABLE video_stat_daily ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE admin_video_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_video_log ADD FOREIGN KEY (admin_pick_video_id) REFERENCES video (video_id);
ALTER TABLE admin_video_log ADD FOREIGN KEY (admin_pick_video_tag_id) REFERENCES video_tag (video_tag_id);
ALTER TABLE study ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE study ADD COLUMN IF NOT EXISTS study_access study_access_enum NOT NULL DEFAULT 'public';
ALTER TABLE study_task ADD FOREIGN KEY (study_id) REFERENCES study (study_id);
ALTER TABLE study_task ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE study_task_choice ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_task_typing ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_task_voice ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_task_explain ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_task_status ADD CONSTRAINT fk_study_task_status_task FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id) ON DELETE CASCADE;
ALTER TABLE study_task_status ADD FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE CASCADE;
ALTER TABLE study_task_log ADD CONSTRAINT fk_study_task_log_task FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id) ON DELETE CASCADE;
ALTER TABLE study_task_log ADD FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE CASCADE;
ALTER TABLE admin_study_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_study_log ADD FOREIGN KEY (admin_pick_study_id) REFERENCES study (study_id);
ALTER TABLE admin_study_log ADD FOREIGN KEY (admin_pick_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE lesson ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE lesson ADD COLUMN IF NOT EXISTS lesson_state lesson_state_enum NOT NULL DEFAULT 'ready';
ALTER TABLE lesson ADD COLUMN IF NOT EXISTS lesson_access lesson_access_enum NOT NULL DEFAULT 'public';
ALTER TABLE lesson_item ADD FOREIGN KEY (lesson_id) REFERENCES lesson (lesson_id);
ALTER TABLE lesson_item ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE lesson_item ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE lesson_progress ADD FOREIGN KEY (lesson_id) REFERENCES lesson (lesson_id);
ALTER TABLE lesson_progress ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_pick_lesson_id) REFERENCES lesson (lesson_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_pick_video_id) REFERENCES video (video_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_pick_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE course ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE course_lesson ADD FOREIGN KEY (course_id) REFERENCES course (course_id) ON DELETE CASCADE;
ALTER TABLE course_lesson ADD FOREIGN KEY (lesson_id) REFERENCES lesson (lesson_id) ON DELETE CASCADE;
ALTER TABLE user_course ADD FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE CASCADE;
ALTER TABLE user_course ADD FOREIGN KEY (course_id) REFERENCES course (course_id) ON DELETE CASCADE;
ALTER TABLE user_course ADD FOREIGN KEY (user_course_last_lesson_id) REFERENCES lesson (lesson_id);
ALTER TABLE user_course ADD FOREIGN KEY (user_course_granted_by_user_id) REFERENCES users (user_id);
ALTER TABLE admin_course_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_course_log ADD FOREIGN KEY (admin_pick_course_id) REFERENCES course (course_id);
ALTER TABLE admin_course_log ADD FOREIGN KEY (admin_pick_user_course_id) REFERENCES user_course (user_course_id);

-- 4. Indexes
CREATE INDEX index_admin_user_id ON admin_users_log (admin_user_id);
CREATE INDEX index_target_user_id ON admin_users_log (admin_pick_user_id);
CREATE INDEX index_export_data_user_id ON user_export_data (user_id);
CREATE INDEX index_login_user_id ON login (user_id);
CREATE INDEX index_login_state ON login (login_state);
CREATE INDEX index_login_begin_at ON login (login_begin_at);
CREATE INDEX index_login_expire_at ON login (login_expire_at);
CREATE INDEX index_login_active_by_user ON login (user_id, login_state);
CREATE INDEX index_login_user_id_login_begin_at_log ON login_log (user_id, login_begin_at_log);
CREATE INDEX index_login_event_log ON login_log (login_event_log);
CREATE INDEX index_redis_refresh_session_id ON redis_refresh (session_id);
CREATE INDEX index_redis_refresh_user_id ON redis_refresh (user_id);
CREATE INDEX index_redis_user_sessions_user_id ON redis_user_sessions (user_id);
CREATE UNIQUE INDEX unique_redis_user_sessions_session_id ON redis_user_sessions (session_id);
CREATE INDEX index_video_state_video_access ON video (video_state, video_access);
CREATE INDEX index_video_created_at ON video (video_created_at);
CREATE UNIQUE INDEX unique_video_id_user_id ON video_log (video_id, user_id);
CREATE INDEX index_user_id_video_last_watched_at_log ON video_log (user_id, video_last_watched_at_log);
CREATE INDEX index_video_id_video_last_watched_at_log ON video_log (video_id, video_last_watched_at_log);
CREATE UNIQUE INDEX unique_video_id_video_tag_id ON video_tag_map (video_id, video_tag_id);
CREATE UNIQUE INDEX unique_video_stat_date_video_id ON video_stat_daily (video_stat_date, video_id);
CREATE INDEX index_admin_user_id_video ON admin_video_log (admin_user_id);
CREATE INDEX index_admin_pick_video_id ON admin_video_log (admin_pick_video_id);
CREATE INDEX IF NOT EXISTS index_study_state_access ON study (study_state, study_access);
CREATE UNIQUE INDEX unique_study_id_study_task_seq ON study_task (study_id, study_task_seq);
CREATE INDEX index_study_task_kind ON study_task (study_task_kind);
CREATE UNIQUE INDEX unique_study_task_explain_lang ON study_task_explain (study_task_id, explain_lang);
CREATE INDEX index_explain_lang ON study_task_explain (explain_lang);
CREATE INDEX idx_study_task_log_user_task ON study_task_log (user_id, study_task_id);
CREATE INDEX index_admin_study_actor ON admin_study_log (admin_user_id);
CREATE INDEX index_admin_study_target ON admin_study_log (admin_pick_study_id);
CREATE INDEX index_admin_study_task_target ON admin_study_log (admin_pick_task_id);
CREATE INDEX IF NOT EXISTS index_lesson_state_access ON lesson (lesson_state, lesson_access);
CREATE UNIQUE INDEX unique_lesson_id_lesson_item_seq ON lesson_item (lesson_id, lesson_item_seq);
CREATE INDEX index_video_id ON lesson_item (video_id);
CREATE INDEX index_study_task_id ON lesson_item (study_task_id);
CREATE UNIQUE INDEX unique_lesson_id_user_id ON lesson_progress (lesson_id, user_id);
CREATE INDEX index_user_id ON lesson_progress (user_id);
CREATE INDEX index_admin_lesson_actor ON admin_lesson_log (admin_user_id);
CREATE INDEX index_admin_lesson_target ON admin_lesson_log (admin_pick_lesson_id);
CREATE INDEX index_admin_lesson_item_seq ON admin_lesson_log (admin_pick_item_seq);
CREATE INDEX index_admin_lesson_video_target ON admin_lesson_log (admin_pick_video_id);
CREATE INDEX index_admin_lesson_task_target ON admin_lesson_log (admin_pick_task_id);
CREATE INDEX idx_course_state ON course (course_state);
CREATE INDEX idx_course_type ON course (course_type);
CREATE INDEX idx_course_state_type ON course (course_state, course_type);
CREATE INDEX idx_course_lesson_course_id ON course_lesson (course_id);
CREATE INDEX idx_course_lesson_lesson_id ON course_lesson (lesson_id);
CREATE UNIQUE INDEX unique_course_lesson_seq ON course_lesson (course_id, course_lesson_seq);
CREATE INDEX idx_user_course_user_id ON user_course (user_id);
CREATE INDEX idx_user_course_course_id ON user_course (course_id);
CREATE INDEX idx_user_course_active ON user_course (user_course_active);
CREATE INDEX idx_user_course_expire ON user_course (user_course_expire_at);
CREATE UNIQUE INDEX unique_user_course ON user_course (user_id, course_id);
CREATE INDEX idx_admin_course_log_admin ON admin_course_log (admin_user_id);
CREATE INDEX idx_admin_course_log_course ON admin_course_log (admin_pick_course_id);
CREATE INDEX idx_admin_course_log_user_course ON admin_course_log (admin_pick_user_course_id);
```