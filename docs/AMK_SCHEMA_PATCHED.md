```sql
-- MVP 통합 마이그레이션 (2026-01-29)
-- 모든 이전 마이그레이션을 하나로 통합

-- 1. ENUM Types
CREATE TYPE admin_action_enum AS ENUM ('create', 'update', 'banned', 'reorder', 'publish', 'unpublish');
CREATE TYPE user_auth_enum AS ENUM ('HYMN', 'admin', 'manager', 'learner');
CREATE TYPE user_language_enum AS ENUM ('ko', 'en');
CREATE TYPE user_gender_enum AS ENUM ('none', 'male', 'female', 'other');
CREATE TYPE user_action_log_enum AS ENUM ('signup', 'find_id', 'reset_pw', 'update');
CREATE TYPE user_set_language_enum AS ENUM ('ko', 'en');
CREATE TYPE login_device_enum AS ENUM ('mobile', 'tablet', 'desktop', 'other');
CREATE TYPE login_method_enum AS ENUM ('email', 'google', 'apple');
CREATE TYPE login_state_enum AS ENUM ('active', 'revoked', 'expired', 'logged_out', 'compromised');
CREATE TYPE login_event_enum AS ENUM ('login', 'logout', 'refresh', 'rotate', 'fail', 'reuse_detected');
CREATE TYPE video_state_enum AS ENUM ('ready', 'open', 'close');
CREATE TYPE video_access_enum AS ENUM ('public', 'paid', 'private', 'promote');
CREATE TYPE study_state_enum AS ENUM ('ready', 'open', 'close');
CREATE TYPE study_access_enum AS ENUM ('public', 'paid', 'private', 'promote');
CREATE TYPE study_program_enum AS ENUM ('basic_pronunciation', 'basic_word', 'basic_900', 'topik_read', 'topik_listen', 'topik_write', 'tbc');
CREATE TYPE study_task_kind_enum AS ENUM ('choice', 'typing', 'voice');
CREATE TYPE study_task_log_action_enum AS ENUM ('view', 'start', 'answer', 'finish', 'explain', 'status');
CREATE TYPE lesson_item_kind_enum AS ENUM ('video', 'task');
CREATE TYPE lesson_state_enum AS ENUM ('ready', 'open', 'close');
CREATE TYPE lesson_access_enum AS ENUM ('public', 'paid', 'private', 'promote');

-- 2. Tables

-- 2.0 admin_action_log : 관리자 활동 기록 [접근, 조회]
CREATE TABLE admin_action_log (
  log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_id BIGINT NOT NULL,
  action_type VARCHAR(50) NOT NULL,
  target_table VARCHAR(50),
  target_id BIGINT,
  details JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 2.1 user table : 사용자 테이블

-- 2.1.1 users : 사용자 기본 정보 
CREATE TABLE users (
  user_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 사용자 id : 사용자별 DB 고유 번호(PK)
  user_auth user_auth_enum NOT NULL DEFAULT 'learner',          -- 사용자 권한 : 개발자 - 관리자 - 매니저 - 학습자 순으로 구성
  user_state boolean NOT NULL DEFAULT true,                     -- 사용자 상태 : 서비스를 이용할 수 있는지 없는지 여부 판단
  user_email varchar(255) UNIQUE NOT NULL,                      -- 사용자 이메일 : 사용자 로그인 시 사용하는 아이디(변경불가)
  user_password text NOT NULL,                                  -- 사용자 비빌번호 : 암호화 후 DB 저장, 복호화를 통해 사용
  user_name varchar(100) NOT NULL,                              -- 사용자 이름 : 모든 언어로 저장 가능
  user_nickname varchar(100) NOT NULL,                          -- 사용자 별명 : 모든 언어로 저장 가능
  user_language user_language_enum NOT NULL DEFAULT 'ko',       -- 사용자 언어 : 서비스에서 사용할 언어 선택
  user_country varchar(50) NOT NULL,                            -- 사용자 국가 : 사용자가 속해 있는 국가
  user_birthday date NOT NULL,                                  -- 사용자 생년월일 : 사용자 기본 정보
  user_gender user_gender_enum NOT NULL DEFAULT 'none',         -- 사용자 성별 : 사용자 기본 정보
  user_check_email boolean NOT NULL DEFAULT false,              -- 사용자 이메일 확인 : 사용하는 이메일 점검 및 보안, 복구 로직을 위한 상태 판단
  user_terms_service boolean NOT NULL DEFAULT false,            -- 사용자 이용약관 : 서비스 이용 시 사용자 이용약관 동의 여부
  user_terms_personal boolean NOT NULL DEFAULT false,           -- 사용자 개인정보 약관 : 서비스 이용 시 사용자 개인정보 약관 동의 여부 
  user_created_at timestamptz NOT NULL DEFAULT (now()),         -- 사용자 가입 일시 : 가입 후 자동으로 DB에 생성
  user_quit_at timestamptz                                      -- 사용자 탈퇴 일시 : 탈퇴 후 user_state : false로 전환, 추후 DB에서 삭제
);

-- 2.1.2 users_log : 사용자 기본 정보 활동 기록
CREATE TABLE users_log (
  user_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 사용자 기록 id : 사용자들의 활동 기록 DB 고유 번호(PK)
  updated_by_user_id bigint,                                        -- 사용자를 수정한 사용자 id : 자신이 직접 활동(본인 id), 관리자가 활동(관리자 id)
  user_action_log user_action_log_enum NOT NULL,                    -- 사용자 활동 기록  : 회원가입, id 찾기, pw 재설정, 사용자 정보 업데이트
  user_action_success boolean NOT NULL DEFAULT true,                -- 사용자 활동 성공 여부 : user_action_log가 적용(true), user_action_log가 미적용(false)
  user_id bigint NOT NULL,                                          -- 사용자 id : 사용자별 DB 고유 번호(FK)
  user_auth_log user_auth_enum,                                     -- 사용자 권한 기록 : 사용자 권한 변동 기록(관리자 작업)
  user_state_log boolean,                                           -- 사용자 상태 기록 : 서비스 이용 여부 기록(관리자 작업)
  user_email_log varchar(255),                                      -- 사용자 이메일 기록 : 사용자가 등록한 이메일
  user_certify_log timestamptz,                                     -- 사용자 이메일 검증 기록 : 사용자가 실제 사용하는 이메일 검증 확인 시간 기록
  user_password_log boolean DEFAULT false,                          -- 사용자 비밀번호 변경 기록 : 변경(ture), 미변경(false)
  user_nickname_log varchar(100),                                   -- 사용자 별명 변경 기록 : 별명 변경 기록
  user_language_log user_language_enum,                             -- 사용자 언어 변경 기록 : 언어 변경 기록
  user_country_log varchar(50),                                     -- 사용자 국가 변경 기록 : 국가 변경 기록
  user_birthday_log date,                                           -- 사용자 생년월일 변경 기록 : 생년월일 변경 기록
  user_gender_log user_gender_enum,                                 -- 사용자 성별 변경 기록 : 성별 변경 기록
  user_terms_service_log boolean,                                   -- 사용자 서비스 이용약관 동의 기록 : 동의(true), 미동의(false)
  user_terms_personal_log boolean,                                  -- 사용자 개인 정보 이용약관 동의 기록 : 동의(true), 미동의(false)
  user_log_created_at timestamptz,                                  -- 사용자 활동 기록 생성 시간 : 활동 기록 생성 시간
  user_log_quit_at timestamptz,                                     -- 사용자 탈퇴 기록 시간 : 탈퇴 기록 시간
  user_log_updated_at timestamptz NOT NULL DEFAULT (now())          -- 사용자 활동 기록 수정 시간 : 활동 기록 수정 시간
);

-- 2.1.3 users_setting : 사용자 설정
CREATE TABLE users_setting (
  user_id bigint PRIMARY KEY,                                      -- 사용자 설정 id : 사용자 설정 DB 고유 번호(PK)
  user_set_language user_set_language_enum NOT NULL DEFAULT 'ko',  -- 사용자 설정 언어 : UI에서 사용할 언어(현재 ko, en만 있음 추후 확장 예정)
  user_set_timezone varchar(64),                                   -- 사용자 설정 시간대 : 다국어 사용자를 위한 시간 설정
  user_set_note_email boolean NOT NULL DEFAULT false,              -- 사용자 이메일 수신 여부 : 사용자가 사용하는 email 수신 여부
  user_set_note_push boolean NOT NULL DEFAULT false,               -- 사용자 알림 여부 : 사용자에게 Web or App으로 알림 수신 여부
  user_set_created_at timestamptz NOT NULL DEFAULT (now()),        -- 사용자 설정 생성 시간 : 처음으로 사용자가 설정을 설정한 시간
  user_set_updated_at timestamptz NOT NULL DEFAULT (now())         -- 사용자 설정 수정 시간 : 사용자가 설정을 수정한 시간
);

-- 2.1.4 admin_users_log : 관리자 활동 기록 [사용자]
CREATE TABLE admin_users_log (
  admin_user_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 관리자 활동 기록 [사용자] id : 관리자 활동 기록 [사용자] DB 고유 번호(PK)
  admin_user_id bigint NOT NULL,                                          -- 관리자 id : 사용자 관련 작업을 진행한 관리자 id
  admin_pick_user_id bigint NOT NULL,                                     -- 관리자 작업 사용자 id : 관리자가 작업한 사용자의 id
  admin_user_action admin_action_enum NOT NULL,                           -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_user_before jsonb,                                                -- 관리자 작업전 사용자 내역 : 관리자가 작업한 사용자의 이전 정보 
  admin_user_after jsonb,                                                 -- 관리자 작업후 사용자 내역 : 관리자가 작업후 사용자의 수정 정보
  admin_user_created_at timestamptz NOT NULL DEFAULT (now()),             -- 관리자 사용자 작업 생성 시간 : 관리자가 사용자 작업을 생성한 시간
  admin_user_updated_at timestamptz NOT NULL DEFAULT (now())              -- 관리자 사용자 작업 수정 시간 : 관리자가 사용자 작업을 수정한 시간
);

-- 2.1.4 user_export_data : 사용자 요청 데이터(학습 이력, 수료증 등)
CREATE TABLE user_export_data (
  user_data_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,       -- 사용자 요청 데이터 id : 사용자 요청 데이터 DB 고유 번호(PK)
  user_id bigint NOT NULL,                                                -- 사용자 id : 사용자별 DB 고유 번호(FK)
  user_data_status boolean NOT NULL DEFAULT true,                         -- 
  user_data_course jsonb,
  user_data_lesson jsonb,
--user_data_study jsonb, // 추후 추가
--user_data_video jsonb, // 추후 추가
  user_data_created_at timestamptz,
  user_data_expires_at timestamptz,
  user_data_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.2 login table : 로그인 테이블

-- 2.1.1 login : 로그인 기본 정보
CREATE TABLE login (
  login_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id bigint NOT NULL,
  login_country char(2) NOT NULL,
  login_asn bigint NOT NULL,
  login_org varchar(200) NOT NULL,
  login_ip inet NOT NULL,
  login_os varchar(100),
  login_browser varchar(100),
  login_device login_device_enum NOT NULL DEFAULT 'other',
  login_method login_method_enum NOT NULL DEFAULT 'email',
  login_session_id uuid UNIQUE NOT NULL,
  login_refresh_hash varchar(128) UNIQUE,
  login_user_agent text,
  login_begin_at timestamptz NOT NULL DEFAULT (now()),
  login_active_at timestamptz,
  login_expire_at timestamptz,
  login_state login_state_enum NOT NULL DEFAULT 'active',
  login_revoked_reason text,
  login_created_at timestamptz NOT NULL DEFAULT (now()),
  login_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.1.1 login : 로그인 기본 정보 활동 기록
CREATE TABLE login_log (
  login_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id bigint,
  login_event_log login_event_enum,
  login_success_log boolean,
  login_access_log char(64),
  login_country_log char(2),
  login_asn_log bigint,
  login_org_log varchar(200),
  login_ip_log inet,
  login_os_log varchar(100),
  login_browser_log varchar(100),
  login_device_log login_device_enum,
  login_method_log login_method_enum,
  login_session_id_log uuid,
  login_refresh_hash_log varchar(128),
  login_user_agent_log text,
  login_begin_at_log timestamptz NOT NULL DEFAULT (now()),
  login_expire_at_log timestamptz,
  login_token_id_log varchar,
  login_fail_reason_log text,
  login_created_at_log timestamptz NOT NULL DEFAULT (now())
);

-- 2.1.2 Redis 테이블들
CREATE TABLE redis_session (
  redis_key varchar(128) PRIMARY KEY,
  session_id uuid UNIQUE NOT NULL,
  user_id bigint NOT NULL,
  login_id bigint NOT NULL,
  state login_state_enum NOT NULL DEFAULT 'active',
  issued_at timestamptz NOT NULL DEFAULT (now()),
  expire_at timestamptz NOT NULL,
  revoked_at timestamptz,
  ip inet,
  user_agent text,
  device login_device_enum,
  method login_method_enum,
  created_at timestamptz NOT NULL DEFAULT (now()),
  updated_at timestamptz NOT NULL DEFAULT (now())
);

CREATE TABLE redis_refresh (
  redis_key varchar(160) PRIMARY KEY,
  refresh_hash varchar(128) UNIQUE NOT NULL,
  session_id uuid NOT NULL,
  user_id bigint,
  issued_at timestamptz NOT NULL DEFAULT (now()),
  expire_at timestamptz NOT NULL,
  reused_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT (now()),
  updated_at timestamptz NOT NULL DEFAULT (now())
);

CREATE TABLE redis_user_sessions (
  redis_key varchar(128) PRIMARY KEY,
  user_id bigint NOT NULL,
  session_id uuid NOT NULL,
  added_at timestamptz NOT NULL DEFAULT (now()),
  expire_at timestamptz NOT NULL
);

-- 2.3 video table : 동영상 강의 테이블

-- 2.3.1 video : 동영상 강의 기본 정보(링크, 상태, 접근)
CREATE TABLE video (
  video_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 영상 id : 영상 DB 고유 번호
  updated_by_user_id bigint NOT NULL,                         -- 영상 업로드 id : 영상을 DB에 올린 사용자 id
  video_idx varchar(100) UNIQUE NOT NULL,                     -- 영상 인덱스 : 외부 공개용 인덱스
  video_state video_state_enum NOT NULL DEFAULT 'ready',      -- 영상 상태 : 영상 준비, 영상 공개, 영상 비공개로 구분
  video_access video_access_enum NOT NULL DEFAULT 'public',   -- 영상 접근 : 공용, 유료, 일부공개, 광고로 구분
  video_url_vimeo text NOT NULL,                              -- 영상 url : vimeo url
  video_thumbnail text,                                       -- 영상 썸네일 : vimeo url
  video_duration text,                                        -- 영상 길이 : 초단위로 입력
  video_created_at timestamptz NOT NULL DEFAULT (now()),      -- 영상 생성일 : 등록한 일시
  video_updated_at timestamptz NOT NULL DEFAULT (now())       -- 영상 수정일 : 수정한 일시
);

-- 2.3.2 video_log : 동영상 강의 시청 정보
CREATE TABLE video_log (
  video_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  video_id int NOT NULL,
  user_id bigint NOT NULL,
  video_progress_log int,
  video_completed_log boolean NOT NULL DEFAULT false,
  video_watch_count_log int NOT NULL DEFAULT 0,
  video_first_watched_at_log timestamptz,
  video_last_watched_at_log timestamptz,
  video_last_ip_log inet,
  video_last_device_log login_device_enum,
  video_last_user_agent_log jsonb
);

-- 2.3.2 video_tag : 동영상 강의 메타 정보
CREATE TABLE video_tag (
  video_tag_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,  -- 영상 태그 id : 영상 태그 DB 고유 번호
  video_tag_key varchar(30) UNIQUE NOT NULL,                      -- 영상 태그키 : 외부 공개용 인덱스
  video_tag_title varchar(50) NOT NULL,                           -- 영상 제목 : 제목(vimeo api::name에서 받아옴)
  video_tag_subtitle varchar(100),                                -- 영상 부제목 : 부제목(vimeo api::description에서 받아옴)
  video_tag_created_at timestamptz NOT NULL DEFAULT (now())       -- 영상 태그 생성일 : 등록한 일시
);

-- 2.3.3 video_tag_map : 동영상 강의 맵핑(video - video_tag / 1:1 맵핑)
CREATE TABLE video_tag_map (
  video_id int NOT NULL,
  video_tag_id int NOT NULL
);

-- 2.3.4 video_stat_daily : 동영상 강의 통계
CREATE TABLE video_stat_daily (
  video_stat_date date,
  video_id int NOT NULL,
  video_stat_views int NOT NULL DEFAULT 0,
  video_stat_completes int NOT NULL DEFAULT 0
);

-- 2.3.5 admin_video_log : 관리자 활동 기록 [동영상 강의]
CREATE TABLE admin_video_log (
  admin_video_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_user_id bigint NOT NULL,
  admin_pick_video_id int,
  admin_pick_video_tag_id int,
  admin_video_action admin_action_enum NOT NULL,  -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_video_before jsonb,
  admin_video_after jsonb,
  admin_video_created_at timestamptz NOT NULL DEFAULT (now()),
  admin_video_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.4 study table : 학습 테이블

-- 2.4.1 study : 학습 문제 기본 정보(상태, 접근, 지문)
CREATE TABLE study (
  study_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  updated_by_user_id bigint NOT NULL,
  study_idx varchar(100) UNIQUE NOT NULL,
  study_state study_state_enum NOT NULL DEFAULT 'ready',
  study_access study_access_enum NOT NULL DEFAULT 'public',
  study_program study_program_enum NOT NULL DEFAULT 'tbc',
  study_title varchar(80),
  study_subtitle varchar(120),
  study_description text,
  study_created_at timestamptz NOT NULL DEFAULT (now()),
  study_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.4.2 study : 학습 문제 세부 정보(study - study_task // 1:N 맵핑, study_task - study_task_* // 1:N 맵핑)
CREATE TABLE study_task (
  study_task_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  study_id int NOT NULL,
  updated_by_user_id bigint NOT NULL,
  study_task_kind study_task_kind_enum NOT NULL,
  study_task_seq int NOT NULL DEFAULT 1,
  study_task_created_at timestamptz NOT NULL DEFAULT (now()),
  study_task_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.4.3 study_task_choice : 학습 문제 [객관식 4지 선다]
CREATE TABLE study_task_choice (
  study_task_id int PRIMARY KEY,
  study_task_choice_question text NOT NULL,
  study_task_choice_1 text NOT NULL,
  study_task_choice_2 text NOT NULL,
  study_task_choice_3 text NOT NULL,
  study_task_choice_4 text NOT NULL,
  study_task_choice_answer int NOT NULL,
  study_task_choice_audio_url text,
  study_task_choice_image_url text
);

-- 2.4.4 study_task_typing : 학습 문제 [쓰기/타이핑]
CREATE TABLE study_task_typing (
  study_task_id int PRIMARY KEY,
  study_task_typing_question text,
  study_task_typing_answer text,
  study_task_typing_image_url text
);

-- 2.4.4 study_task_voice : 학습 문제 [발음/말하기]
CREATE TABLE study_task_voice (
  study_task_id int PRIMARY KEY,
  study_task_voice_question text,
  study_task_voice_answer text,
  study_task_voice_audio_url text,
  study_task_voice_image_url text
);

-- 2.4.5 study_explain : 학습 문제 해설
CREATE TABLE study_explain (
  study_task_id int NOT NULL,
  explain_lang user_set_language_enum NOT NULL DEFAULT 'ko',
  explain_title varchar(120),
  explain_text text,
  explain_media_url text,
  explain_created_at timestamptz NOT NULL DEFAULT (now()),
  explain_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.4.6 study_task_status : 학습 상태(시도 횟수, 풀이여부, 마지막 시도 시간)
CREATE TABLE study_task_status (
  study_task_id INT NOT NULL,
  user_id BIGINT NOT NULL,
  study_task_status_try_count INT NOT NULL DEFAULT 0,
  study_task_status_is_solved BOOLEAN NOT NULL DEFAULT false,
  study_task_status_last_attempt_at TIMESTAMPTZ DEFAULT (now())
);

-- 2.4.7 study_task_log : 학습 문제 풀이 정보(이력, 횟수, 정답여부)
CREATE TABLE study_task_log (
  study_task_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  study_task_id INT NOT NULL,
  user_id BIGINT NOT NULL,
  login_id BIGINT NOT NULL,
  study_task_action_log study_task_log_action_enum NOT NULL,
  study_task_try_no_log INT NOT NULL DEFAULT 1,
  study_task_is_correct_log BOOLEAN,
  study_task_answer_log JSONB,
  study_task_created_at_log TIMESTAMPTZ NOT NULL DEFAULT (now()),
  study_task_ip_log INET,
  study_task_device_log login_device_enum,
  study_task_user_agent_log JSONB
);

-- 2.4.8 admin_study_log : 관리자 활동 기록 [학습]
CREATE TABLE admin_study_log (
  admin_study_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_user_id bigint NOT NULL,
  admin_pick_study_id int NOT NULL,
  admin_pick_task_id int,
  admin_study_action admin_action_enum NOT NULL,  -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_study_before jsonb,
  admin_study_after jsonb,
  admin_study_created_at timestamptz NOT NULL DEFAULT (now()),
  admin_study_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.5 lesson table : 수업 테이블

-- 2.5.1 lesson : 수업 구성 [video + study // N:M 맵핑]
CREATE TABLE lesson (
  lesson_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  updated_by_user_id bigint NOT NULL,
  lesson_idx varchar(100) UNIQUE NOT NULL,
  lesson_state lesson_state_enum NOT NULL DEFAULT 'ready',
  lesson_access lesson_access_enum NOT NULL DEFAULT 'public',
  lesson_title varchar(120) NOT NULL,
  lesson_subtitle varchar(200),
  lesson_description text,
  lesson_created_at timestamptz NOT NULL DEFAULT (now()),
  lesson_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 2.5.2 lesson_item : 수업 순서
CREATE TABLE lesson_item (
  lesson_id int NOT NULL,
  lesson_item_seq int NOT NULL DEFAULT 1,
  lesson_item_kind lesson_item_kind_enum NOT NULL DEFAULT 'video',
  video_id int,
  study_task_id int
);

-- 2.5.3 lesson_progress : 수업 진도
CREATE TABLE lesson_progress (
  lesson_id int NOT NULL,
  user_id bigint NOT NULL,
  lesson_progress_percent int NOT NULL DEFAULT 0,
  lesson_progress_last_item_seq int,
  lesson_progress_last_progress_at timestamptz
);

-- 2.5.4 admin_lesson_log : 관리자 활동 기록 [수업]
CREATE TABLE admin_lesson_log (
  admin_lesson_log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  admin_user_id bigint NOT NULL,
  admin_pick_lesson_id int NOT NULL,
  admin_pick_item_seq int,
  admin_pick_video_id int,
  admin_pick_task_id int,
  admin_lesson_action admin_action_enum NOT NULL, -- 관리자 활동 내역 : 생성, 수정, 금지, 재배치, 배포, 철회로 구분
  admin_lesson_before jsonb,
  admin_lesson_after jsonb,
  admin_lesson_created_at timestamptz NOT NULL DEFAULT (now()),
  admin_lesson_updated_at timestamptz NOT NULL DEFAULT (now())
);

-- 3. Foreign Keys
ALTER TABLE users_log ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE users_setting ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE admin_users_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_users_log ADD FOREIGN KEY (admin_pick_user_id) REFERENCES users (user_id);
ALTER TABLE user_export_data ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE login ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE login_log ADD FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE SET NULL;
ALTER TABLE redis_session ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE redis_session ADD FOREIGN KEY (login_id) REFERENCES login (login_id);
ALTER TABLE redis_refresh ADD FOREIGN KEY (session_id) REFERENCES login (login_session_id);
ALTER TABLE redis_refresh ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE redis_user_sessions ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE redis_user_sessions ADD FOREIGN KEY (session_id) REFERENCES login (login_session_id);
ALTER TABLE redis_session ADD FOREIGN KEY (session_id) REFERENCES login (login_session_id);
ALTER TABLE video ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE video_log ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE video_log ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE video_tag_map ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE video_tag_map ADD FOREIGN KEY (video_tag_id) REFERENCES video_tag (video_tag_id);
ALTER TABLE video_stat_daily ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE admin_video_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_video_log ADD FOREIGN KEY (admin_pick_video_id) REFERENCES video (video_id);
ALTER TABLE admin_video_log ADD FOREIGN KEY (admin_pick_video_tag_id) REFERENCES video_tag (video_tag_id);
ALTER TABLE study ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE study ADD COLUMN IF NOT EXISTS study_access study_access_enum NOT NULL DEFAULT 'public';
ALTER TABLE study_task ADD FOREIGN KEY (study_id) REFERENCES study (study_id);
ALTER TABLE study_task ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE study_task_choice ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_task_typing ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_task_voice ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_explain ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE study_task_status ADD CONSTRAINT fk_study_task_status_task FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id) ON DELETE CASCADE;
ALTER TABLE study_task_status ADD FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE CASCADE;
ALTER TABLE study_task_log ADD CONSTRAINT fk_study_task_log_task FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id) ON DELETE CASCADE;
ALTER TABLE study_task_log ADD FOREIGN KEY (user_id) REFERENCES users (user_id) ON DELETE CASCADE;
ALTER TABLE admin_study_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_study_log ADD FOREIGN KEY (admin_pick_study_id) REFERENCES study (study_id);
ALTER TABLE admin_study_log ADD FOREIGN KEY (admin_pick_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE lesson ADD FOREIGN KEY (updated_by_user_id) REFERENCES users (user_id);
ALTER TABLE lesson ADD COLUMN IF NOT EXISTS lesson_state lesson_state_enum NOT NULL DEFAULT 'ready';
ALTER TABLE lesson ADD COLUMN IF NOT EXISTS lesson_access lesson_access_enum NOT NULL DEFAULT 'public';
ALTER TABLE lesson_item ADD FOREIGN KEY (lesson_id) REFERENCES lesson (lesson_id);
ALTER TABLE lesson_item ADD FOREIGN KEY (video_id) REFERENCES video (video_id);
ALTER TABLE lesson_item ADD FOREIGN KEY (study_task_id) REFERENCES study_task (study_task_id);
ALTER TABLE lesson_progress ADD FOREIGN KEY (lesson_id) REFERENCES lesson (lesson_id);
ALTER TABLE lesson_progress ADD FOREIGN KEY (user_id) REFERENCES users (user_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_user_id) REFERENCES users (user_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_pick_lesson_id) REFERENCES lesson (lesson_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_pick_video_id) REFERENCES video (video_id);
ALTER TABLE admin_lesson_log ADD FOREIGN KEY (admin_pick_task_id) REFERENCES study_task (study_task_id);

-- 4. Indexes
CREATE INDEX index_admin_user_id ON admin_users_log (admin_user_id);
CREATE INDEX index_target_user_id ON admin_users_log (admin_pick_user_id);
CREATE INDEX index_export_data_user_id ON user_export_data (user_id);
CREATE INDEX index_login_user_id ON login (user_id);
CREATE INDEX index_login_state ON login (login_state);
CREATE INDEX index_login_begin_at ON login (login_begin_at);
CREATE INDEX index_login_expire_at ON login (login_expire_at);
CREATE INDEX index_login_active_by_user ON login (user_id, login_state);
CREATE INDEX index_login_user_id_login_begin_at_log ON login_log (user_id, login_begin_at_log);
CREATE INDEX index_login_event_log ON login_log (login_event_log);
CREATE INDEX index_redis_refresh_session_id ON redis_refresh (session_id);
CREATE INDEX index_redis_refresh_user_id ON redis_refresh (user_id);
CREATE INDEX index_redis_user_sessions_user_id ON redis_user_sessions (user_id);
CREATE UNIQUE INDEX unique_redis_user_sessions_session_id ON redis_user_sessions (session_id);
CREATE INDEX index_video_state_video_access ON video (video_state, video_access);
CREATE INDEX index_video_created_at ON video (video_created_at);
CREATE UNIQUE INDEX unique_video_id_user_id ON video_log (video_id, user_id);
CREATE INDEX index_user_id_video_last_watched_at_log ON video_log (user_id, video_last_watched_at_log);
CREATE INDEX index_video_id_video_last_watched_at_log ON video_log (video_id, video_last_watched_at_log);
CREATE UNIQUE INDEX unique_video_id_video_tag_id ON video_tag_map (video_id, video_tag_id);
CREATE UNIQUE INDEX unique_video_stat_date_video_id ON video_stat_daily (video_stat_date, video_id);
CREATE INDEX index_admin_user_id_video ON admin_video_log (admin_user_id);
CREATE INDEX index_admin_pick_video_id ON admin_video_log (admin_pick_video_id);
CREATE INDEX IF NOT EXISTS index_study_state_access ON study (study_state, study_access);
CREATE UNIQUE INDEX unique_study_id_study_task_seq ON study_task (study_id, study_task_seq);
CREATE INDEX index_study_task_kind ON study_task (study_task_kind);
CREATE UNIQUE INDEX unique_study_task_explain_lang ON study_explain (study_task_id, explain_lang);
CREATE INDEX index_explain_lang ON study_explain (explain_lang);
CREATE INDEX idx_study_task_log_user_task ON study_task_log (user_id, study_task_id);
CREATE INDEX index_admin_study_actor ON admin_study_log (admin_user_id);
CREATE INDEX index_admin_study_target ON admin_study_log (admin_pick_study_id);
CREATE INDEX index_admin_study_task_target ON admin_study_log (admin_pick_task_id);
CREATE INDEX IF NOT EXISTS index_lesson_state_access ON lesson (lesson_state, lesson_access);
CREATE UNIQUE INDEX unique_lesson_id_lesson_item_seq ON lesson_item (lesson_id, lesson_item_seq);
CREATE INDEX index_video_id ON lesson_item (video_id);
CREATE INDEX index_study_task_id ON lesson_item (study_task_id);
CREATE UNIQUE INDEX unique_lesson_id_user_id ON lesson_progress (lesson_id, user_id);
CREATE INDEX index_user_id ON lesson_progress (user_id);
CREATE INDEX index_admin_lesson_actor ON admin_lesson_log (admin_user_id);
CREATE INDEX index_admin_lesson_target ON admin_lesson_log (admin_pick_lesson_id);
CREATE INDEX index_admin_lesson_item_seq ON admin_lesson_log (admin_pick_item_seq);
CREATE INDEX index_admin_lesson_video_target ON admin_lesson_log (admin_pick_video_id);
CREATE INDEX index_admin_lesson_task_target ON admin_lesson_log (admin_pick_task_id);
```