# OpenAI Codex Agent Guide — Amazing Korean API

이 파일은 `~/dev/amazing-korean-api` 레포에서 **OpenAI Codex**가 작업할 때 지켜야 할 규칙을 정의한다.  
Codex는 이 문서를 최우선으로 따르며, 사용자의 추가 지시가 있을 경우 그 지시를 포함해 행동한다.

---

## 1. 프로젝트 개요

- 프로젝트명: **Amazing Korean API**
- 목적: 온라인 한국어 학습 서비스(Amazing Korean)의 백엔드 API 서버
- 주요 스택:
  - 언어/런타임: **Rust 2021**, Tokio
  - 웹 프레임워크: **Axum 0.8**
  - DB: **PostgreSQL** (`sqlx` 기반)
  - 캐시/세션: **Redis**
  - 문서화: **utoipa(OpenAPI) + Swagger UI**

### 주요 디렉터리 구조

- `src/main.rs`  
  - 엔트리포인트. 설정 로드, DB/Redis 풀 생성, 최상위 Router 설정.
- `src/config.rs` / `src/state.rs` / `src/types.rs` / `src/error.rs`  
  - 공통 설정/상태/타입/에러 헬퍼.
- `src/api/`
  - 도메인별 HTTP API 모듈.
    - `auth/`, `user/`, `video/`, `admin/`, `health/` 등
    - 각 도메인은 보통 `handler.rs`(라우트), `service.rs`(비즈니스 로직),
      `repo.rs`(SQLx 쿼리), `dto.rs`(요청/응답 DTO), `router.rs` 로 구성.
- `src/docs.rs`  
  - OpenAPI/Swagger 정의 및 태그 정리.
- `migrations/`  
  - SQLx 마이그레이션 파일.
- `sql/`  
  - 조회용 SQL, 함수 호출용 SQL 등 스니펫.
- `scripts/`  
  - 운영/개발 스크립트 (`dev_preflight.sh` 등).
- `verify_refresh.sh`  
  - 리프레시 토큰 플로우 검증 스크립트.

---

## 2. 골든 룰 (Codex가 반드시 지킬 것)

1. **임의로 파일을 수정하지 않는다.**
   - 사용자가 명시적으로 “수정해도 된다”고 하거나,
   - 이 문서의 “허용된 행동”에 따라 **승인을 받은 경우에만** 수정한다.
   - 가능하면 **“파일 전체 교체본” 패치** 형태로 제안하고, 사용자가 직접 반영하도록 한다.

2. **모든 중요한 변경은 먼저 제안, 나중에 실행한다.**
   - “어떤 파일을 어떻게 고칠지”를 **텍스트/코드블록**으로 제안한 뒤,
   - 사용자가 승인하면 `apply_patch` 또는 에디터를 사용해 반영한다.

3. **Rust 빌드 가드를 깐 뒤에 변경한다.**
   - 변경 전/후로 아래 명령들을 우선 고려한다:
     - `cargo check`
     - `cargo fmt -- --check`
     - `cargo clippy --all-targets --all-features -D warnings`
   - 변경으로 인해 에러가 생기면, **원인 분석 + 수정 패치**까지 제안한다.

4. **DB 마이그레이션/데이터 삭제 같은 파괴적 작업은 절대 독단으로 하지 않는다.**
   - `sqlx migrate run` / `drop`, `truncate`, 대량 `delete` 쿼리 등은
     **반드시 사용자에게 구두로 확인을 받은 뒤에만 실행**한다.
   - 이 문서가 허용한 범위를 넘는 destructive 작업은 항상 금지한다.

5. **보안/비밀 정보는 건드리지 않는다.**
   - `.env` 혹은 비밀 키/토큰이 있을 경우:
     - 내용 조회, 수정, 출력, 커밋 제안 모두 **금지**.
   - 코드에서 비밀 값이 하드코딩된 경우, 이를 제거하고 env/설정 기반으로 바꾸는 방향만 제안한다.

6. **Git은 항상 보수적으로 사용한다.**
   - `git commit`, `git push`, `git reset --hard`, `git rebase`, `git clean` 등
     **히스토리/파일을 되돌릴 수 없는 명령은 실행하지 않는다.**
   - 커밋 메시지는 필요 시 제안만 한다(사용자가 직접 입력).

---

## 3. 허용된 행동 (Allowed Actions)

Codex는 아래 행동을 기본적으로 수행할 수 있다.  
단, `/approvals` 설정에 따라 실제 실행 시점에 사용자의 승인이 필요할 수 있다.

### 3.1 읽기/분석

- 소스코드/마이그레이션/문서 파일을 읽고 이해/설명:
  - `src/**/*`, `migrations/**/*`, `sql/**/*`, `scripts/**/*`, `Cargo.toml`, `rust-toolchain` 등.
- 특정 모듈/엔드포인트의 역할·흐름·의존성 분석.
- DB 스키마/ERD 관점에서 테이블/컬럼/인덱스/제약 조건 설명.

### 3.2 진단 & 리포트

- `cargo check` 결과를 요약하고, 타입에러/빌드 에러에 대한 수정 방향 제안.
- `cargo clippy` 경고를 분류하고, 위험도/우선순위에 따른 해결 전략 제안.
- 특정 엔드포인트에 대해:
  - 핸들러 → 서비스 → repo → SQL 호출 흐름 추적.
  - 에러 핸들링/로그/Swagger 문서화 상태를 점검하고, 개선 목록 작성.

### 3.3 안전한 명령 실행 예시

(항상 레포 루트 `~/dev/amazing-korean-api` 기준으로 실행)

- 빌드/정적 분석:
  - `cargo check`
  - `cargo fmt -- --check`
  - `cargo clippy --all-targets --all-features -D warnings`
- 테스트:
  - `cargo test` (전체 또는 특정 패키지/모듈 단위)
- 헬스/프리플라이트:
  - `scripts/dev_preflight.sh`
  - `./verify_refresh.sh` (API + Redis 실행이 전제됨)
- DB 마이그레이션 상태 조회 (실행 X):
  - `sqlx migrate info`

이 외의 명령(특히 Docker, systemctl, rm -rf 등)은  
**사용자가 구체적으로 요청하지 않는 이상 실행하지 않는다.**

---

## 4. 금지된 행동 (Disallowed Actions)

Codex는 **다음 행동을 해서는 안 된다.**

1. **파일/디렉터리 삭제**
   - `rm -rf`, `rm`으로 소스/마이그레이션/스크립트 삭제 금지.
   - 디렉터리 구조를 변경해야 할 경우, 반드시 사용자에게 설계/이유를 먼저 설명하고 승인받는다.

2. **마이그레이션 생성/수정/삭제 (사용자 요청 없이)**
   - 새로운 마이그레이션 파일 추가, 기존 마이그레이션 편집/삭제는  
     **사용자가 명시적으로 요청한 경우에만** 수행한다.
   - 이미 적용된 마이그레이션 파일을 수정하자고 제안하지 않는다.  
     (항상 새로운 마이그레이션을 추가하는 방향으로 제안)

3. **Git 역사/워크트리 파괴**
   - `git reset --hard`, `git clean -fdx`, `git rebase`, `git push --force` 등 금지.
   - 브랜치 전략/PR 전략을 변경하는 작업은 제안만 하고 실행하지 않는다.

4. **환경/시스템 설정 변경**
   - `/etc/*`, Docker 데몬, 시스템 서비스 등 OS 레벨 설정을 직접 변경하지 않는다.
   - Docker 컨테이너 조작도 기본적으로 금지하며, 꼭 필요할 때만 사용자 지시에 따른다.

5. **민감한 정보 출력**
   - `.env` / 비밀 키 / 비밀번호 / 토큰 등이 화면 출력이나 로그에 노출되게 하지 않는다.
   - 해당 정보가 코드 내에 있을 때는, “환경 변수/시크릿 스토어로 분리할 것”만 제안한다.

---

## 5. 코드/패치 스타일 가이드

Codex가 변경안을 제안할 때는 아래 원칙을 따른다.

1. **파일 단위 전체 교체본을 기본으로 한다.**
   - 가능하면 다음 형식을 사용한다:
     ```markdown
     [파일 교체] src/api/user/handler.rs

     ```rust
     // 여기 전체 파일 내용 (붙여넣으면 바로 빌드/실행 가능해야 함)
     ```
     ```
   - 부분 패치(diff) 형식이 필요한 경우에도,
     사용자가 원하면 언제든지 **전체 교체본**을 다시 제공할 수 있어야 한다.

2. **빌드/포맷/린트에 통과하는 코드만 제안한다.**
   - `cargo check`가 통과할 수 있도록 타입/라이프타임/임포트 등을 맞춘다.
   - `cargo fmt` 기준으로 포맷을 맞춘다.
   - 새 코드는 `cargo clippy --all-targets --all-features -D warnings` 기준을 어기지 않도록 한다.

3. **기존 모듈 구조를 존중한다.**
   - `handler/service/repo/dto/router` 분리 패턴을 그대로 유지한다.
   - 기존 네이밍 컨벤션을 그대로 따른다:
     - snake_case: 함수, 변수, 필드
     - PascalCase: 타입/DTO
   - 새 기능을 추가할 때도 동일한 패턴으로 확장한다.

4. **SQLx 및 DB 관련 제안**
   - 쿼리는 가능한 `sqlx::query`/`sqlx::query_as` 패턴을 따른다.
   - 변경이 필요한 DB 스키마는
     - 먼저 ERD/기존 마이그레이션/코드 의존성을 분석한 뒤,
     - 새 마이그레이션 파일 추가 형식으로 제안한다.

---

## 6. 작업 우선순위 & 추천 워크플로우

Codex가 이 레포에서 일할 때는 보통 아래 순서를 따른다.

1. **상황 파악**
   - 사용자의 요청을 요약한다.
   - 관련된 파일/모듈/엔드포인트를 찾고, 간단히 구조를 설명한다.

2. **현 상태 진단**
   - 필요 시 `cargo check` 를 먼저 돌려 현재 에러가 있는지 확인한다.
   - 특정 엔드포인트/기능이면, 해당 모듈의 흐름(핸들러 → 서비스 → repo → SQL)을 짧게 리포트한다.

3. **설계 제안**
   - 변경할 내용/파일 목록/리팩터링 방식을 **텍스트로 먼저 설계**한다.
   - DB/마이그레이션이 연관되면, 예상되는 영향도와 롤백 전략을 함께 적는다.

4. **구체 패치 제안**
   - 수정해야 할 파일에 대해 **전체 교체본**을 제안한다.
   - 필요한 경우 테스트/검증용 `curl` / `http` 스크립트도 함께 제안한다.

5. **검증 플랜 안내**
   - 사용자가 직접 수행할 수 있는 검증 커맨드를 안내한다:
     - `cargo check`
     - `cargo fmt -- --check`
     - `cargo clippy --all-targets --all-features -D warnings`
     - 필요 시 `cargo test`, `scripts/dev_preflight.sh`, `./verify_refresh.sh`

6. **후속 작업 제안**
   - 로그/모니터링/에러 메시지 정리, 문서 업데이트, 테스트 코드 추가 등  
     후속 개선 사항이 있으면 간단히 TODO 목록 형태로 남긴다.

---

## 7. 커뮤니케이션 규칙 (Codex ↔ 사용자)

- Codex는 **짧고 구조화된 답변**을 선호한다:
  - “요약 → 문제 원인 → 제안 패치 → 검증 방법” 순서.
- 사용자가 “전체 교체본만 줘”라고 요청한 경우,
  - 중간 추측이나 설명보다 **완성 코드/마이그레이션**을 우선 제공한다.
- 에러나 불확실한 부분이 있을 때는,
  - 가능한 한 **추측 대신 현재 알 수 있는 사실과, 추가로 확인해야 할 정보**를 분리해서 말한다.

---

이 문서는 코드를 수정하거나 기능을 추가하기 전에  
Codex가 반드시 읽고 따라야 하는 **행동 매뉴얼**이다.  

사용자가 Amazing Korean 프로젝트의 규칙을 업데이트하면  
해당 내용을 반영해 이 파일을 함께 갱신해야 한다.