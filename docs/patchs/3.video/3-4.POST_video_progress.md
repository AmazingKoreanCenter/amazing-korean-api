# PATCH — Phase 3-4 Video Progress Update (POST /videos/{id}/progress)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 3-4 `POST /videos/{id}/progress` 엔드포인트 구현.
- 인증된 사용자의 비디오 시청 진행률을 **저장 또는 갱신(Upsert)**.
- **Unique Constraint 추가 Migration** 수행.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [3-4] 참조.
- **Table Schema (`video_log`)**:
  - `user_id`, `video_id`가 핵심.
  - **Requirement**: 한 유저가 한 비디오에 대해 중복된 로그를 가질 수 없음. -> **(user_id, video_id) 복합 유니크 제약조건 필수**.
- **Upsert Logic**:
  - `INSERT INTO ... ON CONFLICT (user_id, video_id) DO UPDATE ...` 사용.
  - `last_watched_at`은 항상 `NOW()`로 갱신.
  - `is_completed`는 `progress_rate`가 **100**일 때 `true`, 아니면 `false`로 자동 처리.
- **Validation**:
  - `progress_rate`: **0 ~ 100** (Validator). 범위 위반 시 **422**.
  - `video_id`: 존재하지 않는 비디오면 **404**.

CONTRACT (구현 명세):
- [HTTP] `POST /videos/{id}/progress`
- [Header] `Authorization: Bearer <token>`
- [Body] `VideoProgressUpdateReq`
  ```json
  { "progress_rate": 85 }
  ```
- [Response] **200 OK** (갱신된 정보 반환 - 3-3의 `VideoProgressRes` 재사용)

IMPLEMENTATION STEPS:
1.  **Migration**: `migrations/20251231_add_unique_constraint_video_log.sql`
    - `ALTER TABLE video_log ADD CONSTRAINT uk_video_log_user_video UNIQUE (user_id, video_id);`
    - (Upsert를 위한 필수 조건)
2.  **DTO (`src/api/video/dto.rs`)**:
    - `VideoProgressUpdateReq`: `progress_rate` 필드에 `#[validate(range(min = 0, max = 100))]` 적용.
3.  **Repo (`src/api/video/repo.rs`)**:
    - `upsert_progress_log`: `INSERT ... ON CONFLICT ... DO UPDATE` 쿼리 구현.
4.  **Service (`src/api/video/service.rs`)**:
    - `update_progress`:
      1. Validation (422)
      2. Video 존재 확인 (404)
      3. Repo Upsert 호출
      4. 결과 반환
5.  **Handler & Router**: 엔드포인트 등록.

FILE PATCHES START
// migrations/20251231_add_unique_constraint_video_log.sql
// src/api/video/dto.rs
// src/api/video/repo.rs
// src/api/video/service.rs
// src/api/video/handler.rs
// src/api/video/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인 (토큰)
# TOKEN=...

# 2. 진행률 50% 저장 (최초 저장 -> Insert)
curl -v -X POST "http://localhost:3000/videos/1/progress" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"progress_rate": 50}'

# 3. 진행률 100% 갱신 (이미 존재 -> Update & Completed=true)
curl -v -X POST "http://localhost:3000/videos/1/progress" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"progress_rate": 100}'

# 4. 범위 오류 (422)
curl -v -X POST "http://localhost:3000/videos/1/progress" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"progress_rate": 150}'
```