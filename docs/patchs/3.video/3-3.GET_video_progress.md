# PATCH — Phase 3-3 Video Progress (GET /videos/{id}/progress)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 3-3 `GET /videos/{id}/progress` 엔드포인트 구현.
- **기존 `video_log` 테이블 스키마 정리 (Migration)**.
- 인증된 사용자(`Claims`)의 특정 비디오 시청 진행률 조회.

CONTEXT (SSOT & Rules):
- **Legacy Schema Fix**:
  - `video_log` 테이블이 이미 존재함 (소문자).
  - **Issue**: `login_id` 컬럼은 현재 인증 구조(JWT)에서 불필요하며, `NOT NULL` 제약 조건 때문에 데이터 삽입/수정 시 방해가 됨.
- **Migration Strategy**:
  - `migrations/20251231_drop_login_id_from_video_log.sql` 생성.
  - **Action**: `login_id` 컬럼 삭제 (`ALTER TABLE video_log DROP COLUMN login_id;`).
  - *Note*: 테이블 이름 변경은 필요 없음.
- **Logic**:
  - 1. `video` 테이블에 `video_id`가 존재하는지 확인 -> 없으면 **404 Not Found**.
  - 2. `video_log`에서 `(user_id, video_id)`로 조회.
  - 3. 결과가 없으면 -> **기본값(0%)** 반환 (에러 아님).
     - `{ progress_rate: 0, is_completed: false, last_watched_at: null }`
  - 4. 결과가 있으면 -> DB 컬럼(`video_progress_log` 등)을 DTO로 매핑하여 반환.

CONTRACT (구현 명세):
- [HTTP] `GET /videos/{id}/progress`
- [Header] `Authorization: Bearer <token>`
- [Response] `VideoProgressRes`
  ```json
  {
    "video_id": 1,
    "progress_rate": 50,          // DB: video_progress_log
    "is_completed": false,        // DB: video_completed_log
    "last_watched_at": "..."      // DB: video_last_watched_at_log
  }
  ```

IMPLEMENTATION STEPS:
1.  **Migration**: `migrations/20251231_drop_login_id_from_video_log.sql` 작성.
    - `ALTER TABLE video_log DROP COLUMN login_id;`
2.  **DTO (`src/api/video/dto.rs`)**:
    - `VideoProgressRes`:
      - `#[sqlx(rename = "video_progress_log")]` 등을 사용하여 DB 컬럼과 매핑.
      - `#[serde(rename = "progress_rate")]` 등으로 JSON 응답 키 설정.
3.  **Repo (`src/api/video/repo.rs`)**:
    - `find_progress_log(user_id, video_id)` 구현.
4.  **Service (`src/api/video/service.rs`)**:
    - 비디오 존재 확인(404) -> 로그 조회 -> 없으면 기본값 객체 리턴.
5.  **Handler (`src/api/video/handler.rs`)**:
    - `get_progress`: `Claims`에서 `user_id` 추출하여 호출.
6.  **Router**: 라우트 등록.

FILE PATCHES START
// migrations/20251231_drop_login_id_from_video_log.sql
// src/api/video/dto.rs
// src/api/video/repo.rs
// src/api/video/service.rs
// src/api/video/handler.rs
// src/api/video/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인 (토큰 획득)
# TOKEN=$(curl -X POST http://localhost:3000/auth/login ...)

# 2. 진행도 조회 (DB 기록 없음 -> 0% 반환 예상)
curl -v -H "Authorization: Bearer $TOKEN" "http://localhost:3000/videos/1/progress"

# 3. 없는 비디오 조회 (-> 404 예상)
curl -v -H "Authorization: Bearer $TOKEN" "http://localhost:3000/videos/9999/progress"
```