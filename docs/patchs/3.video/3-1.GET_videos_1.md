# PATCH — Phase 3-1 Video List (GET /videos)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 3-1 `GET /videos` 엔드포인트 구현.
- **기존 `video` 테이블**과 **태그 시스템(`video_tag`, `video_tag_map`)**을 조인하여 데이터 조회.
- 페이지네이션, 정렬, 태그 집계(Aggregation) 구현.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [3-1] 참조.
- **Schema (CRITICAL)**:
  - `video` 테이블: `video_title`, `video_thumbnail` 컬럼이 **없음**. (순수 비디오 정보만 존재)
  - `video_tag` 테이블: 제목, 설명, 카테고리 등 모든 메타 정보가 태그 형태로 존재.
  - `video_tag_map` 테이블: 비디오와 태그를 N:M 연결.
- **Requirement**:
  - 비디오 목록 조회 시, 해당 비디오에 연결된 **모든 태그 이름(`tag_name`)을 배열로 합쳐서(`array_agg`)** 반환해야 함.
  - 클라이언트는 반환된 태그 목록을 통해 제목이나 속성을 표시함.
- **Pagination**:
  - `page` < 1 또는 `per_page` 범위(1~100) 위반 시 **422 Unprocessable Entity**.
- **Response**:
  - `VideoInfo` DTO에 `title` 필드 대신 **`tags: Vec<String>`** 필드가 포함되어야 함.

CONTRACT (구현 명세):
- [HTTP] `GET /videos`
- [Query] `VideoListReq` { page: Option<u64>, per_page: Option<u64>, sort: Option<String> }
- [Logic]
  1. **Validation**: 입력값 범위 검증 (Validator). 위반 시 422.
  2. **Count**: `is_opened = true` (또는 `video_state = 'open'`) 조건의 전체 개수 조회.
  3. **Select (Aggregation)**:
     - `video` (v) LEFT JOIN `video_tag_map` (vm) LEFT JOIN `video_tag` (vt).
     - `GROUP BY v.video_id`.
     - `array_agg(vt.tag_name)`을 사용하여 태그 목록 생성.
     - 정렬(`sort`)은 `v.video_created_at` 기준.
  4. **Response**: 200 OK `{ meta: ..., data: [ { video_id, tags: ["title_tag", "java"], ... } ] }`

IMPLEMENTATION STEPS:
1.  **Module**: `src/api/video` 생성 및 `mod.rs` 등록.
2.  **DTO (`src/api/video/dto.rs`)**:
    - `VideoListReq`: Validation(`range`) 적용.
    - `VideoInfo`: **`title` 제거**, **`tags: Vec<String>` 추가** (FromRow 처리를 위해 `sqlx::types` 주의).
    - `VideoListRes`: Meta + Data.
3.  **Repo (`src/api/video/repo.rs`)**:
    - `find_open_videos`:
      - SQL: `SELECT v.video_id, v.video_url_vimeo, ..., COALESCE(array_agg(vt.tag_name) FILTER (WHERE vt.tag_name IS NOT NULL), '{}') as tags FROM video v LEFT JOIN ...`
4.  **Service (`src/api/video/service.rs`)**:
    - 비즈니스 로직 및 페이징 계산.
5.  **Handler (`src/api/video/handler.rs`)**:
    - 요청 처리 및 에러 매핑.
6.  **Router**: 라우터 등록 및 `src/api/mod.rs` 병합.

FILE PATCHES START
// src/api/video/mod.rs
// src/api/video/dto.rs
// src/api/video/repo.rs
// src/api/video/service.rs
// src/api/video/handler.rs
// src/api/video/router.rs
// src/api/mod.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 목록 조회 (태그 배열 포함 확인)
curl -v "http://localhost:3000/videos"

# 2. 페이징 테스트
curl -v "http://localhost:3000/videos?page=1&per_page=5"

# 3. 유효성 검증 실패 (422)
curl -v "http://localhost:3000/videos?page=0"
```