# 📝 Dev Notes: Phase 3-3 Implementation (GET /videos/{id}/progress)

## 📋 개요
- **작업**: 비디오 진행률 조회 API (`GET /videos/{id}/progress`)
- **기간**: 2025.12.31
- **성격**: Video Log Table Migration, Null Handling, DTO Mapping

---

## 🛠️ 트러블슈팅 (Troubleshooting)

### 1. 레거시 스키마 충돌 (Legacy Schema Conflict)
- **발견**: `video_log` 테이블을 새로 생성하려 했으나, 기존 `AMK_SCHEMA_PATCHED.sql`에 이미 `VIDEO_LOG` 테이블이 존재했음.
- **문제**: 기존 테이블의 `login_id` 컬럼이 `NOT NULL`로 설정되어 있었으나, 현재 JWT 기반 인증 시스템에서는 세션 ID(`login_id`)를 추적하지 않으므로 데이터 삽입 시 제약 조건 위반 발생 예상.
- **해결**:
  - `login_id` 컬럼을 삭제(`DROP COLUMN`)하는 마이그레이션 실행.
  - 불필요한 레거시 의존성을 제거하고 `user_id` 중심의 심플한 구조로 개편.

### 2. DTO 필드명 매핑 (Field Renaming)
- **과제**: DB 컬럼명(`video_progress_log`, `video_completed_log`)이 너무 길고 내부 구현 상세를 노출함.
- **해결**: `#[sqlx(rename = "...")]` 속성을 사용하여 DB 컬럼을 Rust 구조체의 직관적인 필드명(`progress_rate`, `is_completed`)으로 매핑.
- **결과**: API 응답 JSON이 훨씬 깔끔해짐.

### 3. '기록 없음'의 의미론적 처리 (Null Object Pattern)
- **논의**: "시청 기록이 없다"는 것이 에러(404)인가?
- **결정**: 비디오가 존재한다면 시청 기록이 없는 것은 "아직 안 본 상태(0%)"일 뿐 에러가 아님.
- **구현**: Service 계층에서 `Option::None`을 받으면 404를 던지는 대신, 0%로 초기화된 기본 객체를 반환하도록 처리.

---

## 🔑 확립된 핵심 개발 패턴 (Key Patterns)

### 1. Migration for Schema Fix
- **전략**: 기존 테이블이 현재 요구사항과 맞지 않을 때, 억지로 맞추기보다 `ALTER TABLE`을 통해 과감하게 스키마를 수정하여 기술 부채를 즉시 해소.

### 2. Proactive Type Casting
- **전략**: `repo` 계층에서 `video_id::bigint` 캐스팅을 습관화하여 `INT4`(DB) vs `i64`(Rust) 충돌을 원천 차단.

---

## ✅ 결론
- **구현 완료**: 인증된 사용자의 시청 기록 조회 가능.
- **예외 처리**: 없는 비디오(404)와 기록 없는 비디오(0%)의 구분 명확화.
- **다음 단계**: 실제 시청 데이터를 저장하는 **Phase 3-4 (진행률 저장)** 구현.