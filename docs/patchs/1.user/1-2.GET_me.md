# PATCH — Phase 1-2 Get Me (GET /users/me)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 1-2 `GET /users/me` (내 정보 조회) 엔드포인트를 구현.
- **인증된 사용자(Bearer Token)**만 접근 가능하며, 자신의 프로필 정보를 반환.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.1 Phase 1-2] 참조.
- **Schema**: `user_state`는 **BOOLEAN** (true=active, false=inactive). `user_language` 등은 **ENUM** (text 변환 주의).
- **Previous Issues**:
  - `user_state`는 Enum이 아닌 `bool`입니다.
  - `user_language`는 DB에서 Enum이므로 `::TEXT` 캐스팅으로 가져와야 합니다.
  - `ProfileRes` DTO는 이미 `src/api/user/dto.rs`에 정의되어 있습니다 (Phase 1-1에서 사용).

CONTRACT (구현 명세):
- [HTTP] `GET /users/me`
- [Auth] **Auth Middleware 필수 적용** (Header: `Authorization: Bearer <token>`).
- [Logic]
  1. 미들웨어에서 추출한 `user_id`를 사용.
  2. DB에서 사용자 조회 (비밀번호 제외).
  3. 사용자 존재 여부 및 `user_state` 확인.
- [Response]
  - **200 OK**: `ProfileRes` (성공).
  - **401 Unauthorized**: 토큰 없음/만료 (미들웨어 처리).
  - **404 Not Found**: DB에 사용자가 없거나 `user_state == false` (비활성/탈퇴).

IMPLEMENTATION STEPS:
1.  **Repo (`src/api/user/repo.rs`)**:
    - `find_profile_by_id` 함수 추가.
    - 쿼리 작성 시 `user_language::TEXT`, `user_auth::TEXT`(필요시) 캐스팅 주의.
2.  **Service (`src/api/user/service.rs`)**:
    - `get_me` 함수 구현.
    - Repo 조회 결과가 없거나 `!user.user_state`인 경우 `AppError::NotFound` 반환.
3.  **Handler (`src/api/user/handler.rs`)**:
    - `get_me` 핸들러 추가.
    - `Extension<AuthUser>` (또는 claims)를 통해 user_id 획득.
4.  **Router (`src/api/user/router.rs`)**:
    - `/me` 경로 등록 및 `route_layer(middleware::from_fn(auth_middleware))` 적용 확인.

FILE PATCHES START
// src/api/user/repo.rs
// src/api/user/service.rs
// src/api/user/handler.rs
// src/api/user/router.rs
// (필요 시) src/middleware/auth.rs (인증 미들웨어 연결 확인)
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인/가입 후 받은 Access Token 준비
TOKEN="<YOUR_ACCESS_TOKEN>"

# 2. 성공 케이스
curl -v -X GET http://localhost:3000/users/me \
  -H "Authorization: Bearer $TOKEN"

# 3. 실패 케이스 (토큰 없음) -> 401 Expected
curl -v -X GET http://localhost:3000/users/me

# 4. 실패 케이스 (잘못된 토큰) -> 401 Expected
curl -v -X GET http://localhost:3000/users/me \
  -H "Authorization: Bearer invalid_token_123"
```