# PATCH — Phase 1-3 Update Me (POST /users/me)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 1-3 `POST /users/me` (내 정보 수정) 엔드포인트를 구현.
- 인증된 사용자의 프로필 정보를 수정하고, **반드시 변경 후 상태를 `users_log`에 기록(Snapshot)**해야 함.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.1-3 : POST /users/me] 참조.
- **Previous Patterns**:
  - `repo.rs`: `::TEXT` 캐스팅 규칙 준수 (Enum 처리).
  - `handler.rs`: `AuthUser` Extractor 사용.
  - **Transaction**: `UPDATE users` -> `INSERT users_log`는 하나의 트랜잭션으로 묶여야 함.
- **DTO**: `ProfileUpdateReq` (nickname, language, country, birthday, gender).
  - *Email, Name, Password는 이 API에서 수정하지 않음.*

CONTRACT (구현 명세):
- [HTTP] `POST /users/me`
- [Auth] `AuthUser` Extractor 필수.
- [Validation]
  - `400 Bad Request`: JSON 파싱 실패, 타입 오류.
  - `422 Unprocessable Entity`: 도메인 검증 실패 (예: 미래의 생일 등 - 필요시 추가).
- [Logic]
  1. **Transaction Start**.
  2. `users` 테이블 업데이트 (Dynamic Update가 아닌, 폼 제출이므로 전체 필드 업데이트 권장).
  3. `insert_user_log_after_tx` 호출 (Action: "update").
     - *Tip*: Phase 1-1에서 만든 이 함수는 `users` 테이블의 최신 상태를 `SELECT`해서 로그를 남기므로, Update 직후에 호출하면 "성공 스냅샷" 조건이 자동 만족됨.
  4. **Transaction Commit**.
- [Response]
  - **200 OK**: 변경된 정보가 담긴 `ProfileRes` 반환.

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/user/dto.rs`)**:
    - `ProfileUpdateReq` 구조체 정의.
    - 필드: `nickname` (Option<String>), `language` (Option<String>), `country` (Option<String>), `birthday` (Option<NaiveDate>), `gender` (Option<UserGender>).
2.  **Repo (`src/api/user/repo.rs`)**:
    - `update_profile_tx` 함수 추가.
    - **Query 주의**: `user_language = $x::user_language_enum`, `user_gender = $y::user_gender_enum` 캐스팅 필수.
    - `RETURNING` 절을 사용하여 업데이트된 `ProfileRes`를 반환받도록 작성.
3.  **Service (`src/api/user/service.rs`)**:
    - `update_me` 함수 구현.
    - 트랜잭션 시작 -> `repo::update_profile_tx` -> `repo::insert_user_log_after_tx` -> 커밋.
4.  **Handler (`src/api/user/handler.rs`)**:
    - `update_me` 핸들러 구현 (`AuthUser`, `Json<ProfileUpdateReq>`).
5.  **Router (`src/api/user/router.rs`)**:
    - `POST /users/me` (또는 `/me`) 엔드포인트 등록.

FILE PATCHES START
// src/api/user/dto.rs
// src/api/user/repo.rs
// src/api/user/service.rs
// src/api/user/handler.rs
// src/api/user/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인 (Token 확보)
TOKEN="<YOUR_ACCESS_TOKEN>"

# 2. 내 정보 수정 (성공) -> 200 OK Check
curl -v -X POST http://localhost:3000/users/me \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "nickname": "new_nick",
    "language": "en",
    "country": "US",
    "birthday": "1999-12-31",
    "gender": "female"
  }'

# 3. DB 로그 확인 (SQL)
# SELECT * FROM users_log ORDER BY user_log_id DESC LIMIT 1;
# -> user_action_log='update' 이고, 변경된 데이터가 들어있는지 확인.
```
