# ğŸ› ï¸ Issue Log: Phase 1-1 (POST /signup) Implementation

## ğŸ“‹ ê°œìš”
- **ì‘ì—…**: íšŒì›ê°€ì… API (`POST /users`) ë° DB ì´ˆê¸° êµ¬ì¶•
- **ê¸°ê°„**: 2025.12.29
- **ì£¼ìš” ì„±ê³¼**:
  - ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì œê±° ë° **Squash Migration** ì ìš© (SSOT ì¤€ìˆ˜)
  - PostgreSQL Enum/Boolean íƒ€ì…ê³¼ Rust íƒ€ì… ê°„ì˜ ë§¤í•‘ ê·œì¹™ ì •ë¦½
  - íŠ¸ëœì­ì…˜ ê¸°ë°˜ì˜ ìœ ì € ìƒì„± + ë¡œê·¸ ê¸°ë¡ + ë¡œê·¸ì¸ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

---

## ğŸ› ë°œìƒ ì´ìŠˆ ë° í•´ê²° (Troubleshooting)

### 1. DB ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜ (Schema Mismatch)
- **ì¦ìƒ**: ì½”ë“œ ì‹¤í–‰ ì‹œ `users` í…Œì´ë¸”ì˜ ì»¬ëŸ¼(`user_check_email` ë“±)ì´ ì—†ê±°ë‚˜ íƒ€ì…ì´ ë‹¤ë¦„.
- **ì›ì¸**: ê¸°ì¡´ `migrations/` í´ë”ì˜ íŒŒì¼ë“¤ê³¼ ìµœì‹  ìŠ¤í™(`AMK_SCHEMA_PATCHED.sql`) ê°„ì˜ ë²„ì „ ì°¨ì´.
- **í•´ê²°**:
  - ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì „ì²´ ì‚­ì œ.
  - ìµœì‹  ìŠ¤í™ì„ ë°˜ì˜í•œ ë‹¨ì¼ íŒŒì¼ `init_full.sql` ìƒì„± (**Squash Migration**).
  - `sqlx database reset -y`ë¡œ DB ì™„ì „ ì´ˆê¸°í™” í›„ ì¬êµ¬ì¶•.

### 2. í…Œì´ë¸” ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ë¬¸ì œ (Case Sensitivity)
- **ì¦ìƒ**: `relation "users" does not exist` ì—ëŸ¬ ë°œìƒ.
- **ì›ì¸**: `init_full.sql`ì—ì„œ í…Œì´ë¸”ëª…ì„ ìŒë”°ì˜´í‘œ(`"USERS"`)ë¡œ ê°ì‹¸ ìƒì„±í•¨. PostgresëŠ” ìŒë”°ì˜´í‘œ ì‚¬ìš© ì‹œ ëŒ€ì†Œë¬¸ìë¥¼ ì—„ê²©íˆ êµ¬ë¶„í•¨(ëŒ€ë¬¸ìë¡œ ìƒì„±ë¨), ë°˜ë©´ Rust SQLxëŠ” ì†Œë¬¸ì(`users`)ë¡œ ì¿¼ë¦¬í•¨.
- **í•´ê²°**: ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼(`init_full.sql`)ì—ì„œ **ëª¨ë“  ìŒë”°ì˜´í‘œ(`"`) ì œê±°**í•˜ì—¬ Postgres í‘œì¤€(Case-insensitive)ì„ ë”°ë¥´ë„ë¡ ìˆ˜ì •.

### 3. ENUM íƒ€ì… Insert ì—ëŸ¬ (Type Casting)
- **ì¦ìƒ**: `column "user_language" is of type user_language_enum but expression is of type text`
- **ì›ì¸**: Rustì—ì„œ String ê°’ì„ ë°”ì¸ë”©(`$x`)í•´ì„œ ë³´ë‚¼ ë•Œ, PostgresëŠ” ì´ë¥¼ `TEXT`ë¡œ ì¸ì‹í•˜ì—¬ `ENUM` ì»¬ëŸ¼ì— ë„£ê¸°ë¥¼ ê±°ë¶€í•¨.
- **í•´ê²°**: ì¿¼ë¦¬ë¬¸ `VALUES` ì ˆì—ì„œ ëª…ì‹œì  í˜•ë³€í™˜ ì¶”ê°€.
  - ì˜ˆ: `$5` â†’ `$5::user_language_enum`

### 4. ENUM íƒ€ì… Select ì—ëŸ¬ (Decoding)
- **ì¦ìƒ**: `mismatched types; Rust type String is not compatible with SQL type user_language_enum`
- **ì›ì¸**: DBëŠ” `ENUM` íƒ€ì…ì„ ë°˜í™˜í•˜ëŠ”ë°, Rust DTO(`ProfileRes`)ëŠ” `String`ìœ¼ë¡œ ë°›ìœ¼ë ¤ í•¨.
- **í•´ê²°**: `RETURNING` ë˜ëŠ” `SELECT` ì ˆì—ì„œ `TEXT`ë¡œ í˜•ë³€í™˜.
  - ì˜ˆ: `user_language` â†’ `user_language::TEXT` (DTOê°€ Stringì¼ ê²½ìš°)
  - *ì£¼ì˜: DTOë„ Enumì¸ ê²½ìš°(`UserGender` ë“±)ëŠ” ë³€í™˜ ì—†ì´ ê·¸ëŒ€ë¡œ ë§µí•‘.*

### 5. Boolean vs Enum ì¶©ëŒ (`user_state`)
- **ì¦ìƒ**: `Rust type UserState is not compatible with SQL type BOOL`
- **ì›ì¸**: DB ìŠ¤í‚¤ë§ˆëŠ” `user_state`ë¥¼ `BOOLEAN`(`true/false`)ìœ¼ë¡œ ë³€ê²½í–ˆìœ¼ë‚˜, Rust ì½”ë“œëŠ” êµ¬ë²„ì „ `UserState` Enum(`On/Off`)ì„ ì‚¬ìš©.
- **í•´ê²°**:
  - `types.rs`: `UserState` Enum ì‚­ì œ.
  - `dto.rs`: `ProfileRes`ì˜ `user_state` íƒ€ì…ì„ `bool`ë¡œ ë³€ê²½.
  - `repo.rs`: ì¿¼ë¦¬ì—ì„œ ë¶ˆí•„ìš”í•œ ìºìŠ¤íŒ… ì œê±°.
  - `service.rs`: ì¡°ê±´ë¬¸ì„ `if !user.user_state`ë¡œ ìˆ˜ì •.

### 6. ë¡œê·¸ í…Œì´ë¸” Insert ì‹œ íƒ€ì… ë³€í™˜ ì˜¤ë¥˜
- **ì¦ìƒ**: `column "user_auth_log" is of type user_auth_enum but expression is of type text`
- **ì›ì¸**: `INSERT INTO users_log ... SELECT ... FROM users` êµ¬ë¬¸ ì‚¬ìš© ì‹œ, ì›ë³¸ í…Œì´ë¸”ì˜ `ENUM` ì»¬ëŸ¼ì„ `::text`ë¡œ ê°•ì œ ë³€í™˜í•˜ì—¬ `ENUM` ì»¬ëŸ¼ì— ë„£ìœ¼ë ¤ í•¨.
- **í•´ê²°**:
  - `create_user_log_tx` ë“±ì—ì„œ `ENUM` ë°”ì¸ë”© ì‹œ `::enum_type` ìºìŠ¤íŒ… ì¶”ê°€.
  - `insert_user_log_after_tx`ì—ì„œ `u.user_auth::text` ë“±ì˜ ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸ ë³€í™˜ ì œê±° (Enum to Enum ìœ ì§€).

### 7. Legacy ì»¬ëŸ¼ ì°¸ì¡° ì˜¤ë¥˜ (`login` í…Œì´ë¸”)
- **ì¦ìƒ**: `column "login_success" of relation "login" does not exist`
- **ì›ì¸**: `login` í…Œì´ë¸”ì€ 'í˜„ì¬ í™œì„±í™”ëœ ì„¸ì…˜'ë§Œ ë‹´ìœ¼ë¯€ë¡œ ìŠ¤í‚¤ë§ˆ ê°œí¸ ì‹œ `login_success` ì»¬ëŸ¼ì´ ì‚­ì œë˜ì—ˆìœ¼ë‚˜, ì½”ë“œëŠ” êµ¬ë²„ì „ ìŠ¤í‚¤ë§ˆë¥¼ ì°¸ì¡°í•¨.
- **í•´ê²°**:
  - `src/api/auth/repo.rs` ì „ì²´ ë¦¬íŒ©í† ë§.
  - `login_success` ì»¬ëŸ¼ ì œê±° ë° `NOT NULL` ì œì•½ ì¡°ê±´ì´ ìˆëŠ” ì»¬ëŸ¼(`login_asn` ë“±)ì— ê¸°ë³¸ê°’ ì¶”ê°€.

---

## ğŸ’¡ Key Takeaways (êµí›ˆ)
1. **SSOT(Single Source of Truth) ì¤€ìˆ˜**: DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë¿ë§Œ ì•„ë‹ˆë¼ `types.rs`, `dto.rs`, `repo.rs` 3ë°•ìê°€ ë™ì‹œì— ìˆ˜ì •ë˜ì–´ì•¼ í•œë‹¤.
2. **PostgreSQLì˜ ì—„ê²©í•¨**: SQLiteë‚˜ MySQLê³¼ ë‹¬ë¦¬ PostgresëŠ” `ENUM` íƒ€ì…ê³¼ `TEXT` íƒ€ì…ì„ ì—„ê²©íˆ êµ¬ë¶„í•˜ë¯€ë¡œ, ì¿¼ë¦¬ ì‘ì„± ì‹œ `::type` ìºìŠ¤íŒ…(Casting)ì— ìœ ì˜í•´ì•¼ í•œë‹¤.
3. **Squash Migrationì˜ íš¨ìš©**: ê°œë°œ ì´ˆê¸° ë‹¨ê³„ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ê¼¬ì˜€ì„ ë•ŒëŠ”, ì–µì§€ë¡œ ê³ ì¹˜ê¸°ë³´ë‹¤ **ê³¼ê°í•˜ê²Œ ì´ˆê¸°í™”(Reset & Squash)** í•˜ëŠ” ê²ƒì´ ê¸°ìˆ  ë¶€ì±„ë¥¼ ì¤„ì´ëŠ” ì§€ë¦„ê¸¸ì´ë‹¤.