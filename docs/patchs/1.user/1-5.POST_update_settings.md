# PATCH — Phase 1-5 Update Settings (POST /users/me/settings)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 1-5 `POST /users/me/settings` (내 설정 수정) 엔드포인트 구현.
- `users_setting` 테이블을 수정(또는 생성)하고, `users_log`에 활동을 기록.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.1-5] 참조.
- **Pattern**:
  - **Upsert**: 설정값이 없을 수 있으므로 `INSERT ... ON CONFLICT (user_id) DO UPDATE` 사용.
  - **Transaction**: `Upsert Settings` -> `Insert Log` (Atomic).
  - **Enum Casting**: `user_set_language`는 `::user_set_language_enum` 캐스팅 필수.
- **DTO**: `SettingsUpdateReq` (Phase 1-4에서 `SettingsRes`와 맞췄으므로 유사한 구조 권장).

CONTRACT (구현 명세):
- [HTTP] `POST /users/me/settings`
- [Auth] `AuthUser` 필수.
- [Logic]
  1. **Transaction Start**.
  2. `users_setting` Upsert 수행 (값이 들어온 필드만 변경, 없으면 기존값/Default 유지).
  3. `insert_user_log_after_tx` 호출 (Action: "update").
     * *Note*: 설정 변경도 유저 활동이므로 로그를 남기지만, `users_log`는 `users` 테이블의 스냅샷이므로 설정값 자체는 로그에 안 남을 수 있음(Audit 목적).
  4. **Transaction Commit**.
- [Response]
  - **200 OK**: 변경된 `SettingsRes`.

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/user/dto.rs`)**:
    - `SettingsUpdateReq` 구조체 정의.
    - 필드: `user_set_language` (Option<String>), `user_set_timezone` (Option<String>), `user_set_note_email` (Option<bool>), `user_set_note_push` (Option<bool>).
2.  **Repo (`src/api/user/repo.rs`)**:
    - `upsert_settings_tx` 함수 구현.
    - Query:
      ```sql
      INSERT INTO users_setting (...) VALUES ($1, $2::enum..., ...)
      ON CONFLICT (user_id) DO UPDATE SET
      user_set_language = COALESCE(EXCLUDED.user_set_language, users_setting.user_set_language),
      ...
      RETURNING ...
      ```
    - `::TEXT` 캐스팅하여 `SettingsRes`로 반환.
3.  **Service (`src/api/user/service.rs`)**:
    - `update_settings` 구현 (트랜잭션 관리).
4.  **Handler (`src/api/user/handler.rs`)**:
    - `update_settings` 핸들러 구현.
5.  **Router (`src/api/user/router.rs`)**:
    - Route 등록.

FILE PATCHES START
// src/api/user/dto.rs
// src/api/user/repo.rs
// src/api/user/service.rs
// src/api/user/handler.rs
// src/api/user/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인
TOKEN="<YOUR_ACCESS_TOKEN>"

# 2. 설정 수정 (Upsert 테스트)
curl -v -X POST http://localhost:3000/users/me/settings \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "user_set_language": "en",
    "user_set_note_email": true
  }'
```