# PATCH — Phase 1-1 Signup (POST /users)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5, Rust stable 1.89)를 돕는 **AI 코딩 에이전트**

OBJECTIVE:
- Phase 1-1 `POST /users` (회원가입) 엔드포인트를 구현.
- 사용자 정보 저장(USERS) + 로그 저장(USERS_LOG) + 토큰 발급까지 트랜잭션으로 처리.

CONTEXT (프로젝트 규칙 - SSOT 준수):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.1 Phase 1] 및 [1-1 시나리오] 참조.
- **Schema**: `USERS`, `USERS_LOG` 테이블 구조 준수 (`user_state`, `user_auth_enum` 등).
- **Scenarios (필수 구현)**:
  1. **성공 (201 Created)**:
     - 검증 통과 -> DB 트랜잭션(USERS Insert -> USERS_LOG Insert) -> 토큰 발급.
     - 응답: 201, `Location` 헤더, 안전한 유저 정보 반환.
  2. **실패 (400 Bad Request)**: 이메일 형식 오류, 필수 값 누락.
  3. **실패 (422 Unprocessable Entity)**: 도메인 제약 위반 (비밀번호 정책, 생년월일 범위 등).
  4. **실패 (409 Conflict)**: 이메일 중복.
  5. **실패 (429 Too Many Requests)**: 과도한 가입 시도 (Rate limit).

CONTRACT (구현 명세):
- [Phase] Phase 1-1 회원가입
- [HTTP] POST /users
- [Request] `SignupReq` (email, password, name, nickname, birth, gender, country, language 등)
- [Validation]
  - 이메일: `validator` 크레이트 사용.
  - 비밀번호: Argon2 해싱 필수 (DB 저장 시).
  - Enum: `user_gender_enum`, `user_language_enum` 등 유효성 검사.
- [DB Transaction]
  - 1. 이메일 중복 확인 (존재 시 409).
  - 2. `USERS` 테이블 Insert.
  - 3. `USERS_LOG` 테이블 Insert (action='signup').
  - 4. (성공 시) `commit`.
- [Auth] 가입 성공 시 **즉시 로그인 처리** (Access Token, Refresh Token 발급) 포함.
- [Response] `SignupRes` (user_id, email, name, user_state 등 **비밀번호 제외**).

PATCH RULES (엄격 준수):
1. **Full File Replacement**: `src/api/user/{dto.rs, handler.rs, service.rs, repo.rs, router.rs, mod.rs}` 수정 시 **전체 코드** 제공.
2. **Compile-Ready**: `cargo check` 즉시 통과 필수 (use 구문 누락 주의).
3. **Layered Architecture**: Handler(요청분해) -> Service(비즈니스로직/트랜잭션) -> Repo(DB쿼리) 구조 준수.

ACCEPTANCE CRITERIA:
- `cargo check` 통과 ✔
- `cargo clippy` (경고 0개) ✔
- 이메일 중복 시 409 에러 반환 확인 ✔
- 가입 성공 시 201 응답 및 토큰 발급 확인 ✔

FILE PATCHES START
// src/api/user/dto.rs
// src/api/user/handler.rs
// src/api/user/service.rs
// src/api/user/repo.rs
// src/api/user/router.rs
// src/api/user/mod.rs
// (필요 시) src/api/auth/token_utils.rs (토큰 발급 로직 재사용)
FILE PATCHES END

# cURL SMOKE
```bash
# 1. 성공 케이스 (새로운 이메일 사용)
curl -v -X POST http://localhost:3000/users \
  -H "Content-Type: application/json" \
  -d '{
    "email": "new_user_01@example.com",
    "password": "Password123!",
    "name": "홍길동",
    "nickname": "hong",
    "birth": "1990-01-01",
    "gender": "male",
    "country": "KR",
    "language": "ko"
  }'

# 2. 실패 케이스 (중복 이메일 - 위 명령어를 한번 더 실행)
# Expected: 409 Conflict

# 3. 실패 케이스 (잘못된 이메일 형식)
curl -v -X POST http://localhost:3000/users \
  -H "Content-Type: application/json" \
  -d '{ "email": "not-an-email", "password": "123" }'
```