# 📝 Dev Notes: Phase 1-5 Implementation (POST /users/me/settings)

## 📋 개요
- **작업**: 내 설정 수정 API (`POST /users/me/settings`)
- **기간**: 2025.12.30
- **성격**: Upsert(Create or Update) 패턴 구현 및 트랜잭션 로깅

---

## 🐛 발생 이슈 및 해결 (Troubleshooting)

### 1. OpenAPI 매크로 참조 불일치 (`src/docs.rs`)
- **상황**: `src/docs.rs`에서 핸들러를 등록할 때 `crate::api::user::handler::update_users_setting`으로 적었으나, 실제 구현된 핸들러 함수명은 `update_settings`였음.
- **에러**: `failed to resolve: could not find __path_update_users_setting` (컴파일 에러).
- **해결**: `src/docs.rs`의 경로를 실제 함수명인 `update_settings`로 수정.
- **교훈**: `utoipa` 매크로는 핸들러 함수의 경로를 정확히 찾아야 하므로, 함수명을 변경하거나 등록할 때 **오타 검증**이 필수적임.

---

## 🔑 확립된 핵심 개발 패턴 (Key Patterns)

### 1. Upsert 패턴 (INSERT ... ON CONFLICT)
- **목적**: `users_setting` 테이블에 데이터가 **없으면 생성(Insert)**하고, **있으면 수정(Update)**해야 함.
- **구현**:
  ```sql
  INSERT INTO users_setting (...) VALUES (...)
  ON CONFLICT (user_id) DO UPDATE SET
      user_set_language = COALESCE(EXCLUDED.user_set_language, users_setting.user_set_language),
      ...
  ```
- **장점**: '조회 후 분기(Select -> if -> Insert/Update)' 로직보다 **DB 쿼리 1번으로 원자적(Atomic) 처리**가 가능하며 동시성 문제도 예방됨.

### 2. 선택적 업데이트 (Selective Update via COALESCE)
- **패턴**: API 요청(`SettingsUpdateReq`)에서 `None`으로 들어온 필드는 변경하지 않고 유지.
- **SQL 기법**: `COALESCE($param, column_name)`
  - `$param`이 값이 있으면 새 값으로 덮어씀.
  - `$param`이 `NULL`이면 기존 DB 컬럼 값을 그대로 유지.

---

## ✅ 결론
- **사용자 기본 기능(CRUD) 완성**: 가입, 조회, 정보 수정, 설정 조회/수정에 이르는 핵심 사이클이 모두 구현됨.
- **다음 단계**: Phase 1의 마지막 관문인 **회원 탈퇴(Withdrawal)** 구현으로 이동. (Soft Delete & Anonymization)