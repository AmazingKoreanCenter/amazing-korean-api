# 📝 Dev Notes: Phase 1-2 Implementation (GET /users/me)

## 📋 개요
- **작업**: 내 정보 조회 API (`GET /users/me`)
- **기간**: 2025.12.29
- **성격**: 인증 미들웨어 연동 및 조회 패턴 확립 (Standardization)

---

## 🔑 확립된 핵심 개발 패턴 (Key Patterns)

### 1. Enum 타입 조회 패턴 (Repo Layer)
- **상황**: DB의 `ENUM` 컬럼을 Rust의 `String` 필드(DTO)로 매핑해야 함.
- **해결**: `SELECT` 쿼리 작성 시 **`::TEXT` 캐스팅**을 명시적으로 사용.
- **코드 예시**:
  ```rust
  // src/api/user/repo.rs
  SELECT 
      user_language::TEXT as language, // (O) DB Enum -> Rust String 변환 성공
      user_gender,                     // (O) Rust 쪽도 Enum이면 캐스팅 불필요
      ...
  ```
- **교훈**: DTO 필드 타입이 `String`이면 무조건 `::TEXT`를 붙이고, `Enum`이면 그대로 둔다.

### 2. 인증 사용자 추출 패턴 (Handler Layer)
- **상황**: HTTP 헤더에서 토큰을 파싱하고 검증하는 로직 중복 제거 필요.
- **해결**: `Extension` 대신 **`AuthUser` Extractor** 사용.
- **장점**: 핸들러 진입 시 이미 검증이 완료된 `user_id`, `email` 등을 안전하게 사용할 수 있음.
- **코드 예시**:
  ```rust
  // src/api/user/handler.rs
  pub async fn get_me(
      State(st): State<AppState>,
      AuthUser(auth_user): AuthUser, // 미들웨어 통과 후 자동 주입
  ) -> AppResult<Json<ProfileRes>> {
      // auth_user.sub (user_id) 사용
  }
  ```

### 3. 비활성 사용자 처리 정책 (Service Layer)
- **상황**: 토큰은 유효하지만, `user_state`가 `false`(탈퇴/차단)인 경우의 응답 코드.
- **결정**: `403 Forbidden` 대신 **`404 Not Found`** 반환.
- **이유**: 보안상 탈퇴한 회원의 존재 여부를 노출하지 않거나, "존재하지 않는 리소스"로 취급하는 것이 RESTful 설계에 더 부합함 (AMK 스펙 준수).
- **코드 예시**:
  ```rust
  // src/api/user/service.rs
  if !user.user_state {
      return Err(AppError::NotFound);
  }
  ```

---

## ✅ 결론
- Phase 1-1에서 겪은 DB 타입 이슈들이 Phase 1-2에서는 선제적으로 방어됨.
- **"Repo의 캐스팅 규칙"**과 **"Handler의 인증 추출 방식"**이 표준화되었으므로, 이후 `UPDATE`, `DELETE` 구현 속도가 빨라질 것으로 예상됨.