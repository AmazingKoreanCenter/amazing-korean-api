# 📝 Phase 6-4 Admin Update User - Issue & Troubleshooting Log

## 1. 데이터 타입 설계 및 변환 (Data Type Design & Conversion)

### 🔴 JSON vs Rust 타입 불일치 (Deserialization Error)
* **증상:** `invalid type: string "on", expected a boolean`
* **원인:** 클라이언트는 `"user_state": "on"`(문자열)을 보냈으나, Rust DTO는 `Option<bool>`을 기대함.
* **1차 시도:** DTO를 `Option<String>`으로 변경하여 `"on"`을 받도록 수정했으나, 후속 문제 발생.

### 🔴 Rust 소유권 및 비교 에러 (Compiler Error)
* **증상 1 (E0507):** `cannot move out of ...`
    * 원인: `Option<String>`은 `Copy` 트레이트가 없어 `.bind(req.user_state)` 시 소유권 이동 발생. `.as_ref()`나 `.clone()`이 필요했음.
* **증상 2 (E0277):** `can't compare String with bool`
    * 원인: 서비스 로직에서 요청값(`String`)과 DB 저장값(`bool`)을 직접 비교하려다 타입 불일치 발생.

### 🔴 DB 타입 불일치 (PostgreSQL Strictness)
* **증상:** `COALESCE types text and boolean cannot be matched`
* **원인:** SQL 쿼리에서 `COALESCE($9, user_state)`를 실행할 때, `$9`는 텍스트("on")이고 `user_state` 컬럼은 불리언이라 Postgres가 거부함.

---

## 2. 최종 해결책: Native Boolean 전략 (Refactoring)

복잡한 변환 로직(String ↔ Bool)을 유지하는 대신, **API 설계를 표준에 맞게 변경**하는 결단을 내림.

* **결정:** `"on"/"off"` 문자열 대신 **`true/false` (JSON Boolean)** 를 직접 사용.
* **수정 사항:**
    1.  **DTO:** `Option<String>` → `Option<bool>` 원복.
    2.  **Repo:** 별도의 변환 없이 `.bind(req.user_state)` 그대로 바인딩 (bool은 `Copy` 가능하므로 소유권 문제 없음).
    3.  **SQL:** `COALESCE`와 `CASE WHEN` 문이 자연스럽게 Boolean 타입을 처리.
* **성과:** 불필요한 파싱 로직 제거, DB 에러 해결, 코드 가독성 향상.

---

## 3. 핵심 배움 (Key Takeaways)
1.  **DB 타입 존중:** DB 컬럼이 `BOOLEAN`이면, API 요청도 가급적 `Boolean`으로 받는 것이 정신 건강에 좋다.
2.  **명시적 타입:** `COALESCE` 함수 사용 시 두 인자의 타입은 반드시 같아야 한다.