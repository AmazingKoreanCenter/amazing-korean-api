# Phase 6-32 Admin List Lessons (GET /admin/lessons)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `GET /admin/lessons` 엔드포인트를 구현하여 수업(Lesson) 목록을 조회합니다.
- **기능**: 페이지네이션, 검색(`q`), 정렬(`sort`, `order`)을 지원해야 합니다.
- **참조 로직**: `admin_list_studies` (Phase 6-15)의 구현 패턴(QueryBuilder, Logging)을 `LESSON` 테이블에 맞게 적용합니다.

CONTEXT (SSOT & Rules):
1.  **테이블 구조 (Schema)**:
    - Table: `LESSON`
    - Columns: `lesson_id`, `updated_by_user_id`, `lesson_idx` (Unique Code), `lesson_title`, `lesson_subtitle`, `lesson_description`, timestamps.
    - Note: `LESSON_ITEM` 테이블은 상세 조회(`GET /:id`)에서 다룰 예정이므로, 이번 목록 조회에서는 `LESSON` 테이블 위주로 조회합니다.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema)]` (Response는 `FromRow` 필수).
    - **`LessonListReq`**:
        - `page`: `Option<u64>` (default 1).
        - `size`: `Option<u64>` (default 20).
        - `q`: `Option<String>` (검색어 - title, subtitle, idx 대상).
        - `sort`: `Option<String>` (정렬 필드 - default "created_at").
        - `order`: `Option<String>` (asc/desc - default "desc").
    - **`AdminLessonRes`**:
        - `LESSON` 테이블의 모든 컬럼 매핑.
    - **`AdminLessonListRes`**:
        - `list`: `Vec<AdminLessonRes>`.
        - `total`, `page`, `size`, `total_pages`.

3.  **로직 흐름 (Service)**:
    - 1) **권한 체크**: RBAC (Admin/Manager/Hymn).
    - 2) **유효성 검사**: `req.validate()`.
    - 3) **Audit Log (필수)**: `user::repo::create_audit_log` 호출.
        - Action: `"LIST_LESSONS"`
        - Target Table: `Some("LESSON")` (명시 필수).
        - Details: Request 파라미터 전체.
        - IP 주소 변환 적용.
    - 4) **데이터 조회 (Repo)**:
        - `sqlx::QueryBuilder`를 사용하여 동적 쿼리 구성.
        - **검색(`q`)**: `lesson_title`, `lesson_subtitle`, `lesson_idx` 컬럼에 대해 `ILIKE` 검색 (`OR` 조건).
        - **정렬(`sort`)**: 허용된 필드(`lesson_title`, `lesson_idx`, `lesson_created_at` 등)인지 검증 후 `ORDER BY` 적용.
        - **페이징**: `LIMIT`, `OFFSET` 적용.
    - 5) **결과 반환**: 200 OK.

4.  **기술적 유의사항**:
    - **QueryBuilder**: `admin_list_studies`에서 검증된 방식을 그대로 사용하여 안정성을 확보하세요.
    - **SQL Injection 방지**: 정렬 필드(`sort`)는 반드시 화이트리스트 검사(match 구문 등)를 거쳐야 합니다.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/lesson/dto.rs`)**:
    - `LessonListReq`, `AdminLessonRes`, `AdminLessonListRes` 정의.
    - (폴더가 없다면 `src/api/admin/lesson` 모듈 생성 및 `mod.rs` 등록 필요).

2.  **Repo (`src/api/admin/lesson/repo.rs`)**:
    - `admin_list_lessons`: 동적 검색/정렬/페이징 쿼리 구현.

3.  **Service (`src/api/admin/lesson/service.rs`)**:
    - `admin_list_lessons`: 로깅 및 리포지토리 호출.

4.  **Handler (`src/api/admin/lesson/handler.rs`)**:
    - 핸들러 구현.
    - tag : admin_lesson

5.  **Router & Docs**:
    - `src/api/admin/lesson/router.rs` 생성 및 `src/api/admin/mod.rs`에 등록.
    - OpenAPI 문서 업데이트.

FILE PATCHES START
// src/api/admin/mod.rs
// src/api/admin/lesson/mod.rs
// src/api/admin/lesson/dto.rs
// src/api/admin/lesson/repo.rs
// src/api/admin/lesson/service.rs
// src/api/admin/lesson/handler.rs
// src/api/admin/lesson/router.rs
// src/docs.rs
FILE PATCHES END