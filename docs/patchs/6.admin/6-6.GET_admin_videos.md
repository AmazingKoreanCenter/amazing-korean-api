# GET â€” Phase 6-6 Admin List Videos (GET /admin/videos)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `GET /admin/videos` to retrieve a paginated list of videos.
- Support **Search (`q`)**, **Sorting (`sort`, `order`)**, and **Pagination (`page`, `size`)**.
- **RBAC**: Only `Admin` or `Manager` (or `Hymn`) can access.
- **Logging**: Record `admin_action_log` (action="LIST_VIDEOS").

CONTEXT (SSOT & Rules):
1.  **Naming Convention**:
    - Path: `src/api/admin/video/...` (Create directory if not exists).
    - Handler: `admin_list_videos`
    - Service: `admin_list_videos`
    - Repo: `admin_list_videos` (Use `QueryBuilder` for dynamic SQL).

2.  **DTO Strategy**:
    - `AdminVideoListReq`: Query parameters (`page`, `size`, `q`, `sort`, `order`).
    - `AdminVideoListRes`: Response struct containing `items: Vec<AdminVideoRes>` and `pagination: Pagination`.
    - `AdminVideoRes`: Fields mapping to `videos` table (id, title, url, description, views, is_public, created_at, updated_at).

3.  **Search & Sort Logic**:
    - **Search (`q`)**: `ILIKE` match on `video_title` (and optionally `video_description`).
    - **Sort (`sort`)**: Whitelist allowed fields: `created_at` (default), `views`, `title`.
    - **Order (`order`)**: `asc` or `desc` (default).

4.  **SQL Implementation (Crucial)**:
    - Use **`sqlx::QueryBuilder`** to construct the query dynamically.
    - **First Query**: Count total rows matching the search criteria.
    - **Second Query**: Fetch data with `LIMIT` and `OFFSET`.
    - **Safe Interpolation**: Use `.push_bind()` for values to prevent SQL Injection.

5.  **Service Logic**:
    - Check Actor RBAC.
    - Call Repo.
    - Log Action (`create_audit_log` with summary).
    - Return wrapped `AppResult`.

IMPLEMENTATION STEPS:

1.  **Module Setup**:
    - Create `src/api/admin/video/mod.rs` and register it in `src/api/admin/mod.rs`.
    - Define `dto.rs`, `repo.rs`, `service.rs`, `handler.rs`, `router.rs`.

2.  **DTO (`src/api/admin/video/dto.rs`)**:
    - Define `AdminVideoListReq` (derive `Deserialize`, `Validate`, `IntoParams`).
    - Define `AdminVideoRes` (derive `Serialize`, `ToSchema`).
    - Define `AdminVideoListRes`.

3.  **Repo (`src/api/admin/video/repo.rs`)**:
    - Implement `admin_list_videos`.
    - Use `QueryBuilder` for efficient dynamic filtering.

4.  **Service (`src/api/admin/video/service.rs`)**:
    - Implement business logic & logging.

5.  **Handler & Router**:
    - Register `GET /admin/videos`.

FILE PATCHES START
// src/api/admin/mod.rs (Add `pub mod video;`)
// src/api/admin/video/mod.rs
// src/api/admin/video/dto.rs
// src/api/admin/video/repo.rs
// src/api/admin/video/service.rs
// src/api/admin/video/handler.rs
// src/api/admin/video/router.rs
// src/router.rs (Register admin video routes)
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. List Videos (Default)
curl -v "http://localhost:3000/admin/videos" \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# 2. Search & Sort
curl -v "http://localhost:3000/admin/videos?q=korean&sort=views&order=desc&page=1&size=5" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```