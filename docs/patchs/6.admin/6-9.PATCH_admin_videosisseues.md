# 📝 Phase 6-9 Admin Update Video - Issue & Troubleshooting Log

## 1. 데이터베이스 및 동적 쿼리 (Database & Dynamic Query)

### 🔴 이슈 1: SQL 구문 오류 (Syntax Error)
* **에러:** `syntax error at or near ","`
* **원인:** `sqlx::QueryBuilder`의 `separated(", ")` 기능을 사용할 때, 조건부(`if let Some`) 로직과 맞물려 콤마가 **맨 앞**에 붙거나 **잘못된 위치**에 생성됨.
* **해결:** `separated` 기능 대신, **`bool is_first` 플래그**를 사용하여 콤마 삽입 시점을 수동으로 정밀하게 제어하는 방식으로 변경 ("Manual Comma Control").

### 🔴 이슈 2: 다중 행 반환 가능성 (Aggregation Issue)
* **지적:** Codex Review - `potential multiple-row error in final SELECT`
* **원인:** 수정 후 데이터를 반환할 때 `GROUP BY` 절에 `video_tag`의 컬럼들(`title`, `subtitle`)을 포함시킴. 만약 1개의 비디오에 태그 데이터가 여러 개 연결된 경우(현재 로직상 1:1이지만 확장성을 고려했을 때), `fetch_one`이 에러를 뱉을 수 있음.
* **해결:** `GROUP BY` 기준을 `video_id`로 한정하고, 태그 컬럼들은 **`MAX()` 집계 함수**로 감싸서 무조건 1개의 Row만 반환되도록 보장.

### 🔴 이슈 3: Enum 타입 캐스팅
* **현상:** 업데이트 시 `video_access` 컬럼 타입 불일치.
* **해결:** 쿼리 빌더 내에서 값 바인딩 후 `builder.push("::video_access_enum")`을 명시적으로 추가하여 PostgreSQL Enum 타입으로 캐스팅.

---

## 2. 요청 처리 및 도구 (Request Handling & Tools)

### ⚠️ 이슈 4: cURL 요청 형식 (JSON Parsing Error)
* **에러:** `400 Bad Request: expected value at line 1 column 1`
* **원인:** 터미널에서 cURL 사용 시, JSON 데이터의 **따옴표 escaping**이나 줄바꿈 처리가 잘못되어 서버가 빈 본문(Body)으로 인식함.
* **해결:** JSON 데이터를 한 줄로 만들고, 홑따옴표(`'`)로 정확히 감싸서 전송하거나 Postman/Swagger 사용 권장.

---

## 3. 문서화 (Documentation)

### 📝 이슈 5: OpenAPI 문서 누락
* **현상:** 기능은 구현했으나 `docs.rs`에 업데이트 반영을 깜빡함.
* **해결:** `VideoUpdateReq` 스키마와 `PATCH` 경로를 `docs.rs`에 추가하여 Swagger UI와 코드의 동기화 완료.

---

## 4. 핵심 배움 (Key Takeaways)

1.  **QueryBuilder의 한계 인정:** 복잡한 조건부 업데이트에서는 라이브러리의 자동 기능(`separated`)보다, 투박하더라도 **수동 제어(`if !is_first`)**가 훨씬 안전하고 확실하다.
2.  **DTO 설계의 중요성:** `UPDATE` 요청용 DTO는 모든 필드를 `Option<T>`로 선언해야 하며, 필드명을 DB 컬럼명과 일치시키면 매핑 실수를 줄일 수 있다.
3.  **조회 쿼리의 방어적 코딩:** `fetch_one`을 쓸 때는 데이터가 반드시 1개만 나온다는 보장(Unique Key 또는 Aggregation)이 쿼리 레벨에서 되어 있어야 한다.