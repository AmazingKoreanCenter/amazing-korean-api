# Phase 6-15 Admin Create Study (POST /admin/studies)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `POST /admin/studies` to create a new study session metadata.
- **RBAC**: Admin/Manager/Hymn only.
- **Transaction**: Ensure `INSERT INTO STUDY` and `INSERT INTO ADMIN_STUDY_LOG` happen atomically.
- **Logging**: Implement and use a dedicated `repo::create_study_log` for the `ADMIN_STUDY_LOG` table.

CONTEXT (SSOT & Rules):
1.  **테이블 및 데이터 (Schema)**:
    - **`STUDY`**: 메인 테이블.
        - `study_idx`: 고유값(Unique). 중복 시 **409 Conflict**.
        - `study_program`, `study_state`: Postgres Enum 타입.
        - `updated_by_user_id`: 생성 요청을 보낸 관리자 ID.
    - **`ADMIN_STUDY_LOG`**: 변경 이력 저장소.
        - `admin_pick_study_id`: 생성된 Study ID.
        - `admin_study_action`: 'CREATE_STUDY'.
        - `admin_study_after`: 생성된 데이터(JSON).

2.  **DTO 설계**:
    - **`StudyCreateReq`**:
        - `study_idx`: 필수, String, 최소 2자.
        - `study_title`, `study_subtitle`, `study_description`: Optional String.
        - `study_program`: Optional Enum (Default: 'tbc').
        - `study_state`: Optional Enum (Default: 'ready').
    - **`AdminStudyRes`**: 기존 DTO 재사용.

3.  **로직 흐름 (Service)**:
    - 1) RBAC 체크.
    - 2) DTO 검증 (`validate()`).
    - 3) `study_idx` 중복 체크 (`repo::exists_study_idx`) -> 중복 시 `AppError::Conflict`.
    - 4) 트랜잭션 시작 (`pool.begin()`).
    - 5) `repo::admin_create_study(tx, ...)` 호출 -> `STUDY` 테이블 INSERT.
    - 6) `repo::create_study_log(tx, ...)` 호출 -> `ADMIN_STUDY_LOG` 테이블 INSERT.
    - 7) 트랜잭션 커밋 (`tx.commit()`).

4.  **구현 상세 (Technical Detail)**:
    - **Repo (`repo.rs`)**:
        - `exists_study_idx`: 중복 확인용.
        - `admin_create_study`: `RETURNING` 절을 사용하여 생성된 데이터를 바로 반환.
        - `create_study_log`:
            - 인자: `tx`, `actor_id`, `action`, `target_study_id`, `target_task_id` (Option), `before` (Option Json), `after` (Option Json).
            - `ADMIN_STUDY_LOG` 테이블에 INSERT.
    - **Service (`service.rs`)**:
        - `IpAddr` 변환 로직을 사용하여 로그 함수에 정확한 타입 전달.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - Define `StudyCreateReq`.

2.  **Repo (`src/api/admin/study/repo.rs`)**:
    - Implement `exists_study_idx`.
    - Implement `admin_create_study`.
    - Implement `create_study_log`.

3.  **Service (`src/api/admin/study/service.rs`)**:
    - Implement `admin_create_study`.
    - Handle Transaction and Logic.

4.  **Handler (`src/api/admin/study/handler.rs`)**:
    - Implement `admin_create_study` handler.
    - Status: 201 Created.

5.  **Router & Docs**:
    - Register route `POST /`.
    - Update OpenAPI docs.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/repo.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END