# Phase 6-17 Admin Update Study (PATCH /admin/studies/{id})

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/studies/{id}` 엔드포인트를 구현하여 학습 문제 정보를 수정합니다.
- **핵심 패턴**: `src/api/admin/video/repo.rs`의 `admin_update_video`와 유사하게 **동적 쿼리(`QueryBuilder`)**를 사용하여 요청된 필드만 수정해야 합니다.

CONTEXT (SSOT & Rules):
1.  **참조 로직 (Reference)**:
    - **동적 쿼리**: `admin_update_video`에서 사용한 `QueryBuilder` 패턴(쉼표 처리 포함)을 그대로 사용하세요.
    - **로그 처리**: `admin_update_user`처럼 **수정 전 데이터(`before`)**를 먼저 조회(SELECT)한 뒤 로그에 저장해야 합니다.

2.  **DTO 설계 (`StudyUpdateReq`)**:
    - 모든 필드는 `Option<T>`이어야 합니다 (Partial Update).
    - 대상 필드: `study_idx`, `study_state`, `study_program`, `study_title`, `study_subtitle`, `study_description`.
    - `study_idx`가 변경되는 경우, 다른 Study와 중복되지 않는지 검사해야 합니다.

3.  **로직 흐름 (Service)**:
    - 1) **권한 체크**: RBAC 확인.
    - 2) **데이터 조회**: `study_id`로 현재 데이터를 조회합니다 (로그의 `before` 데이터 용도). 데이터가 없으면 `404 Not Found`.
    - 3) **중복 체크**: 만약 요청에 `study_idx`가 포함되어 있고, 기존 값과 다르다면 `repo::exists_study_idx`로 중복 여부를 확인합니다. (본인 ID 제외 로직 필요 혹은 쿼리에서 처리)
    - 4) **트랜잭션 시작**: `pool.begin()`.
    - 5) **업데이트 수행**: `repo::admin_update_study` 호출. (`updated_by_user_id`와 `study_updated_at` 갱신 필수).
    - 6) **로그 기록**: `repo::create_study_log` 호출.
        - `action`: "UPDATE_STUDY"
        - `before`: 조회했던 기존 데이터(JSON).
        - `after`: 업데이트 요청 데이터(JSON).
    - 7) **커밋**: 트랜잭션 종료.

4.  **기술적 제약 사항**:
    - `QueryBuilder` 사용 시 `push_bind` 순서와 쉼표(`,`) 처리에 유의하세요.
    - `IpAddr` 타입 변환은 Phase 6-15, 6-16과 동일하게 유지하세요.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `StudyUpdateReq` 구조체 정의.

2.  **Repo (`src/api/admin/study/repo.rs`)**:
    - `find_study_by_id`: 업데이트 전 데이터 조회용 (기존에 없다면 추가).
    - `admin_update_study`: 동적 업데이트 쿼리 구현. `updated_by_user_id`도 함께 업데이트.

3.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_update_study` 함수 구현.
    - `Before` 데이터 조회 -> 중복 검사 -> 트랜잭션 -> 업데이트 -> 로그 -> 커밋 순서 준수.

4.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현. (성공 시 200 OK와 함께 변경된 데이터 반환).

5.  **Router & Docs**:
    - 라우터 등록 및 OpenAPI 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/repo.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END