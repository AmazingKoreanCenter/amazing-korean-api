# PATCH â€” Phase 6-5 Admin Bulk Update Users (PATCH /admin/users/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `PATCH /admin/users/bulk` for updating multiple users at once.
- **Partial Success Strategy**: Process each item independently. Failures (e.g., RBAC violation, Email conflict) should not stop other updates.
- **Status Codes**:
  - All Success: **200 OK** (or 204 if no content returned, but we usually return summary) -> Use **200 OK**.
  - Partial Success / All Failure: **207 Multi-Status**.

CONTEXT (SSOT & Rules):
1.  **Naming Convention**:
    - Handler: `admin_update_users_bulk`
    - Service: `admin_update_users_bulk`
    - Repo: Reuse existing `admin_update_user` (Iterate in Service).

2.  **DTO Requirements (Crucial for Validation)**:
    - New DTO `AdminBulkUpdateItemReq`: Extends `AdminUpdateUserReq` but MUST include `id` (target user id).
    - `AdminBulkUpdateReq`: Contains `items: Vec<AdminBulkUpdateItemReq>`.
    - **MUST implement `Serialize` and use `#[validate(nested)]`** on the vector field to avoid validation errors.
    - Fields like `user_state` MUST be `Option<bool>` (native boolean).

3.  **Service Logic (Iterative)**:
    - Check Actor RBAC (Manager/Admin).
    - Loop through items:
      1.  **Start TX** (Independent per item).
      2.  Fetch Target User (Check existence).
      3.  **Check Target RBAC**: Manager cannot update Admin/Hymn.
      4.  **Check Email Duplication**: If email is changing.
      5.  Call `repo::admin_update_user`.
      6.  Call `repo::create_history_log`.
      7.  Commit TX.
      8.  Record Result (Success/Error).
    - Log Audit (`create_audit_log`) with summary.
    - Return 200 or 207.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/user/dto.rs`)**:
    - `AdminBulkUpdateItemReq`: Struct with `id: i64` + flatten or copy fields from `AdminUpdateUserReq`.
    - `AdminBulkUpdateReq`: `items` with `#[validate(nested)]`.
    - Ensure `Serialize` is derived.

2.  **Service (`src/api/admin/user/service.rs`)**:
    - Implement `admin_update_users_bulk`.
    - Reuse `admin_update_user` logic (logic extraction might be needed to avoid code duplication between single update and bulk update loop, OR just call the repo method directly handling RBAC inside the loop).

3.  **Handler (`src/api/admin/user/handler.rs`)**:
    - `admin_update_users_bulk`.

4.  **Router & Docs**:
    - Register route `PATCH /admin/users/bulk`.
    - Update `src/docs.rs` with new DTOs.

FILE PATCHES START
// src/api/admin/user/dto.rs
// src/api/admin/user/service.rs
// src/api/admin/user/handler.rs
// src/api/admin/user/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# Mixed Case (207 Expected)
# Item 1: Success (Change Nickname)
# Item 2: Fail (RBAC - Manager tries to update Admin, or Email Conflict)
curl -v -X PATCH "http://localhost:3000/admin/users/bulk" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      { "id": 101, "nickname": "BulkUpd1", "user_state": true },
      { "id": 102, "email": "existing@example.com" }
    ]
  }'
```