# PATCH â€” Phase 6-12 Admin Bulk Update Video Tags (PATCH /admin/videos/bulk/tags)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `PATCH /admin/videos/bulk/tags` to update **only tag information** for multiple videos in a single request.
- **Partial Success (HTTP 207)**:
    - If some items succeed and others fail, return **207 Multi-Status**.
    - If all succeed, return **200 OK**.
- **Reusability**:
    - Reuse `repo::admin_update_video` (Phase 6-9) for the actual DB update.
    - Reuse the loop/transaction logic pattern from `service::admin_bulk_update_videos` (Phase 6-10).
- **RBAC**: Admin/Manager/Hymn only.
- **Logging**: Record a single `admin_action_log` (action="BULK_UPDATE_VIDEO_TAG").

CONTEXT (SSOT & Rules):
1.  **Schema & Relationships**:
    - We are updating `VIDEO_TAG` fields via `VIDEO_TAG_MAP`.
    - `VIDEO` fields (url, access, idx) MUST NOT be changed, except `updated_at`.

2.  **DTO Strategy**:
    - **Request**: `VideoTagBulkUpdateReq` containing `items: Vec<VideoTagBulkUpdateItem>`.
    - **Item Structure (`VideoTagBulkUpdateItem`)**:
        - `id` (i64, required).
        - `video_tag_title`, `video_tag_subtitle`, `video_tag_key` (Optional).
    - **Service Logic**:
        - Iterate `req.items`.
        - For each item:
            1. Start Transaction (`pool.begin()`).
            2. Convert `VideoTagBulkUpdateItem` -> `VideoUpdateReq`.
               - Set `video_url_vimeo`, `video_access`, `video_idx` to `None`.
               - Set tag fields from the item.
            3. Call `repo::admin_update_video(tx, id, converted_req)`.
            4. Commit or Rollback based on result.
            5. Collect result (Success/Failure).

3.  **Response**:
    - Reuse `VideoBulkUpdateRes` (Summary + List of results).

4.  **Documentation**:
    - Register new schemas and path in `src/docs.rs`.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/video/dto.rs`)**:
    - Define `VideoTagBulkUpdateItem` (derive Validate, ToSchema).
    - Define `VideoTagBulkUpdateReq`.

2.  **Service (`src/api/admin/video/service.rs`)**:
    - Implement `admin_bulk_update_video_tags`.
    - Apply the "Loop + Transaction per item + DTO Conversion" pattern.

3.  **Handler (`src/api/admin/video/handler.rs`)**:
    - Implement `admin_bulk_update_video_tags`.
    - Return 200 or 207.

4.  **Router (`src/api/admin/video/router.rs`)**:
    - Register `PATCH /bulk/tags`.

5.  **Docs (`src/docs.rs`)**:
    - Register schemas and path.

FILE PATCHES START
// src/api/admin/video/dto.rs
// src/api/admin/video/service.rs
// src/api/admin/video/handler.rs
// src/api/admin/video/router.rs
// src/docs.rs
FILE PATCHES END

# Request Body Example
```json
{
  "items": [
    {
      "id": 1,
      "video_tag_title": "Bulk Tag Update 1",
      "video_tag_key": "tag_bulk_1"
    },
    {
      "id": 2,
      "video_tag_subtitle": "Only subtitle updated here"
    }
  ]
}
```