# Phase 6-34 Admin Bulk Create Lessons (POST /admin/lessons/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `POST /admin/lessons/bulk` 엔드포인트를 구현하여 여러 개의 수업(Lesson)을 한 번에 생성합니다.
- **핵심 패턴**: `admin_bulk_create_task_explains` (Phase 6-26)의 **"Loop + Individual Transaction (부분 성공)"** 패턴을 사용하여, 요청된 항목들을 순차적으로 처리하고 결과를 집계합니다.

CONTEXT (SSOT & Rules):
1.  **로직 흐름 (Service)**:
    - 1) **API Log**: `user::repo::create_audit_log` 호출.
        - Action: `"BULK_CREATE_LESSONS"`
        - Target Table: `Some("LESSON")` (명시 필수).
        - Details: `{"count": items.len()}`.
    - 2) **Loop Processing**:
        - 각 아이템마다 **개별 트랜잭션**(`pool.begin()`)을 시작합니다.
        - **Validation (Duplicate)**: `repo::exists_lesson_idx` (트랜잭션용 버전 필요) 호출.
            - `lesson_idx`가 이미 존재하면 `AppError::Conflict` 처리.
        - **Insert**: `repo::create_lesson` (트랜잭션용 버전) 호출.
            - `updated_by_user_id`는 관리자 ID 주입.
        - **Data Log**: `repo::create_lesson_log` (트랜잭션용 버전) 호출.
            - Action: `"create"` (**소문자 필수**).
            - Target ID: `lesson_id`.
            - After: 생성된 데이터.
            - `pick_item_seq`, `video_id`, `task_id`는 `None`.
        - **Commit**: 트랜잭션 종료.
        - **Result Collection**: 성공 시 `lesson_idx`+`id`, 실패 시 `error` 메시지 수집.
    - 3) **Response**: 실패가 0건이면 `201 Created`, 1건이라도 있으면 `207 Multi-Status`.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`LessonBulkCreateReq`**:
        - `items`: `Vec<LessonCreateItem>` (최대 100개 제한 권장).
    - **`LessonCreateItem`**:
        - `lesson_idx`: `String` (필수, Unique).
        - `lesson_title`: `String` (필수).
        - `lesson_subtitle`: `Option<String>`.
        - `lesson_description`: `Option<String>`.
    - **`LessonBulkCreateRes`**: 성공/실패 카운트 및 결과 리스트.

3.  **기술적 유의사항**:
    - **Repo 리팩토링**: 기존 `create_lesson`이나 `exists_lesson_idx`가 `&PgPool`만 받도록 되어 있다면, `&mut Transaction`도 받을 수 있도록 분리하거나 `Executor` 트레이트를 활용하세요. (보통 `_tx` 접미사 함수를 만드는 것이 가장 명확합니다).
    - **로그 정합성**: `admin_action_log`와 `ADMIN_LESSON_LOG`가 누락 없이 기록되어야 합니다.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/lesson/dto.rs`)**:
    - `LessonBulkCreateReq`, `LessonCreateItem`, `LessonBulkCreateRes` 정의.

2.  **Repo (`src/api/admin/lesson/repo.rs`)**:
    - `create_lesson_tx`: 트랜잭션 지원 생성 함수.
    - `exists_lesson_idx_tx`: 트랜잭션 지원 중복 검사 함수.
    - `create_lesson_log_tx`: 트랜잭션 지원 로그 기록 함수.

3.  **Service (`src/api/admin/lesson/service.rs`)**:
    - `admin_bulk_create_lessons`: 부분 성공 로직(Loop + Tx) 구현.

4.  **Handler (`src/api/admin/lesson/handler.rs`)**:
    - 핸들러 구현 (201 vs 207).

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/lesson/dto.rs
// src/api/admin/lesson/repo.rs
// src/api/admin/lesson/service.rs
// src/api/admin/lesson/handler.rs
// src/api/admin/lesson/router.rs
// src/docs.rs
FILE PATCHES END