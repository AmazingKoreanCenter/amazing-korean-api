# PATCH â€” Phase 6-4 Admin Update User (PATCH /admin/users/{id})

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `PATCH /admin/users/{id}` to update specific user details.
- **RBAC Hierarchy**: A lower-level admin (Manager) MUST NOT update a higher-level admin (Admin/Hymn).
- **Logging**:
  - **Audit Log**: Record the action attempt (`action="UPDATE_USER"`).
  - **History Log**: Record the data change snapshot (`before` vs `after`) in `ADMIN_USERS_LOG`.

CONTEXT (SSOT & Rules):
1.  **Naming Convention**:
    - Handler: `admin_update_user`
    - Service: `admin_update_user`
    - Repo: `admin_update_user`
    - **Strict Consistency**: Do not use `modify`, `edit`, or `change`. Use `update`.

2.  **SQL Type Safety**:
    - **Enum Returns**: `SELECT col::TEXT` (Cast Enums to String for Rust).
    - **Enum Inputs**: Use `.bind(val.to_string())`.
    - **IP Address**: `.bind(ip.map(|i| i.to_string()))` + `$n::inet`.

3.  **Service Logic Flow**:
    1.  **Actor RBAC**: Check if requester is Admin/Manager.
    2.  **Target Existence**: Fetch target user (404 if not found).
    3.  **Target RBAC (Crucial)**: 
        - If Actor is `Manager` and Target is `Admin` or `Hymn` -> **403 Forbidden**.
    4.  **Validation**: 
        - If email changes, check duplication -> **409 Conflict**.
        - If password provided, hash it.
    5.  **Transaction**:
        - `repo::admin_update_user` (Perform Update & Return New State).
        - `repo::create_history_log` (Save Before/After snapshot).
        - `repo::create_audit_log_tx` (Save Audit Log).
    6.  **Response**: 200 OK with updated user data.

4.  **DTO Strategy**:
    - `AdminUpdateUserReq`: All fields must be `Option<T>` to support PATCH (partial update).

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/user/dto.rs`)**:
    - Ensure `AdminUpdateUserReq` has `Option` fields and implements `Serialize`, `Deserialize`, `Validate`, `ToSchema`.

2.  **Service (`src/api/admin/user/service.rs`)**:
    - Implement `admin_update_user`.
    - Ensure `check_target_user_rbac` logic is applied.
    - Handle password hashing if password field is present.

3.  **Repo (`src/api/admin/user/repo.rs`)**:
    - Ensure `admin_update_user` handles `COALESCE` properly for partial updates.
    - **Fix**: Ensure `RETURNING user_language::TEXT`, etc. are used.

4.  **Handler (`src/api/admin/user/handler.rs`)**:
    - Add `admin_update_user` handler.

5.  **Router & Docs**:
    - Register route `PATCH /admin/users/{id}`.
    - Update `docs.rs`.

FILE PATCHES START
// src/api/admin/user/dto.rs
// src/api/admin/user/service.rs
// src/api/admin/user/repo.rs
// src/api/admin/user/handler.rs
// src/api/admin/user/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. Update Nickname (Success)
curl -v -X PATCH "http://localhost:3000/admin/users/{TARGET_ID}" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{ "nickname": "UpdatedNick" }'

# 2. Update Email to existing one (409 Conflict)
curl -v -X PATCH "http://localhost:3000/admin/users/{TARGET_ID}" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{ "email": "existing@example.com" }'
```