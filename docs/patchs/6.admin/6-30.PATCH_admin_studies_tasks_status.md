# Phase 6-30 Admin Update Study Task Status (PATCH /admin/studies/tasks/{id}/status)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/studies/tasks/{id}/status` 엔드포인트를 구현하여 특정 사용자의 학습 문제 상태(Status)를 수정합니다.
- **핵심 로직**:
    1. **복합 키 식별**: Path Parameter인 `task_id`와 Request Body의 `user_id`를 조합하여 수정 대상을 식별합니다.
    2. **동적 업데이트**: `QueryBuilder`를 사용하여 요청된 필드(`Some`)만 `UPDATE` 쿼리에 포함합니다.

CONTEXT (SSOT & Rules):
1.  **테이블 구조 (Schema)**:
    - Table: `STUDY_TASK_STATUS`
    - Identifier: `study_task_id` + `user_id` (Composite Key).
    - CS 대응(점수 보정, 완료 취소 등)을 위해 관리자가 데이터를 수정할 수 있어야 합니다.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`TaskStatusUpdateReq`**:
        - `user_id`: `i64` (필수 - 식별자 역할).
        - `study_task_status_try`: `Option<i32>`.
        - `study_task_status_best`: `Option<i32>`.
        - `study_task_status_completed`: `Option<bool>`.
        - `study_task_status_last_answer`: `Option<DateTime<Utc>>` (타임스탬프 수정 가능).
    - *Note*: `study_task_id`는 Path Parameter로 받습니다.

3.  **로직 흐름 (Service)**:
    - 1) **권한 체크**: RBAC.
    - 2) **Audit Log (필수)**: 함수 진입 직후 `user::repo::create_audit_log` 호출.
        - Action: `"UPDATE_TASK_STATUS"` (대문자).
        - Target Table: `Some("STUDY_TASK_STATUS")`.
        - Target ID: `req.task_id`.
        - Details: `req` 전체 (user_id 포함).
    - 3) **데이터 존재 확인 (Before)**:
        - `repo::find_task_status`(`task_id`, `user_id`) 호출.
        - 없으면 `404 Not Found`.
    - 4) **트랜잭션 시작**: `pool.begin()`.
    - 5) **동적 업데이트**: `repo::update_task_status` (QueryBuilder 사용).
    - 6) **변경된 데이터 조회 (After)**: 업데이트 후 다시 조회.
    - 7) **Data Log**: `repo::create_study_log` 호출.
        - Action: `"update"` (**소문자 필수**).
        - Before: 3번 데이터.
        - After: 6번 데이터.
    - 8) **커밋**: 트랜잭션 종료.

4.  **기술적 유의사항**:
    - **참조 구현**: `admin_update_task_explain` (Phase 6-27)의 복합 키 처리 및 동적 업데이트 방식을 그대로 따르세요.
    - **QueryBuilder**: `sqlx::QueryBuilder`를 사용하여 `SET` 절을 동적으로 구성하세요.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `TaskStatusUpdateReq` 정의.

2.  **Repo (`src/api/admin/study/repo.rs`)**:
    - `update_task_status`: QueryBuilder 업데이트 함수 구현.
    - `find_task_status`: (없으면 구현).

3.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_update_task_status`: 로깅, 트랜잭션, Before/After 처리.

4.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현.
    - tag : admin_study_task_status

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/repo.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END