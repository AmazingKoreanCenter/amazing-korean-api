# Phase 6-28 Admin Bulk Update Task Explains (PATCH /admin/studies/tasks/bulk/explain)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/studies/tasks/bulk/explain` 엔드포인트를 구현하여 여러 개의 학습 문제 해설을 한 번에 수정합니다.
- **핵심 패턴**: `admin_bulk_update_studies` (Phase 6-18)의 **"Loop + Individual Transaction (부분 성공)"** 패턴을 사용합니다.
- **식별자**: 벌크 요청이므로 Path Parameter가 아닌, Request Body의 각 아이템 내부에 `study_task_id`와 `explain_lang`이 모두 포함되어야 합니다.

CONTEXT (SSOT & Rules):
1.  **로직 흐름 (Service)**:
    - 1) **API Log**: `user::repo::create_audit_log` 호출.
        - Action: `"BULK_UPDATE_TASK_EXPLAINS"`
        - Target Table: `Some("STUDY_TASK_EXPLAIN")` (명시 필수).
        - Details: `{"count": items.len()}`.
    - 2) **Loop Processing**:
        - 각 아이템마다 **개별 트랜잭션**(`pool.begin()`)을 시작합니다.
        - **Validation (Existence)**: `repo::find_task_explain(item.task_id, item.lang)` 호출.
            - 데이터가 없으면 `Error` ("Not Found") 처리 후 다음 아이템으로.
        - **Update**: `repo::update_task_explain` 호출 (QueryBuilder 재사용 권장).
        - **Data Log**: `repo::create_study_log` 호출.
            - Action: `"update"` (**소문자 필수**).
            - Before: Validation 단계에서 조회한 데이터.
            - After: 업데이트 후 다시 조회한 데이터.
        - **Commit**: 트랜잭션 종료.
        - **Result Collection**: 성공 시 식별자(`task_id`, `lang`), 실패 시 에러 메시지 수집.
    - 3) **Response**: 실패가 0건이면 `200 OK`, 1건이라도 있으면 `207 Multi-Status`.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`TaskExplainBulkUpdateReq`**:
        - `items`: `Vec<TaskExplainUpdateItem>`.
    - **`TaskExplainUpdateItem`**:
        - `study_task_id`: `i32` (필수, 식별자 1).
        - `explain_lang`: `UserSetLanguage` (필수, 식별자 2).
        - `explain_title`: `Option<String>`.
        - `explain_text`: `Option<String>`.
        - `explain_media_url`: `Option<String>`.
    - **`TaskExplainBulkUpdateRes`**: 성공/실패 카운트 및 결과 리스트.

3.  **기술적 유의사항**:
    - **재사용**: Phase 6-27에서 구현한 `repo::update_task_explain`을 재사용하되, 트랜잭션(`&mut tx`)을 인자로 받을 수 있는지 확인하세요.
    - **로그 정합성**: `admin_action_log`와 `admin_study_log`가 누락 없이 기록되어야 합니다.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `TaskExplainBulkUpdateReq`, `TaskExplainUpdateItem`, `TaskExplainBulkUpdateRes` 정의.

2.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_bulk_update_task_explains`: 부분 성공 로직(Loop + Tx) 구현.

3.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현 (200 vs 207).
    - tag : admin_study_task_explain

4.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END