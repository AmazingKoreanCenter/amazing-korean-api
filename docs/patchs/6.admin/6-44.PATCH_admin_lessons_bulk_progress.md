# Phase 6-44 Admin Bulk Update Lesson Progress (PATCH /admin/lessons/bulk/progress)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/lessons/bulk/progress` 엔드포인트를 구현하여 여러 건의 수업 진행 정보(Lesson Progress)를 한 번에 수정합니다.
- **핵심 패턴**: `admin_bulk_update_lesson_items` (Phase 6-41)의 **"Loop + Individual Transaction (부분 성공 207)"** 패턴을 적용합니다.

CONTEXT (SSOT & Rules):
1.  **Logic Flow (Service)**:
    - 1) **API Log**: `user::repo::create_audit_log` (Action="BULK_UPDATE_LESSON_PROGRESS").
    - 2) **Loop Processing**:
        - 각 아이템마다 **개별 트랜잭션**(`pool.begin()`)을 시작합니다.
        - **Validation 1 (Existence)**: `repo::find_lesson_progress_tx(item.lesson_id, item.user_id)` 호출.
            - 없으면 `404 Not Found`.
        - **Validation 2 (Constraint)**:
            - `lesson_progress_percent`가 존재할 경우 0~100 사이인지 확인.
            - 위반 시 `400 Bad Request`.
        - **Update**: `repo::update_lesson_progress_tx` 호출.
            - 단건 수정(Phase 6-43)에서 구현한 함수 재사용.
            - `last_progress_at` 자동 갱신 로직 유지.
        - **Data Log**: `repo::create_lesson_log_tx` (Action="update").
        - **Commit**: 트랜잭션 종료.
        - **Result Collection**: 성공 시 `(lesson_id, user_id)`, 실패 시 Error 메시지 수집.
    - 3) **Response**: 실패가 0건이면 `200 OK`, 1건이라도 있으면 `207 Multi-Status`.

2.  **DTO 설계 (Strict Requirement)**:
    - **`LessonProgressBulkUpdateReq`**:
        - `items`: `Vec<LessonProgressUpdateItem>`.
    - **`LessonProgressUpdateItem`**:
        - `lesson_id`: `i32` (식별자 1).
        - `user_id`: `i64` (식별자 2).
        - `lesson_progress_percent`: `Option<i32>`.
        - `lesson_progress_last_item_seq`: `Option<i32>`.
    - **`LessonProgressBulkUpdateRes`**: 성공/실패 카운트 및 결과 리스트.

3.  **기술적 유의사항**:
    - **Code Reuse**: Phase 6-43에서 만든 `repo::update_lesson_progress_tx`와 `repo::find_lesson_progress_tx`를 100% 재사용하세요.
    - **식별자**: 이번엔 URL에 `lesson_id`가 없으므로, DTO 내부의 `lesson_id`와 `user_id`를 사용하여 대상을 찾습니다.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/lesson/dto.rs`)**:
    - `LessonProgressBulkUpdateReq`, `LessonProgressUpdateItem`, `LessonProgressBulkUpdateRes` 정의.

2.  **Repo (`src/api/admin/lesson/repo.rs`)**:
    - (이미 필요한 트랜잭션 지원 함수들이 구현되어 있음).

3.  **Service (`src/api/admin/lesson/service.rs`)**:
    - `admin_bulk_update_lesson_progress`: 부분 성공 로직(Loop + Tx) 구현.

4.  **Handler (`src/api/admin/lesson/handler.rs`)**:
    - 핸들러 구현 (200 vs 207).

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/lesson/dto.rs
// src/api/admin/lesson/repo.rs
// src/api/admin/lesson/service.rs
// src/api/admin/lesson/handler.rs
// src/api/admin/lesson/router.rs
// src/docs.rs
FILE PATCHES END