# Phase 6-22 Admin Update Study Task (PATCH /admin/studies/tasks/{id})

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/studies/tasks/{id}` 엔드포인트를 구현하여 학습 문제의 세부 정보를 수정합니다.
- **핵심 로직**: `STUDY_TASK` 테이블(메타 정보)과 **문제 유형(`kind`)에 맞는 하위 테이블**(`CHOICE` | `TYPING` | `VOICE`)을 트랜잭션 내에서 함께 업데이트해야 합니다.

CONTEXT (SSOT & Rules):
1.  **참조 로직 (Reference)**:
    - **동적 쿼리**: Phase 6-17(`admin_update_study`)의 `QueryBuilder` 패턴을 사용하여 `None`이 아닌 필드만 업데이트하세요.
    - **로그**: **Before(수정 전) / After(수정 후)** 데이터를 비교하여 `ADMIN_STUDY_LOG`에 저장해야 합니다.

2.  **데이터 구조 및 DTO (Strict Requirements)**:
    - **모든 DTO에는 반드시 다음 매크로를 적용하세요**:
      `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]` (DB 매핑용 Response 구조체에는 `FromRow` 추가 필수)
    - **`StudyTaskUpdateReq`**:
        - `study_task_seq`: `Option<i32>` (순서 변경).
        - **공통/개별 필드**: `question`, `answer`, `image_url`, `audio_url`, `choice_1`~`4`, `choice_correct` 등 모든 하위 테이블의 컬럼을 `Option`으로 포함하는 **Flattened Structure**로 정의하세요.
        - 서비스 로직에서 `kind`에 따라 적절한 필드만 골라 업데이트합니다.

3.  **로직 흐름 (Service)**:
    - 1) **권한 체크**: RBAC.
    - 2) **기존 데이터 조회 (Before)**: `repo::find_study_task_by_id` 호출. (존재하지 않으면 404).
    - 3) **트랜잭션 시작**: `pool.begin()`.
    - 4) **메인 테이블 업데이트**: `STUDY_TASK` (seq, updated_at, updated_by 등).
    - 5) **서브 테이블 업데이트**:
        - 조회된 기존 데이터의 `study_task_kind`를 확인합니다.
        - `match kind`:
            - `Choice` -> `STUDY_TASK_CHOICE` 테이블 업데이트.
            - `Typing` -> `STUDY_TASK_TYPING` 테이블 업데이트.
            - `Voice` -> `STUDY_TASK_VOICE` 테이블 업데이트.
    - 6) **로그 기록**: `repo::create_study_log` (Action: "UPDATE_TASK").
        - `target_study_id`: 기존 데이터의 study_id.
        - `target_task_id`: 현재 task_id.
        - `before`: 조회했던 데이터.
        - `after`: 요청 데이터.
    - 7) **커밋**: 트랜잭션 종료.

4.  **기술적 유의사항**:
    - **IpAddr**: 서비스 레이어에서 `String` -> `IpAddr` 변환 로직 유지.
    - **QueryBuilder**: 테이블이 다르므로 메인 테이블용 빌더와 서브 테이블용 빌더를 각각 생성해야 합니다.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `StudyTaskUpdateReq` 정의 (모든 필드 Option, 매크로 필수).

2.  **Repo (`src/api/admin/study/repo.rs`)**:
    - `find_study_task_by_id`: 기존 데이터 조회(Join 포함) 함수.
    - `admin_update_study_task`: 메인 테이블 업데이트 및 서브 테이블 업데이트 로직 구현. (kind에 따른 분기 처리).

3.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_update_study_task` 구현. (트랜잭션 관리, Before/After 로그).

4.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현.

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/repo.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END