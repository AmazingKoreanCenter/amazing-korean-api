# PATCH — Phase 6-10 Admin Bulk Update Videos (PATCH /admin/videos/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `PATCH /admin/videos/bulk` to update multiple videos in a single request.
- **Partial Success (HTTP 207)**:
    - If some items succeed and others fail, return **207 Multi-Status**.
    - If all succeed, return **200 OK**.
- **Reusability**: **Strictly reuse** the existing `repo::admin_update_video` function implemented in Phase 6-9. Do NOT duplicate the dynamic update SQL logic.
- **RBAC**: Admin/Manager/Hymn only.
- **Logging**: Record a single `admin_action_log` summarizing the bulk operation.

CONTEXT (SSOT & Rules):
1.  **Schema & Relationships**:
    - Updates involve 3 tables: `VIDEO`, `VIDEO_TAG`, `VIDEO_TAG_MAP`.
    - The existing `repo::admin_update_video` handles the complexity (Manual comma control, Dynamic SQL).

2.  **DTO Strategy**:
    - **Request**: `VideoBulkUpdateReq` containing `items: Vec<VideoBulkUpdateItem>`.
    - **Item Structure (`VideoBulkUpdateItem`)**:
        - Must contain `id` (i64, required) -> To identify the target video.
        - Must contain all fields from `VideoUpdateReq` (optional fields) -> `video_tag_title`, `video_access`, etc.
    - **Conversion**: Inside the service loop, convert `VideoBulkUpdateItem` into `VideoUpdateReq` (stripping the `id`) to pass to the existing repo function.

3.  **Service Logic (Partial Success Pattern)**:
    - Iterate through `req.items`.
    - For each item:
        1. Start a **new transaction** (`pool.begin()`).
        2. Extract `id` and convert the rest to `VideoUpdateReq`.
        3. Call `repo::admin_update_video(tx, id, ...)` (Reusing Phase 6-9 logic).
        4. If success -> `tx.commit()` -> Add to results (Status 200).
        5. If fail (e.g., 404, 409, DB Error) -> `tx.rollback()` -> Add to results (Status 4xx/5xx).
    - **Log Action**: Create one audit log entry ("BULK_UPDATE_VIDEO") with summary stats.

4.  **Response**:
    - Use `VideoBulkUpdateRes` (Summary + List of results).
    - Status Code: 200 (All Success) or 207 (Partial Success).

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/video/dto.rs`)**:
    - Define `VideoBulkUpdateItem` (Fields: `id` + copy fields from `VideoUpdateReq`).
    - Define `VideoBulkUpdateReq` (`items: Vec<VideoBulkUpdateItem>`).
    - Define `VideoBulkUpdateRes` (Reuse or similar structure to Bulk Create).

2.  **Service (`src/api/admin/video/service.rs`)**:
    - Implement `admin_bulk_update_videos`.
    - Loop through items, handle transactions individually.
    - Call `repo::admin_update_video`.

3.  **Handler & Router**:
    - Implement `admin_bulk_update_videos` in `src/api/admin/video/handler.rs`.
    - Register route `PATCH /bulk` in `router.rs`.

4.  **Documentation (`src/docs.rs`)**:
    - Register new schemas and path.

FILE PATCHES START
// src/api/admin/video/dto.rs
// src/api/admin/video/service.rs
// src/api/admin/video/handler.rs
// src/api/admin/video/router.rs
// src/docs.rs
FILE PATCHES END

# Request Body Example
```json
{
  "items": [
    {
      "id": 1,
      "video_tag_title": "Bulk Updated Title 1",
      "video_access": "private"
    },
    {
      "id": 2,
      "video_url_vimeo": "[https://vimeo.com/999999](https://vimeo.com/999999)",
      "video_idx": "bulk_update_idx_2"
    }
  ]
}# PATCH — Phase 6-10 Admin Bulk Update Videos (PATCH /admin/videos/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `PATCH /admin/videos/bulk` to update multiple videos in a single request.
- **Partial Success (HTTP 207)**:
    - If some items succeed and others fail, return **207 Multi-Status**.
    - If all succeed, return **200 OK**.
- **Reusability**: **Strictly reuse** the existing `repo::admin_update_video` function implemented in Phase 6-9. Do NOT duplicate the dynamic update SQL logic.
- **RBAC**: Admin/Manager/Hymn only.
- **Logging**: Record a single `admin_action_log` summarizing the bulk operation.

CONTEXT (SSOT & Rules):
1.  **Schema & Relationships**:
    - Updates involve 3 tables: `VIDEO`, `VIDEO_TAG`, `VIDEO_TAG_MAP`.
    - The existing `repo::admin_update_video` handles the complexity (Manual comma control, Dynamic SQL).

2.  **DTO Strategy**:
    - **Request**: `VideoBulkUpdateReq` containing `items: Vec<VideoBulkUpdateItem>`.
    - **Item Structure (`VideoBulkUpdateItem`)**:
        - Must contain `id` (i64, required) -> To identify the target video.
        - Must contain all fields from `VideoUpdateReq` (optional fields) -> `video_tag_title`, `video_access`, etc.
    - **Conversion**: Inside the service loop, convert `VideoBulkUpdateItem` into `VideoUpdateReq` (stripping the `id`) to pass to the existing repo function.

3.  **Service Logic (Partial Success Pattern)**:
    - Iterate through `req.items`.
    - For each item:
        1. Start a **new transaction** (`pool.begin()`).
        2. Extract `id` and convert the rest to `VideoUpdateReq`.
        3. Call `repo::admin_update_video(tx, id, ...)` (Reusing Phase 6-9 logic).
        4. If success -> `tx.commit()` -> Add to results (Status 200).
        5. If fail (e.g., 404, 409, DB Error) -> `tx.rollback()` -> Add to results (Status 4xx/5xx).
    - **Log Action**: Create one audit log entry ("BULK_UPDATE_VIDEO") with summary stats.

4.  **Response**:
    - Use `VideoBulkUpdateRes` (Summary + List of results).
    - Status Code: 200 (All Success) or 207 (Partial Success).

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/video/dto.rs`)**:
    - Define `VideoBulkUpdateItem` (Fields: `id` + copy fields from `VideoUpdateReq`).
    - Define `VideoBulkUpdateReq` (`items: Vec<VideoBulkUpdateItem>`).
    - Define `VideoBulkUpdateRes` (Reuse or similar structure to Bulk Create).

2.  **Service (`src/api/admin/video/service.rs`)**:
    - Implement `admin_bulk_update_videos`.
    - Loop through items, handle transactions individually.
    - Call `repo::admin_update_video`.

3.  **Handler & Router**:
    - Implement `admin_bulk_update_videos` in `src/api/admin/video/handler.rs`.
    - Register route `PATCH /bulk` in `router.rs`.

4.  **Documentation (`src/docs.rs`)**:
    - Register new schemas and path.

FILE PATCHES START
// src/api/admin/video/dto.rs
// src/api/admin/video/service.rs
// src/api/admin/video/handler.rs
// src/api/admin/video/router.rs
// src/docs.rs
FILE PATCHES END

# Request Body Example
```json
{
  "items": [
    {
      "id": 1,
      "video_tag_title": "Bulk Updated Title 1",
      "video_access": "private"
    },
    {
      "id": 2,
      "video_url_vimeo": "[https://vimeo.com/999999](https://vimeo.com/999999)",
      "video_idx": "bulk_update_idx_2"
    }
  ]
}
```