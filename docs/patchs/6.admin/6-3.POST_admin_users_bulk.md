# PATCH â€” Phase 6-3 Admin Bulk Create Users (POST /admin/users/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `POST /admin/users/bulk` for creating multiple users at once.
- **Partial Success Strategy**: If some items fail (e.g., duplicate email), others MUST still succeed.
- **Status Codes**:
  - All Success: **201 Created**
  - Partial Success / All Failure: **207 Multi-Status**
- **Logging**:
  - **Audit Log**: One summary log for the bulk action (`action="BULK_CREATE_USERS"`).
  - **History Log**: Individual logs for each successful user creation (`action="USER_CREATE"`).

CONTEXT (SSOT & Rules):
1.  **Naming Convention**:
    - Handler: `admin_create_users_bulk`
    - Service: `admin_create_users_bulk`
    - Repo: Reuse existing `admin_create_user` (single) by iterating in Service.

2.  **SQL Type Safety**:
    - Ensure `::TEXT` for Enum returns.
    - Ensure `::inet` for IP address logging.

3.  **Response Structure (207)**:
    ```json
    {
      "summary": { "total": 10, "success": 9, "failure": 1 },
      "results": [
        { "email": "a@ex.com", "status": 201, "data": { ... } },
        { "email": "b@ex.com", "status": 409, "error": { "code": "CONFLICT", "message": "Email exists" } }
      ]
    }
    ```

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/user/dto.rs`)**:
    - `AdminBulkCreateReq`: `items: Vec<AdminCreateUserReq>` (Validate max size, e.g., 100).
    - `BulkItemResult`: Struct for individual result (success/fail).
    - `AdminBulkCreateRes`: Wrapper with summary and results list.

2.  **Service (`src/api/admin/user/service.rs`)**:
    - `admin_create_users_bulk`:
      1. RBAC Check.
      2. **Loop** through items:
         - **Start TX** (Independent TX per item recommended for 207).
         - Validation & Hash Password.
         - Call `repo::admin_create_user` & `repo::create_history_log`.
         - Commit TX.
         - Collect result (Success or Error).
      3. Log Audit (`create_audit_log`) with summary details.
      4. Return 201 (if all success) or 207 (if partial/fail).

3.  **Handler (`src/api/admin/user/handler.rs`)**:
    - `admin_create_users_bulk`: Parse body, call service.
    - Map Service result to HTTP 201 or 207.

4.  **Repo (`src/api/admin/user/repo.rs`)**:
    - Ensure `admin_create_user` is reusable.

5.  **Docs (`src/docs.rs`)**:
    - Register `AdminBulkCreateReq`, `AdminBulkCreateRes`, `BulkItemResult`.
    - Register path `admin_create_users_bulk`.

FILE PATCHES START
// src/api/admin/user/dto.rs
// src/api/admin/user/service.rs
// src/api/admin/user/handler.rs
// src/api/admin/user/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# Mixed Success/Failure Case (207 Expected)
curl -v -X POST "http://localhost:3000/admin/users/bulk" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      { "email": "bulk1@test.com", "password": "Pw1", "nickname": "B1", "user_auth": "user" },
      { "email": "existing@example.com", "password": "Pw2", "nickname": "B2", "user_auth": "user" }
    ]
  }'
```