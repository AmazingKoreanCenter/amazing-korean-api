# PATCH — Phase 6-9 Admin Update Video (PATCH /admin/videos/{id})

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `PATCH /admin/videos/{id}` to update an existing video.
- **Complex Update**: The video data spans **3 tables**.
    - `VIDEO`: `video_url_vimeo`, `video_access`, `video_idx`, `updated_by_user_id`.
    - `VIDEO_TAG`: `video_tag_title`, `video_tag_subtitle`, `video_tag_key`.
    - `VIDEO_TAG_MAP`: Connects `video_id` to `video_tag_id`.
- **RBAC**: Admin/Manager/Hymn only.
- **Logging**: Record `admin_action_log` (action="UPDATE_VIDEO").
- **Documentation**: Update `src/docs.rs` to include new schemas and paths.

CONTEXT (SSOT & Rules):
1.  **Schema & Relationships**:
    - To update tag info (title/subtitle), we first need to find the `video_tag_id` associated with the `video_id` via `VIDEO_TAG_MAP`.
    - `VIDEO` table columns: `video_id` (PK), `video_idx` (Unique), `video_access` (Enum), `video_url_vimeo`, `updated_by_user_id`.
    - `VIDEO_TAG` table columns: `video_tag_id` (PK), `video_tag_key` (Unique, Max 30 chars), `video_tag_title`, `video_tag_subtitle`.

2.  **DTO Strategy (Field Mapping)**:
    - **Request**: `VideoUpdateReq` (All fields must be `Option<T>` for PATCH behavior).
    - Field names MUST match DB columns exactly (to avoid confusion):
        - `video_tag_title`, `video_tag_subtitle`, `video_tag_key`
        - `video_url_vimeo`, `video_access`, `video_idx`
    - **Response**: Reuse `AdminVideoRes`.

3.  **Service Logic**:
    - Check RBAC.
    - Check if Video exists (404 if not).
    - Validate input (e.g., `video_tag_key` max length 30).
    - **Transaction Start**:
    - Check Duplicates (if `video_idx` or `video_tag_key` is changed).
    - Call Repo `admin_update_video`.
    - Log Action.
    - **Transaction Commit**.

4.  **Repo Logic (Dynamic Update)**:
    - Use `sqlx::QueryBuilder` to construct `UPDATE` statements dynamically.
    - **Step 1**: Find `video_tag_id` from `VIDEO_TAG_MAP` using `video_id`.
    - **Step 2**: If `VIDEO` fields are present in DTO -> Build & Execute UPDATE on `VIDEO`.
    - **Step 3**: If `VIDEO_TAG` fields are present in DTO -> Build & Execute UPDATE on `VIDEO_TAG`.
    - **Step 4**: Return updated data (Reuse logic from `admin_list_videos` retrieval part).

5.  **Type Safety (Crucial)**:
    - When returning IDs, cast to `::bigint`.
    - When returning Enums, cast to `::text`.
    - `video_access` input should be cast to `::video_access_enum`.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/video/dto.rs`)**:
    - Define `VideoUpdateReq` (derive `Deserialize`, `Validate`, `ToSchema`).
    - Apply validation rules (same as Create, but Optional).

2.  **Repo (`src/api/admin/video/repo.rs`)**:
    - Implement `admin_update_video`.
    - Signature: `fn(tx, video_id, actor_id, req) -> AppResult<AdminVideoRes>`.

3.  **Service (`src/api/admin/video/service.rs`)**:
    - Implement `admin_update_video`.
    - Handle 404 Not Found.
    - Handle 409 Conflict (Unique violation).

4.  **Handler & Router**:
    - Register `PATCH /admin/videos/{id}` in `src/api/admin/video/handler.rs` and `router.rs`.

5.  **Documentation (`src/docs.rs`)**:
    - Register `VideoUpdateReq` to schemas.
    - Register `admin_update_video` handler path.

FILE PATCHES START
// src/api/admin/video/dto.rs
// src/api/admin/video/repo.rs
// src/api/admin/video/service.rs
// src/api/admin/video/handler.rs
// src/api/admin/video/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
curl -v -X PATCH "http://localhost:3000/admin/videos/1" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "video_tag_title": "Rust 심화: 트랜잭션과 아키텍처 (수정됨)",
    "video_tag_subtitle": "QueryBuilder를 활용한 동적 업데이트 전략",
    "video_tag_key": "tag_rust_adv_update_v2",
    "video_url_vimeo": "https://vimeo.com/987654321",
    "video_access": "private",
    "video_idx": "lecture_rust_arch_update_01"
  }'
```