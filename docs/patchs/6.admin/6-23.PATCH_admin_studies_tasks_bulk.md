# Phase 6-23 Admin Bulk Update Study Tasks (PATCH /admin/studies/tasks/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/studies/tasks/bulk` 엔드포인트를 구현하여 여러 개의 학습 문제(Task)를 한 번에 수정합니다.
- **핵심 패턴**: `admin_bulk_update_studies` (Phase 6-18)의 **"Loop + Individual Transaction (부분 성공)"** 패턴을 사용하여, 요청된 항목들을 순차적으로 처리하고 성공/실패 결과를 집계합니다.

CONTEXT (SSOT & Rules):
1.  **로직 흐름 (Service)**:
    - 1) **API Log**: `user::repo::create_audit_log` 호출.
        - Action: "BULK_UPDATE_TASKS"
        - Target Table: `Some("STUDY_TASK")` (명시 필수)
        - Details: `{"count": items.len()}`
    - 2) **Loop Processing**:
        - 각 아이템마다 **개별 트랜잭션**(`pool.begin()`)을 시작합니다.
        - **조회**: `repo::find_study_task_by_id`로 기존 데이터(`before`)와 `kind`를 확인합니다. (없으면 에러 처리)
        - **메인 테이블 Update**: `repo::admin_update_study_task` (Phase 6-22 로직 재사용 권장).
        - **서브 테이블 Update**: `before.kind`에 따라 분기(`match`)하여 `repo::update_task_choice/typing/voice` 호출.
        - **Data Log**: `repo::create_study_log` 호출.
            - Action: `"update"` (**소문자 필수**).
            - Before/After 데이터 기록.
        - **Commit**: 트랜잭션 종료.
        - **Result Collection**: 성공 시 `task_id`, 실패 시 `error` 메시지 수집.
    - 3) **Response**: 실패가 0건이면 `200 OK`, 1건이라도 있으면 `207 Multi-Status`.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`StudyTaskBulkUpdateReq`**:
        - `items`: `Vec<StudyTaskUpdateItem>`
    - **`StudyTaskUpdateItem`**:
        - `study_task_id`: `i32` (필수, 식별자).
        - `study_task_seq`: `Option<i32>`.
        - **Flattened Fields**: `question`, `answer`, `choice_1`... 등 모든 서브 테이블 컬럼을 `Option`으로 포함. (Phase 6-22 DTO 참조).
    - **`StudyTaskBulkUpdateRes`**: 성공/실패 카운트 및 결과 리스트.

3.  **기술적 유의사항**:
    - **재사용**: Phase 6-22에서 구현한 Update Repository 함수들을 최대한 재사용하세요.
    - **로그 정합성**:
        - `admin_action_log`의 `target_table`은 반드시 `Some("STUDY_TASK")`여야 합니다.
        - `admin_study_log`의 `action`은 반드시 소문자 `"update"`여야 합니다.
    - **IP 주소**: `String` -> `IpAddr` 변환 로직 유지.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `StudyTaskBulkUpdateReq`, `StudyTaskUpdateItem`, `StudyTaskBulkUpdateRes` 정의.

2.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_bulk_update_study_tasks`: 부분 성공 로직 구현.
    - Loop 내에서 `kind` 확인 후 적절한 테이블 업데이트.

3.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현 (200 vs 207).

4.  **Router & Docs**:
    - 라우터 등록 및 OpenAPI 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END