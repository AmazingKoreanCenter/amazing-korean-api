# Phase 6-18 Admin Bulk Update Studies (PATCH /admin/studies/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/studies/bulk` 엔드포인트를 구현하여 여러 학습 문제(Study)를 한 번에 수정합니다.
- **핵심 패턴**: `src/api/admin/video/service.rs`의 `admin_bulk_update_videos`와 `user` 모듈의 패턴을 그대로 따라야 합니다.
    - **루프 & 개별 트랜잭션**: 전체 롤백이 아닌, 성공한 항목은 저장하고 실패한 항목은 에러를 반환하는 **부분 성공(207 Multi-Status)** 로직을 구현하세요.

CONTEXT (SSOT & Rules):
1.  **참조 로직 (Reference Pattern)**:
    - **서비스 로직**: `admin_bulk_update_videos` (Video) 또는 `admin_update_users_bulk` (User)를 참조하세요.
    - **코드 재사용**: 리포지토리에 새로운 벌크용 함수를 만들지 마세요. Phase 6-17에서 만든 **`repo::admin_update_study` (단건 수정)** 함수를 루프 안에서 호출하여 재사용해야 합니다.
    - **DTO 변환**: 벌크 요청 아이템(`StudyBulkUpdateItem`)을 단건 수정 요청(`StudyUpdateReq`) 형태로 변환하여 리포지토리에 전달하세요.

2.  **데이터 및 DTO 설계**:
    - **`StudyBulkUpdateReq`**: `items: Vec<StudyBulkUpdateItem>`을 포함.
    - **`StudyBulkUpdateItem`**:
        - `id`: 필수 (대상 식별자).
        - 나머지 필드(`idx`, `title`, `state`, `program` 등)는 모두 `Option` (Partial Update).
    - **`StudyBulkUpdateRes`**: 성공/실패 카운트 및 결과 리스트(`id`, `success`, `error`).

3.  **로직 흐름 (Service)**:
    - 1) **Audit Log**: 요청 시작 시 `user::repo::create_audit_log` (Action: "BULK_UPDATE_STUDIES").
    - 2) **루프 처리 (Loop)**:
        - `pool.begin()` (개별 트랜잭션 시작).
        - **Before 데이터 조회**: `repo::find_study_by_id`. (없으면 에러 처리 -> 롤백 -> 실패 리스트).
        - **중복 체크**: `study_idx` 변경 시 중복 검사.
        - **업데이트 실행**: `repo::admin_update_study` 호출.
        - **로그 기록**: `repo::create_study_log` (Action: "UPDATE_STUDY", Before/After 포함).
        - **커밋**: 성공 리스트 추가.
        - **실패 시**: 롤백 후 실패 리스트 추가.
    - 3) **결과 반환**: 실패가 하나라도 있으면 `207`, 모두 성공하면 `200 OK`.

4.  **기술적 유의사항**:
    - **IpAddr**: 서비스 레이어에서 `String` -> `IpAddr` 변환 로직을 유지하세요.
    - **Validator**: DTO 검증 로직이 올바르게 작동하도록 주의하세요.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `StudyBulkUpdateReq`, `StudyBulkUpdateItem` (Validate, ToSchema) 정의.
    - `StudyBulkUpdateRes`, `StudyBulkUpdateResult` 정의.

2.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_bulk_update_studies` 구현.
    - 루프 내 트랜잭션, `repo::admin_update_study` 재사용 로직 적용.

3.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현 (200 vs 207 상태 코드 분기).

4.  **Router & Docs**:
    - 라우터 등록 (`PATCH /bulk`) 및 OpenAPI 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END