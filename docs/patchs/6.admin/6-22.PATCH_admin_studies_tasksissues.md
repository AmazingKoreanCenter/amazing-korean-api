# 📝 Phase 6-22 Admin Update Study Task & Logging Troubleshooting Report

## 1. 데이터 정합성 및 DB 입력 오류 (Critical Data Issues)

### 🔴 이슈 1: `admin_study_log` Action 값 불일치 ('create' vs 'update')
* **현상:** `POST`(생성) 요청을 보냈음에도 DB `ADMIN_STUDY_LOG` 테이블의 `admin_study_action` 컬럼에 **'update'**로 기록됨.
* **원인:** Service 계층에서 Repository로 넘길 때 `"CREATE_TASK"`(대문자/사용자 정의 문자열)를 전달했으나, DB Enum 매핑 로직에서 이를 인식하지 못해 **Default 값인 'update'**로 저장됨.
* **해결:** 인자 값을 DB Enum 정의와 정확히 일치하는 **소문자 `"create"`**로 수정하여 해결.

### 🔴 이슈 2: `admin_action_log` 기록 누락 (데이터 미생성)
* **현상:** 단건 생성(`POST /tasks`) 성공 후 `ADMIN_STUDY_LOG`에는 데이터가 남았으나, `ADMIN_ACTION_LOG`(API 호출 이력)에는 데이터가 아예 생성되지 않음.
* **원인:** `admin_create_study_task` 핸들러 함수 최상단에 **`user::repo::create_audit_log` 호출 코드가 아예 누락**되어 있었음. (Bulk 생성에는 있었으나 단건 생성에서 빠짐)
* **해결:** 함수 최상단에 Audit Log 기록 코드를 추가하여 DB에 정상적으로 `INSERT` 되도록 조치.

### 🟠 이슈 3: `target_table` 컬럼 NULL 현상
* **현상:** 목록 조회(`LIST`) API 호출 시 `ADMIN_ACTION_LOG`의 `target_table` 값이 `NULL`로 기록됨.
* **원인:** 목록 조회 특성상 특정 타겟 ID가 없어 관성적으로 `None`을 넘겼으나, 로그 분석 시 가독성이 떨어짐.
* **해결:** `None` 대신 **`Some("STUDY")`**, **`Some("STUDY_TASK")`** 등 명시적인 테이블명을 문자열로 넘기도록 수정.

---

## 2. 컴파일 및 구현 이슈 (Implementation Issues)

### ⚠️ 이슈 4: 로그 인자 타입 불일치 (`Expected &Value, Found Option`)
* **현상:** 누락된 로그 코드를 추가하는 과정에서 `serde_json::to_value(&req).ok()`를 사용하자 컴파일 에러 발생.
* **원인:** `create_audit_log` 함수는 `&Value`(참조) 타입을 원하는데, `.ok()`는 `Option<Value>`를 반환함.
* **해결:** `.unwrap_or(serde_json::Value::Null)` 패턴을 사용하여 변환 실패 시 `Null` 값을 할당하고, 그 참조(`&`)를 넘기는 방식으로 수정.

---

## 3. 최종 결과 (Result)

현재 코드는 다음 사항이 보장됩니다:
1.  **Action 정확성:** 생성은 `create`, 수정은 `update`로 명확히 DB에 저장됨.
2.  **로그 이원화 완비:**
    * **누가(Who):** `ADMIN_ACTION_LOG`에 API 요청자, IP, 타겟 테이블 기록.
    * **무엇을(What):** `ADMIN_STUDY_LOG`에 변경 전(Before)/후(After) 데이터 기록.
3.  **트랜잭션 보장:** 메인 테이블(`STUDY_TASK`)과 서브 테이블(`CHOICE/TYPING/VOICE`)이 원자적으로 처리됨.