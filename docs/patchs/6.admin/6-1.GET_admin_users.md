# PATCH — Phase 6-1 Admin User List (GET /admin/users)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 6-1 `GET /admin/users` 엔드포인트 구현.
- 관리자 권한(RBAC)을 가진 사용자가 전체 회원 목록을 검색/정렬/페이징 조회.
- **Audit Logging**: 모든 관리자 액션은 DB에 기록되어야 함.

CONTEXT (SSOT & Rules):
- **Spec**: `GET /admin/users`
- **Security (RBAC)**:
  - Require `AuthUser`.
  - Check `users.user_role` (or `role`). If not 'admin' -> Return **403 Forbidden**.
  - (Note: Check actual DB schema for role column name. If missing, assume `user_role` enum or varchar).
- **Validation**:
  - `page < 1` -> **400 Bad Request**.
  - `size > 100` -> **422 Unprocessable Entity**.
  - Invalid `sort` field -> **422 Unprocessable Entity**.
- **Logging (Mandatory)**:
  - **DDL Required**: Create table `admin_action_log` if not exists.
    ```sql
    CREATE TABLE IF NOT EXISTS admin_action_log (
      log_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      admin_id BIGINT NOT NULL,
      action_type VARCHAR(50) NOT NULL,
      target_table VARCHAR(50),
      target_id BIGINT,
      details JSONB,
      ip_address INET,
      user_agent TEXT,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    ```
  - Record every access: Action="LIST_USERS", Details={ query_params }.

CONTRACT (구현 명세):
- [HTTP] `GET /admin/users`
- [Query] `AdminUserListReq`
  ```json
  {
    "page": 1, "size": 20,
    "q": "keyword",       // Search email or nickname
    "sort": "created_at", // created_at, email, nickname
    "order": "desc"       // asc, desc
  }
  ```
- [Response] `AdminUserListRes`
  ```json
  {
    "items": [
      {
        "id": 1,
        "email": "user@ex.com",
        "nickname": "Nick",
        "role": "user",
        "created_at": "..."
      }
    ],
    "meta": {
      "total_count": 100,
      "total_pages": 5,
      "current_page": 1,
      "per_page": 20
    }
  }
  ```

IMPLEMENTATION STEPS:
1.  **Schema Preparation**:
    - Ensure `admin_action_log` table exists (Execute DDL via sqlx if needed or just define logic assuming it exists).
    - Verify `users` table has role information.
2.  **DTO (`src/api/admin/user/dto.rs`)**:
    - `AdminUserListReq`: Query params (`IntoParams`).
    - `AdminUserSummary`: Response item struct (`Serialize`, `FromRow`).
    - `AdminUserListRes`: Wrapper struct.
3.  **Repo (`src/api/admin/user/repo.rs`)**:
    - `check_admin_role(user_id)`: Return bool or Result.
    - `count_users(filter)`: Dynamic count query.
    - `find_users(filter, page, size, sort)`: Dynamic select query.
    - `log_action(admin_id, action, ...)`: Insert into `admin_action_log`.
4.  **Service (`src/api/admin/user/service.rs`)**:
    - `list_users(admin_id, req)`:
      1. **RBAC**: Call `check_admin_role`. If fail -> 403.
      2. **Validate**: page/size/sort.
      3. **Log**: Call `log_action` ("LIST_USERS").
      4. **Fetch**: Call `count` & `find`.
      5. **Return**: `AdminUserListRes`.
5.  **Handler & Router**:
    - `src/api/admin/user/handler.rs`: `admin_list_users`.
    - `src/api/admin/user/router.rs`: Register route.
    - `src/api/admin/mod.rs` & `src/api/app_router.rs`: Mount `/admin`.
6.  **Docs**: Register schemas/paths.

FILE PATCHES START
// src/api/admin/mod.rs
// src/api/admin/user/mod.rs
// src/api/admin/user/dto.rs
// src/api/admin/user/repo.rs
// src/api/admin/user/service.rs
// src/api/admin/user/handler.rs
// src/api/admin/user/router.rs
// src/api/app_router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 일반 유저로 요청 (403 Expected)
curl -v "http://localhost:3000/admin/users" \
  -H "Authorization: Bearer $USER_TOKEN"

# 2. 관리자로 요청 (200 Expected + Log check)
curl -v "http://localhost:3000/admin/users?q=test&size=5" \
  -H "Authorization: Bearer $ADMIN_TOKEN"

# 3. 잘못된 파라미터 (422 Expected)
curl -v "http://localhost:3000/admin/users?size=999" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```