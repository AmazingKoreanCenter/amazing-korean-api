# POST â€” Phase 6-7 Admin Create Video (POST /admin/videos)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Implement `POST /admin/videos` to create a new video entry.
- **Complex Transaction**: Due to the N:M schema, creating a video involves inserting into **3 tables** atomically:
  1.  `VIDEO` (Main metadata: url, access, updated_by).
  2.  `VIDEO_TAG` (Content: title, subtitle).
  3.  `VIDEO_TAG_MAP` (Relation: video_id <-> video_tag_id).
- **RBAC**: Admin/Manager/Hymn only.
- **Logging**: Record `admin_action_log` (action="CREATE_VIDEO").

CONTEXT (SSOT & Rules):
1.  **Schema Mapping (Crucial)**:
    - **Input**: `title` (DTO) -> `VIDEO_TAG.video_tag_title`.
    - **Input**: `description` (DTO) -> `VIDEO_TAG.video_tag_subtitle`.
    - **Input**: `url` (DTO) -> `VIDEO.video_url_vimeo`.
    - **Input**: `is_public` (DTO) -> `VIDEO.video_access` ('public' or 'private').
    - **Input**: `video_idx` (DTO, Optional) -> `VIDEO.video_idx`. If null, auto-generate (e.g., UUID or Slug).
    - **Input**: `tag_key` (DTO, Optional) -> `VIDEO_TAG.video_tag_key`. If null, auto-generate.
    - **Context**: `actor_user_id` -> `VIDEO.updated_by_user_id`.

2.  **SQL Strategy (Transaction)**:
    - **Service Layer**: Manages `tx = pool.begin()`.
    - **Repo Layer**: `admin_create_video` accepts `&mut tx`.
    - **Steps**:
        1. Insert `VIDEO` -> Return `video_id`.
        2. Insert `VIDEO_TAG` -> Return `video_tag_id`.
        3. Insert `VIDEO_TAG_MAP` -> Link them.
    - **Type Casting**: Ensure `::video_access_enum` and `::video_state_enum` are used.

3.  **DTOs**:
    - `VideoCreateReq`: `title`, `description` (Option), `url`, `is_public` (bool), `video_idx` (Option).
    - `VideoRes` (or reuse `AdminVideoRes`): Return the created video details.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/video/dto.rs`)**:
    - Define `VideoCreateReq` (Validate: title min length, url format).

2.  **Repo (`src/api/admin/video/repo.rs`)**:
    - Implement `admin_create_video`.
    - Signature: `fn(tx: &mut Transaction, actor_id: i64, req: &VideoCreateReq) -> AppResult<AdminVideoRes>`
    - Use `RETURNING` clauses to get IDs immediately.

3.  **Service (`src/api/admin/video/service.rs`)**:
    - Implement `admin_create_video`.
    - Logic:
        - Check RBAC.
        - Start Transaction (`begin`).
        - Check Duplicate `video_idx` (if provided).
        - Call `repo::admin_create_video`.
        - Create Audit Log (`create_audit_log`).
        - Commit Transaction.

4.  **Handler & Router**:
    - Add `create_video_handler` to `src/api/admin/video/handler.rs`.
    - Ensure it's registered in `router.rs` (it might be already registered as placeholder, update it).

FILE PATCHES START
// src/api/admin/video/dto.rs
// src/api/admin/video/repo.rs
// src/api/admin/video/service.rs
// src/api/admin/video/handler.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
curl -v -X POST "http://localhost:3000/admin/videos" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "New Lesson Video",
    "description": "Introduction to Rust",
    "url": "[https://vimeo.com/123456789](https://vimeo.com/123456789)",
    "is_public": true,
    "video_idx": "lesson_01_rust" 
  }'
```