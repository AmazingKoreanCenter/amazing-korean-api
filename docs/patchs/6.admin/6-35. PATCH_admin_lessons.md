# Phase 6-36 Admin Update Lesson (PATCH /admin/lessons/{id})

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/lessons/{id}` 엔드포인트를 구현하여 특정 수업(Lesson)을 수정합니다.
- **핵심 전략**: Phase 6-35(Bulk Update)에서 이미 구현된 **Repository 함수들을 100% 재사용**하여 로직을 구성합니다.

CONTEXT (SSOT & Rules):
1.  **로직 흐름 (Service)**:
    - 1) **권한 체크**: RBAC.
    - 2) **Audit Log (필수)**: `user::repo::create_audit_log` 호출.
        - Action: `"UPDATE_LESSON"` (대문자).
        - Target Table: `Some("LESSON")`.
        - Target ID: `req.lesson_id`.
    - 3) **트랜잭션 시작**: `pool.begin()`.
    - 4) **데이터 존재 확인 (Before)**:
        - `repo::find_lesson_by_id_tx` 호출.
        - 없으면 `404 Not Found`.
    - 5) **중복 검사 (Duplicate Check)**:
        - 조건: 요청에 `lesson_idx`가 `Some`이고, **기존(Before) 값과 다를 경우**.
        - 동작: `repo::exists_lesson_idx_excluding_id_tx` 호출.
        - 결과: 중복이면 `409 Conflict`.
    - 6) **업데이트 수행**:
        - `repo::update_lesson_tx` 호출 (Phase 6-35에서 구현됨).
        - `updated_by_user_id`를 현재 관리자 ID로 설정.
    - 7) **변경된 데이터 조회 (After)**: 업데이트 후 다시 조회.
    - 8) **Data Log**: `repo::create_lesson_log_tx` 호출.
        - Action: `"update"` (**소문자 필수**).
        - Before: 4번 데이터.
        - After: 7번 데이터.
    - 9) **커밋**: 트랜잭션 종료.
    - 10) **응답**: 200 OK.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`LessonUpdateReq`**:
        - `lesson_idx`: `Option<String>`.
        - `lesson_title`: `Option<String>`.
        - `lesson_subtitle`: `Option<String>`.
        - `lesson_description`: `Option<String>`.
    - *Note*: `lesson_id`는 Path Parameter로 받습니다.

3.  **기술적 유의사항**:
    - **재사용**: `src/api/admin/lesson/repo.rs`에 이미 구현된 함수들을 최대한 활용하세요. 새로 쿼리를 짤 필요가 없습니다.
    - **QueryBuilder**: 이미 벌크 구현 시 안전하게(`push_bind_unseparated` 등 사용) 구현되었으므로 안심하고 호출하세요.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/lesson/dto.rs`)**:
    - `LessonUpdateReq` 정의.

2.  **Repo (`src/api/admin/lesson/repo.rs`)**:
    - (이미 Phase 6-35에서 필요한 함수들이 구현되어 있어야 함. 만약 `find_lesson_by_id_tx` 등이 없다면 추가 구현).

3.  **Service (`src/api/admin/lesson/service.rs`)**:
    - `admin_update_lesson`: 트랜잭션 내에서 조회 -> 검증 -> 수정 -> 로깅 흐름 구현.

4.  **Handler (`src/api/admin/lesson/handler.rs`)**:
    - 핸들러 구현 (200 OK).

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/lesson/dto.rs
// src/api/admin/lesson/repo.rs
// src/api/admin/lesson/service.rs
// src/api/admin/lesson/handler.rs
// src/api/admin/lesson/router.rs
// src/docs.rs
FILE PATCHES END