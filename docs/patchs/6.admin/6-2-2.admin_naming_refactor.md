# PATCH â€” Admin Naming Refactor & Fix (Phase 6-1 & 6-2)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- Refactor `src/api/admin/user/*` to enforce **Unified Naming Convention**.
- Fix all **SQL Type Mismatches** (`INET`, `ENUM`).
- Fix **Auth Module Visibility** (`password` mod).

CONTEXT (SSOT & Rules):

1.  **Naming Convention (Strict 1:1 Mapping)**:
    - The function name MUST be identical across Handler, Service, and Repo layers for the main feature.
    - **List Users**: `admin_list_users` (Handler) -> `admin_list_users` (Service) -> `admin_list_users` (Repo)
    - **Get User**: `admin_get_user` (Handler) -> `admin_get_user` (Service) -> `admin_get_user` (Repo)
    - **Create User**: `admin_create_user` (Handler) -> `admin_create_user` (Service) -> `admin_create_user` (Repo)
    - **Update User**: `admin_update_user` (Handler) -> `admin_update_user` (Service) -> `admin_update_user` (Repo)

2.  **Repo Helper Functions (Naming Exception)**:
    - Internal helpers in Repo can have distinct names:
      - `exists_email`
      - `create_audit_log` (for `admin_action_log`)
      - `create_history_log` (for `ADMIN_USERS_LOG`)

3.  **SQL Type Safety (CRITICAL)**:
    - **IP Address**:
      - Rust: `Option<IpAddr>`
      - Bind: `.bind(ip.map(|i| i.to_string()))`
      - SQL: `$n::inet`
    - **Enum (Read/Select)**:
      - SQL: `user_language::TEXT as language`, `user_country::TEXT as country`.
    - **Enum (Write/Insert)**:
      - Rust: `enum_val.to_string()`
      - SQL: Simple string binding usually works for TEXT columns, but if column is ENUM type, use `$n::user_auth_enum` or just pass string if driver supports. (Safest: Pass string, ensure DB casts if needed).

4.  **Logging Logic**:
    - **Audit Log (`admin_action_log`)**:
      - Insert on EVERY action (List, Get, Create, Update).
      - Use `create_audit_log` (non-tx) or `create_audit_log_tx` (tx).
    - **History Log (`ADMIN_USERS_LOG`)**:
      - Insert only on DATA CHANGE (Create, Update).
      - Use `create_history_log` (tx).

IMPLEMENTATION STEPS:

1.  **`src/api/auth/mod.rs`**:
    - Ensure `pub mod password;` is present to fix visibility error.

2.  **`src/api/admin/user/repo.rs`**:
    - Implement `admin_list_users`, `admin_get_user`, `admin_create_user`, `admin_update_user`.
    - Implement helpers: `exists_email`, `create_audit_log`, `create_history_log`.
    - **Fix**: Apply all `::inet` and `::TEXT` casts.

3.  **`src/api/admin/user/service.rs`**:
    - Implement `admin_list_users`, `admin_get_user`, `admin_create_user`, `admin_update_user`.
    - Ensure logical flow: RBAC -> Validate -> Business Logic -> Log -> Return.

4.  **`src/api/admin/user/handler.rs`**:
    - Update handler functions to call the new Unified Service function names.

FILE PATCHES START
// src/api/auth/mod.rs
// src/api/admin/user/repo.rs
// src/api/admin/user/service.rs
// src/api/admin/user/handler.rs
FILE PATCHES END