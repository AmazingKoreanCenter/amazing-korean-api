# Phase 6-43 Admin Update Lesson Progress (PATCH /admin/lessons/{lesson_id}/progress)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/lessons/{lesson_id}/progress` 엔드포인트를 구현하여 특정 사용자의 수업 진행 상황을 수정합니다.
- **핵심 로직**: 복합 키(`lesson_id`, `user_id`)를 사용하여 대상을 찾고, 진척도(Percent)나 마지막 위치(Seq)를 업데이트합니다.

CONTEXT (SSOT & Rules):
1.  **Identifier Strategy**:
    - `LESSON_PROGRESS` 테이블의 PK는 `(lesson_id, user_id)`입니다.
    - URL에는 `lesson_id`만 포함되어 있으므로, **Body에서 `user_id`를 반드시 받아야** 대상을 특정할 수 있습니다.

2.  **DTO 설계 (Strict Requirement)**:
    - **`LessonProgressUpdateReq`**:
        - `user_id`: `i64` (필수, 식별자).
        - `lesson_progress_percent`: `Option<i32>` (0~100 범위 검증 권장).
        - `lesson_progress_last_item_seq`: `Option<i32>`.

3.  **로직 흐름 (Service)**:
    - 1) **권한 체크**: RBAC.
    - 2) **유효성 검사**: `percent`가 있다면 0~100 사이인지 확인.
    - 3) **API Log**: `user::repo::create_audit_log` (Action="UPDATE_LESSON_PROGRESS").
    - 4) **트랜잭션 시작**: `pool.begin()`.
    - 5) **대상 조회 (Before)**:
        - `repo::find_lesson_progress_tx(lesson_id, user_id)` 호출.
        - 없으면 `404 Not Found`.
    - 6) **업데이트 수행**:
        - `repo::update_lesson_progress_tx` 호출.
        - `QueryBuilder`를 사용하여 `Some`인 필드만 업데이트.
        - `lesson_progress_last_progress_at`은 자동으로 `now()`로 갱신.
    - 7) **변경된 데이터 조회 (After)**: 업데이트 후 다시 조회.
    - 8) **Data Log**: `repo::create_lesson_log_tx` 호출.
        - Action: `"update"`.
        - `admin_pick_lesson_id`: `req.lesson_id`.
        - `admin_lesson_before`: 5번 데이터.
        - `admin_lesson_after`: 7번 데이터.
    - 9) **커밋**: 트랜잭션 종료.
    - 10) **응답**: 200 OK.

4.  **기술적 유의사항**:
    - **QueryBuilder**: `admin_update_lesson` 등에서 사용한 패턴을 적용하여 안전하게 동적 쿼리를 생성하세요.
    - **Repo 재사용**: 만약 조회 함수(`find_lesson_progress`)가 이미 존재한다면 `_tx` 버전을 확인하고 재사용하세요.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/lesson/dto.rs`)**:
    - `LessonProgressUpdateReq` 정의.

2.  **Repo (`src/api/admin/lesson/repo.rs`)**:
    - `find_lesson_progress_tx`: 복합 키 조회.
    - `update_lesson_progress_tx`: 동적 업데이트 함수.

3.  **Service (`src/api/admin/lesson/service.rs`)**:
    - `admin_update_lesson_progress`: 조회 -> 검증 -> 수정 -> 로깅 흐름 구현.

4.  **Handler (`src/api/admin/lesson/handler.rs`)**:
    - 핸들러 구현.

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/lesson/dto.rs
// src/api/admin/lesson/repo.rs
// src/api/admin/lesson/service.rs
// src/api/admin/lesson/handler.rs
// src/api/admin/lesson/router.rs
// src/docs.rs
FILE PATCHES END