# Phase 6-31 Admin Bulk Update Task Status (PATCH /admin/studies/tasks/bulk/status)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/studies/tasks/bulk/status` 엔드포인트를 구현하여 여러 개의 학습 문제 상태(Status)를 한 번에 수정합니다.
- **핵심 패턴**: `admin_bulk_update_task_explains` (Phase 6-28)의 **"Loop + Individual Transaction (부분 성공)"** 패턴을 사용합니다.
- **식별자**: Request Body의 각 아이템 내부에 `study_task_id`와 `user_id`가 모두 포함되어야 합니다. (Composite Key).

CONTEXT (SSOT & Rules):
1.  **로직 흐름 (Service)**:
    - 1) **API Log**: `user::repo::create_audit_log` 호출.
        - Action: `"BULK_UPDATE_TASK_STATUS"`
        - Target Table: `Some("STUDY_TASK_STATUS")` (명시 필수).
        - Details: `{"count": items.len()}`.
    - 2) **Loop Processing**:
        - 각 아이템마다 **개별 트랜잭션**(`pool.begin()`)을 시작합니다.
        - **Validation (Existence)**: `repo::find_task_status_tx(tx, item.task_id, item.user_id)` 호출.
            - 데이터가 없으면 `Error` ("Not Found") 처리 후 다음 아이템으로.
        - **Update**: Phase 6-30에서 구현한 `repo::update_task_status` 함수를 **재사용**합니다.
            - *Tip*: Bulk Item DTO를 Single Update DTO(`TaskStatusUpdateReq`)로 변환하여 전달하면 효율적입니다.
        - **Data Log**: `repo::create_study_log` 호출.
            - Action: `"update"` (**소문자 필수**).
            - Before: Validation 단계 데이터.
            - After: 업데이트 후 데이터.
        - **Commit**: 트랜잭션 종료.
        - **Result Collection**: 성공 시 식별자(`task_id`, `user_id`), 실패 시 에러 메시지 수집.
    - 3) **Response**: 실패가 0건이면 `200 OK`, 1건이라도 있으면 `207 Multi-Status`.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`TaskStatusBulkUpdateReq`**:
        - `items`: `Vec<TaskStatusUpdateItem>`.
    - **`TaskStatusUpdateItem`**:
        - `study_task_id`: `i32` (필수, 식별자 1).
        - `user_id`: `i64` (필수, 식별자 2).
        - `study_task_status_try`: `Option<i32>`.
        - `study_task_status_best`: `Option<i32>`.
        - `study_task_status_completed`: `Option<bool>`.
        - `study_task_status_last_answer`: `Option<DateTime<Utc>>`.
    - **`TaskStatusBulkUpdateRes`**: 성공/실패 카운트 및 결과 리스트.

3.  **기술적 유의사항**:
    - **코드 재사용**: `repo::update_task_status`는 이미 `QueryBuilder` 콤마 이슈(`push_bind_unseparated`)가 해결된 상태이므로, 이를 그대로 호출하여 안전성을 확보하세요.
    - **로그 정합성**: `admin_action_log`와 `admin_study_log`가 누락 없이 기록되어야 합니다.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `TaskStatusBulkUpdateReq`, `TaskStatusUpdateItem`, `TaskStatusBulkUpdateRes` 정의.
    - *Tip*: `TaskStatusUpdateItem` -> `TaskStatusUpdateReq` 변환 로직(From/Into)을 구현하면 Service 코드가 깔끔해집니다.

2.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_bulk_update_task_status`: 부분 성공 로직(Loop + Tx) 구현.

3.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현 (200 vs 207).
    - tag : admin_study_task_status

4.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END