# Phase 6-36 Admin Bulk Update Lessons (PATCH /admin/lessons/bulk)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/lessons/bulk` 엔드포인트를 구현하여 여러 개의 수업(Lesson)을 한 번에 수정합니다.
- **핵심 패턴**: `admin_bulk_update_task_explains`의 **"Loop + Individual Transaction (부분 성공 207)"** 패턴을 적용합니다.

CONTEXT (SSOT & Rules):
1.  **로직 흐름 (Service)**:
    - 1) **API Log**: `user::repo::create_audit_log` 호출.
        - Action: `"BULK_UPDATE_LESSONS"`
        - Target Table: `Some("LESSON")`.
        - Details: `{"count": items.len()}`.
    - 2) **Loop Processing**:
        - 각 아이템마다 **개별 트랜잭션**(`pool.begin()`)을 시작합니다.
        - **Validation 1 (Existence)**: `repo::find_lesson_by_id_tx` 호출.
            - 없으면 `Error` ("Not Found") 처리.
        - **Validation 2 (Duplicate Idx)**: 만약 `req.lesson_idx`가 `Some`이고, 기존 값과 다르다면?
            - `repo::exists_lesson_idx_excluding_id_tx` 호출하여 중복 검사.
            - 중복 시 `409 Conflict`.
        - **Update**: `repo::update_lesson_tx` 호출 (QueryBuilder 사용).
            - `updated_by_user_id`를 현재 관리자 ID로 갱신.
        - **Data Log**: `repo::create_lesson_log_tx` 호출.
            - Action: `"update"` (**소문자 필수**).
            - Before: Validation 1에서 조회한 데이터.
            - After: 업데이트 후 다시 조회한 데이터.
            - `pick_item_seq` 등은 `None`.
        - **Commit**: 트랜잭션 종료.
        - **Result Collection**: 성공 시 `id`, 실패 시 `error` 메시지 수집.
    - 3) **Response**: 실패가 0건이면 `200 OK`, 1건이라도 있으면 `207 Multi-Status`.

2.  **DTO 설계 (Strict Requirement)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`LessonBulkUpdateReq`**:
        - `items`: `Vec<LessonUpdateItem>`.
    - **`LessonUpdateItem`**:
        - `lesson_id`: `i32` (필수, 식별자).
        - `lesson_idx`: `Option<String>` (Unique 검사 필요).
        - `lesson_title`: `Option<String>`.
        - `lesson_subtitle`: `Option<String>`.
        - `lesson_description`: `Option<String>`.
    - **`LessonBulkUpdateRes`**: 성공/실패 카운트 및 결과 리스트.

3.  **기술적 유의사항**:
    - **QueryBuilder**: `admin_list_studies` 등에서 사용한 동적 쿼리 빌더(`QueryBuilder`)를 사용하여, 요청된 필드(`Some`)만 `UPDATE SET` 절에 포함하세요.
    - **Repo 구현**: 아직 단건 수정(Single Update) 기능이 없으므로, `repo::update_lesson_tx`와 `repo::find_lesson_by_id_tx`를 여기서 신규 구현해야 합니다.
    - **로그 정합성**: `admin_action_log`(요청)와 `ADMIN_LESSON_LOG`(데이터)가 누락 없이 기록되어야 합니다.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/lesson/dto.rs`)**:
    - `LessonBulkUpdateReq`, `LessonUpdateItem`, `LessonBulkUpdateRes` 정의.

2.  **Repo (`src/api/admin/lesson/repo.rs`)**:
    - `find_lesson_by_id_tx`: ID로 조회 (Lock 옵션 고려 가능, 여기선 일반 조회).
    - `exists_lesson_idx_excluding_id_tx`: 특정 ID를 제외하고 idx 중복 확인 (`WHERE lesson_idx = $1 AND lesson_id != $2`).
    - `update_lesson_tx`: QueryBuilder 기반 동적 업데이트.
    - `create_lesson_log_tx`: (기존 함수 재사용 또는 `_tx` 버전 확인).

3.  **Service (`src/api/admin/lesson/service.rs`)**:
    - `admin_bulk_update_lessons`: 부분 성공 로직(Loop + Tx) 구현.

4.  **Handler (`src/api/admin/lesson/handler.rs`)**:
    - 핸들러 구현 (200 vs 207).

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/lesson/dto.rs
// src/api/admin/lesson/repo.rs
// src/api/admin/lesson/service.rs
// src/api/admin/lesson/handler.rs
// src/api/admin/lesson/router.rs
// src/docs.rs
FILE PATCHES END