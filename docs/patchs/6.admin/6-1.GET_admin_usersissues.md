# 📝 Phase 6-1 회고 및 트러블슈팅 로그

이번 Phase는 관리자(Admin) 도메인의 핵심인 **보안 감사(Audit Logging)** 아키텍처를 수립하고, 타입 엄격성이 높은 Rust와 PostgreSQL 간의 데이터를 조율하는 과정이었습니다.

## 1. 아키텍처 결정 (Architecture Decision)

### ✅ 투 트랙 로그 전략 (Audit vs History)
* **이슈:** 기존 `ADMIN_USERS_LOG` 테이블이 존재했으나, 단순 목록 조회(Read)나 실패한 요청, IP 추적 등 "보안 감사" 목적으로 사용하기에는 구조적 한계(Target ID 필수 등)가 있었음.
* **결정:**
  1. **`admin_action_log` (신규):** 모든 관리자 활동(조회 포함)을 기록하는 **CCTV 역할**. (보안팀용)
  2. **`ADMIN_*_LOG` (기존):** 데이터 변경 시점의 스냅샷을 저장하는 **이력서 역할**. (데이터 복구용)
* **성과:** '책임 추적'과 '데이터 복구'라는 서로 다른 요구사항을 분리하여 시스템 유연성 확보.

## 2. 트러블슈팅 (Troubleshooting)

### 🔴 이슈: PostgreSQL INET 타입 매핑 에러 (500 Internal Server Error)
* **상황:** Rust의 `std::net::IpAddr` 타입을 DB의 `INET` 컬럼에 저장하려다 런타임 에러 발생.
  * `error: column "ip_address" is of type inet but expression is of type text`
* **원인:** `sqlx`가 기본 설정에서는 `IpAddr`를 Postgres의 `INET` 바이너리 타입으로 자동 변환해주지 않음. Rust는 문자열로 보냈으나, DB는 명시적인 형변환을 요구함.
* **해결:**
  1. **Rust:** `.bind(ip.to_string())`으로 IP를 명시적 문자열로 변환하여 전달.
  2. **SQL:** 쿼리 내에서 `$6::inet`과 같이 Postgres 형변환 연산자(`::`) 사용.
* **교훈:** ORM이 아닌 Raw Query(SQLx) 사용 시, DB 특화 타입(INET, UUID, JSONB 등)은 명시적 캐스팅이 안전함.

## 3. 테스트 및 검증 (Testing)

### ✅ RBAC(역할 기반 접근 제어) 검증
* **전략:** 별도의 관리자 계정을 생성하는 대신, 기존 테스트 계정(`learner`)의 권한을 SQL로 실시간 승격시켜 테스트.
  ```sql
  UPDATE users SET user_auth = 'admin' WHERE user_id = ...;
  ```
* **결과:**
  * 권한 승격 전: **403 Forbidden** (정상 차단)
  * 권한 승격 후: **200 OK** 및 `admin_action_log`에 조회 이력(IP, User-Agent) 적재 확인.

## 4. 총평 (Conclusion)
* **진행:** 관리자 기능의 '뼈대'가 되는 로그 시스템과 권한 체크 로직이 Service 레이어에 잘 정착됨.
* **향후:** 이후 모든 Admin API는 이 패턴(RBAC 체크 -> 비즈니스 로직 -> 로그 기록)을 그대로 재사용하면 됨.