# Phase 6-40 Admin Update Lesson Item (PATCH /admin/lessons/{lesson_id}/items/{seq})

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `PATCH /admin/lessons/{lesson_id}/items/{seq}` 엔드포인트를 구현하여 수업 아이템을 단건 수정합니다.
- **기능**: 순서(`seq`) 변경, 종류(`kind`) 변경, 연결된 콘텐츠(`video_id`/`task_id`) 변경을 처리합니다.

CONTEXT (SSOT & Rules):
1.  **URI Structure**:
    - `/admin/lessons/{lesson_id}/items/{seq}`
    - `lesson_id`: 수업 식별자.
    - `seq`: **수정 대상 아이템**의 현재 순서 번호 (식별자 역할).

2.  **Validation Logic (Service)**:
    - **순서 변경 시 중복 검사**:
        - 요청된 `new_seq`가 현재 `seq`와 다를 경우, 해당 `lesson_id` 내에 `new_seq`를 가진 다른 아이템이 있는지 확인 (`exists_lesson_item_tx`).
        - 존재하면 `409 Conflict`.
    - **Kind-ID 정합성 및 초기화**:
        - `kind`가 변경되거나 ID가 변경될 때, **사용하지 않는 ID 필드는 반드시 NULL 처리**해야 합니다.
        - 예: 'video' → 'study_task' 변경 시, `video_id` = NULL, `study_task_id` = New Value.
        - 예: 'video' 유지 시, `video_id`만 업데이트, `study_task_id`는 건드리지 않음(또는 NULL 유지).

3.  **Logging**:
    - **API Log**: `user::repo::create_audit_log` (Action="UPDATE_LESSON_ITEM").
    - **Data Log**: `repo::create_lesson_log_tx` (Action="update").
        - Before/After 데이터 기록.

4.  **DTO 설계**:
    - **`LessonItemUpdateReq`**:
        - `lesson_item_seq`: `Option<i32>` (변경할 새로운 순서).
        - `lesson_item_kind`: `Option<String>`.
        - `video_id`: `Option<i32>`.
        - `study_task_id`: `Option<i32>`.

5.  **로직 흐름 (Service)**:
    - 1) **Audit Log**: 요청 기록.
    - 2) **트랜잭션 시작**: `pool.begin()`.
    - 3) **Target 조회 (Before)**: `repo::find_lesson_item_tx(lesson_id, current_seq)`.
        - 없으면 `404 Not Found`.
    - 4) **순서 중복 검사**:
        - `req.lesson_item_seq`가 `Some`이고 `current_seq`와 다르다면?
        - `repo::exists_lesson_item_tx(lesson_id, new_seq)` 체크 -> 있으면 `409`.
    - 5) **업데이트 수행**: `repo::update_lesson_item_tx`.
        - **QueryBuilder 주의**: `kind`에 따라 반대편 ID를 `NULL`로 업데이트하는 로직이 필요할 수 있습니다. (또는 클라이언트가 명시적으로 보내지 않는 이상 유지).
        - *권장 전략*: `kind`가 바뀌면 클라이언트는 반드시 해당 `id`를 보내야 하며, 서버는 반대편 `id`를 `NULL`로 업데이트 쿼리에 포함해야 함.
    - 6) **Data Log**: After 데이터 조회 후 기록.
    - 7) **커밋**: 성공 시 200 OK.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/lesson/dto.rs`)**:
    - `LessonItemUpdateReq` 정의.

2.  **Repo (`src/api/admin/lesson/repo.rs`)**:
    - `find_lesson_item_tx`: 복합 키(`lesson_id`, `seq`)로 조회.
    - `update_lesson_item_tx`: QueryBuilder 사용.
        - **중요**: Kind 변경 시 ID 필드 처리를 위해 동적 쿼리 로직을 정교하게 작성하거나, 서비스에서 로직을 분기해야 함.

3.  **Service (`src/api/admin/lesson/service.rs`)**:
    - `admin_update_lesson_item`: 순서 변경 충돌 체크 및 업데이트 로직.

4.  **Handler (`src/api/admin/lesson/handler.rs`)**:
    - 핸들러 구현. Path Parameter 2개(`lesson_id`, `seq`) 처리.

5.  **Router & Docs**:
    - 라우터 등록 `/items/{seq}` 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/lesson/dto.rs
// src/api/admin/lesson/repo.rs
// src/api/admin/lesson/service.rs
// src/api/admin/lesson/handler.rs
// src/api/admin/lesson/router.rs
// src/docs.rs
FILE PATCHES END