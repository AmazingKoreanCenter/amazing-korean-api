# PATCH — Phase 6-2 Admin Create User (POST /admin/users)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 6-2 `POST /admin/users` 엔드포인트 구현.
- 관리자가 새로운 회원을 직접 생성.
- **Dual Logging Strategy**:
  1. `admin_action_log`: 보안 감사용 (Audit Trace).
  2. `ADMIN_USERS_LOG`: 데이터 변경 이력용 (Data History Snapshot).

CONTEXT (SSOT & Rules):
- **Spec**: `POST /admin/users`
- **Security (RBAC)**:
  - Require `AuthUser`.
  - Check `user_auth` IN ('admin', 'manager', 'HYMN'). Else -> **403**.
- **Validation**:
  - `email`: Valid format + Unique check (if exists -> **409 Conflict**).
  - `password`: Must be hashed before storage.
  - `user_auth`: Valid enum string.
- **Logging Strategy (Transaction)**:
  - **Audit**: `admin_action_log` (Action="CREATE_USER").
  - **History**: `ADMIN_USERS_LOG`
    - `admin_user_id`: Actor Admin ID.
    - `admin_pick_user_id`: Created User ID.
    - `admin_user_action`: 'USER_CREATE' (Use enum casting `::admin_action_enum`).
    - `admin_user_before`: `NULL`.
    - `admin_user_after`: JSON snapshot of the created user.

CONTRACT (구현 명세):
- [HTTP] `POST /admin/users`
- [Header] `Authorization: Bearer <token>`
- [Body] `AdminCreateUserReq`
  ```json
  {
    "email": "newuser@example.com",
    "password": "Password123!",
    "nickname": "Newbie",
    "user_auth": "user", // 'user', 'admin', etc.
    "name": "Real Name"
  }
  ```
- [Response] **201 Created**
  - Header: `Location: /admin/users/{id}`
  - Body: `AdminUserRes` (Created profile)

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/admin/user/dto.rs`)**:
    - `AdminCreateUserReq`: Fields + Validation (validator crate).
2.  **Repo (`src/api/admin/user/repo.rs`)**:
    - `exists_email(email)`: Check duplication.
    - `create_user_tx(tx, req, hashed_pw)`: Insert into `users` inside transaction.
    - `log_history_tx(tx, actor_id, target_id, action, before, after)`: Insert into `ADMIN_USERS_LOG`.
3.  **Service (`src/api/admin/user/service.rs`)**:
    - `admin_create_user(actor_id, req)`:
      1. RBAC Check.
      2. Validate Email Duplication -> 409.
      3. Hash Password (use `crate::api::auth::password::hash`).
      4. **Transaction Start**:
         - Insert User (`create_user_tx`).
         - Insert History Log (`log_history_tx` -> `ADMIN_USERS_LOG`).
         - Insert Audit Log (`insert_admin_action_log` -> `admin_action_log`).
      5. Commit.
      6. Return 201 result.
4.  **Handler**:
    - `admin_create_user`: Call service, set `Location` header, return 201.
5.  **Docs**: Update OpenAPI.

FILE PATCHES START
// src/api/admin/user/dto.rs
// src/api/admin/user/repo.rs
// src/api/admin/user/service.rs
// src/api/admin/user/handler.rs
// src/api/admin/user/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 중복 이메일 생성 시도 (409 Expected)
curl -v -X POST "http://localhost:3000/admin/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email": "existing@example.com", "password": "pw", "nickname": "test"}'

# 2. 정상 생성 (201 Expected)
curl -v -X POST "http://localhost:3000/admin/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email": "new_admin_created@test.com", "password": "StrongPassword1!", "nickname": "CreatedByAdmin", "user_auth": "user", "name": "AdminCreated"}'
```