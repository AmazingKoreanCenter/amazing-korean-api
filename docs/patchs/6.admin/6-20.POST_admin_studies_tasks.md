# Phase 6-20 Admin Create Study Task (POST /admin/studies/tasks)

ROLE: Senior Rust Backend AI Assistant

OBJECTIVE:
- `POST /admin/studies/tasks` 엔드포인트를 구현하여 학습 문제(Task)를 생성합니다.
- **핵심 로직**: `STUDY_TASK` 테이블(메인)에 데이터를 생성한 후, 반환된 PK(`study_task_id`)를 사용하여 **문제 유형(`kind`)에 맞는 하위 테이블**(`CHOICE`, `TYPING`, `VOICE`)에 데이터를 연달아 Insert 해야 합니다. 이 모든 과정은 **하나의 트랜잭션**으로 묶여야 합니다.

CONTEXT (SSOT & Rules):
1.  **테이블 구조 (Schema)**:
    - Main: `STUDY_TASK` (study_id, kind, seq 등).
    - Sub:
        - `STUDY_TASK_CHOICE`: 4지선다 (choice_1~4, correct 필수).
        - `STUDY_TASK_TYPING`: 주관식/단답형.
        - `STUDY_TASK_VOICE`: 음성/발음형.
    - **Logging**: `ADMIN_STUDY_LOG` 테이블에 생성 이력을 남깁니다. (주의: `STUDY_TASK_LOG`는 사용자 풀이용이므로 이번 작업 대상이 아님).

2.  **DTO 설계 (Strict Requirements)**:
    - **필수 매크로**: `#[derive(Debug, Deserialize, Serialize, Validate, ToSchema, Clone)]`.
    - **`StudyTaskCreateReq`**:
        - `study_id`: i32 (필수).
        - `study_task_kind`: Enum (Choice, Typing, Voice).
        - `study_task_seq`: i32 (Default 1).
        - **Flattened Fields**: 하위 테이블의 모든 컬럼을 `Option`으로 포함하는 평탄화된 구조로 정의하세요.
          (예: `question`, `answer`, `choice_1`, `choice_2`, `choice_correct`, `image_url`, `audio_url` 등).
        - *Note*: DTO 필드명은 API 스펙에 맞게 camelCase 또는 snake_case를 사용하되, DB 컬럼명(`study_task_choice_question` 등)과 매핑할 때 주의하세요.

3.  **로직 흐름 (Service)**:
    - 1) **권한 체크**: RBAC.
    - 2) **유효성 검사**: DTO 기본 검증(`validate`) 외에, `kind`에 따른 필수 필드 검사(예: Kind=Choice인데 `choice_1`이 없으면 400 에러)를 서비스 로직에 추가하세요.
    - 3) **트랜잭션 시작**: `pool.begin()`.
    - 4) **Main Insert**: `repo::create_study_task` 호출 -> `study_task_id` 획득.
    - 5) **Sub Insert**: `kind`에 따라 분기(`match`)하여 적절한 서브 테이블 Insert 함수 호출.
        - `repo::create_task_choice`
        - `repo::create_task_typing`
        - `repo::create_task_voice`
    - 6) **로그 기록**: `repo::create_study_log` 호출 (Action: "CREATE_TASK").
        - `target_study_id`: req.study_id
        - `target_task_id`: generated task_id
        - `after`: 생성된 데이터(JSON)
    - 7) **커밋**: 트랜잭션 종료.

4.  **기술적 유의사항**:
    - **DTO 매크로 누락 금지**: Phase 6-18의 교훈을 잊지 마세요.
    - **IpAddr**: 서비스 레이어에서 `String` -> `IpAddr` 변환 로직 유지.
    - **함수 재사용**: 로그 기록 함수(`repo::create_study_log`)는 Phase 6-15에서 만든 것을 재사용하세요.

IMPLEMENTATION STEPS:

1.  **DTO (`src/api/admin/study/dto.rs`)**:
    - `StudyTaskCreateReq` 정의 (Flattened, 매크로 필수).

2.  **Repo (`src/api/admin/study/repo.rs`)**:
    - `create_study_task` (Main).
    - `create_task_choice`, `create_task_typing`, `create_task_voice` (Sub).

3.  **Service (`src/api/admin/study/service.rs`)**:
    - `admin_create_study_task` 구현 (트랜잭션, 조건부 Insert, 로그).

4.  **Handler (`src/api/admin/study/handler.rs`)**:
    - 핸들러 구현 (201 Created).

5.  **Router & Docs**:
    - 라우터 등록 및 문서 업데이트.

FILE PATCHES START
// src/api/admin/study/dto.rs
// src/api/admin/study/repo.rs
// src/api/admin/study/service.rs
// src/api/admin/study/handler.rs
// src/api/admin/study/router.rs
// src/docs.rs
FILE PATCHES END