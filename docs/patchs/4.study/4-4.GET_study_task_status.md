# PATCH — Phase 4-4 Study Task Status (GET /studies/tasks/{id}/status)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 4-4 `GET /studies/tasks/{id}/status` 엔드포인트 구현.
- 특정 문항(Task)에 대한 사용자의 **학습 상태(Status)**, **시도 횟수**, **최고 점수** 등을 조회.
- **Auth Required**: 로그인한 사용자 본인의 기록만 조회.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [4-4] 및 [5.4-4].
- **Logic (Status Aggregation)**:
  - **Validation**: `task_id`가 `study_tasks` 테이블에 존재하는지 확인 (없으면 404).
  - **Aggregation**: `study_task_answers` 테이블에서 `user_id` + `task_id` 기준으로 집계.
    1. `attempts`: 총 제출 횟수 (`COUNT`).
    2. `is_solved`: 한 번이라도 정답(100점)을 맞춘 적이 있는지 (`BOOL_OR(score >= 100)` OR `BOOL_OR(is_correct)`).
    3. `best_score`: 역대 최고 점수 (`MAX`).
    4. `last_score` & `last_attempt_at`: 가장 최근 시도의 점수와 시간.
  - **Empty Case**: 기록이 없으면 404가 아니라 **기본값(0, false)**으로 200 OK 반환.
- **Error Handling**:
  - **401**: Unauthorized.
  - **404**: Task not found (문항 자체가 없을 때).

CONTRACT (구현 명세):
- [HTTP] `GET /studies/tasks/{id}/status`
- [Response] `TaskStatusRes`
  ```json
  {
    "task_id": 1,
    "attempts": 3,
    "is_solved": true,
    "best_score": 100,
    "last_score": 100,
    "progress": 100, // solved ? 100 : 0
    "last_attempt_at": "2024-01-02T12:00:00Z" // Option<DateTime<Utc>>
  }
  ```

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/study/dto.rs`)**:
    - `TaskStatusRes`: 응답용 Struct 정의 (`Serialize`, `ToSchema`).
2.  **Repo (`src/api/study/repo.rs`)**:
    - `exists_task`: 문항 존재 여부 확인 (boolean).
    - `find_task_status_stats`: `study_task_answers` 테이블을 조회하여 통계 정보 반환.
      - *Hint*: `SELECT COUNT(*) as attempts, BOOL_OR(is_correct) as is_solved, MAX(score) as best_score ... FROM study_task_answers ...`
    - `find_last_attempt`: 가장 최근 시도(`ORDER BY created_at DESC LIMIT 1`) 조회 (last_score용).
3.  **Service (`src/api/study/service.rs`)**:
    - `get_task_status`:
      1. Repo `exists_task` 호출 -> False면 404 에러.
      2. Repo `find_task_status_stats` 및 `find_last_attempt` 호출.
      3. 데이터가 없으면 `attempts: 0` 등 기본값 처리.
      4. `TaskStatusRes` 매핑 및 반환.
4.  **Handler & Router**:
    - `handler.rs`: `get_task_status` (AuthUser, Path param 추출).
    - `router.rs`: `GET /tasks/{id}/status` 등록.
5.  **Docs (`src/docs.rs`)**:
    - `TaskStatusRes` 스키마 등록 및 핸들러 문서화.

FILE PATCHES START
// src/api/study/dto.rs
// src/api/study/repo.rs
// src/api/study/service.rs
// src/api/study/handler.rs
// src/api/study/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 시도 기록이 있는 문항 조회 (ID: 1)
curl -v -X GET "http://localhost:3000/studies/tasks/1/status" \
  -H "Authorization: Bearer $TOKEN"

# 2. 시도 기록이 없는 문항 조회 (ID: 999 - 문항은 존재한다고 가정)
# 예상: attempts=0, is_solved=false 반환
curl -v -X GET "http://localhost:3000/studies/tasks/999/status" \
  -H "Authorization: Bearer $TOKEN"
```