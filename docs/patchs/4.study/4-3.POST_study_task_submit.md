# PATCH — Phase 4-3 Study Task Submit & Grade (POST /studies/tasks/{id}/answer)

**ROLE**:
- 당신은 Amazing Korean 프로젝트의 **"지능형 구현 전문가(Intelligent Implementation Specialist)"**입니다.
- `AMK_BACKEND_STRICT_MODE_PROTOCOL.md`와 `AMK_API_MASTER.md`의 규칙을 엄격히 준수합니다.
- **Tech Stack**: Rust, Axum 0.8, SQLx 0.7+, Utoipa 5, PostgreSQL.

**OBJECTIVE**:
- **Phase 4-3 `POST /studies/tasks/{id}/answer`** 엔드포인트를 구현하십시오.
- 사용자의 답안을 받아 **채점(Grading)**하고, 결과를 **DB 트랜잭션(Transaction)**으로 안전하게 저장하십시오.
- **Logging**: 채점 완료 후 `STUDY_TASK_LOG`에 `finish` 액션을 기록해야 합니다.
- **Status Update**: `STUDY_TASK_STATUS` 테이블의 시도 횟수와 해결 여부를 갱신해야 합니다.

**CONTEXT (SSOT & Rules)**:
1.  **Schema & Types**:
    - `study_task_status` (Upsert 대상): `user_id` (BIGINT -> `i64`), `study_task_id` (INT -> `i32`), `is_solved` (BOOLEAN), `try_count` (INT).
    - `study_task_log` (Insert 대상): `action` (Enum: `finish`), `is_correct` (BOOLEAN), `payload` (JSONB).
    - `study_task` & `_choice` / `_typing` / `_voice`: 정답(`answer`) 컬럼과 대조.
2.  **Logic (Spec 5.4-3)**:
    - **Grading (채점)**:
      - **Choice**: 유저가 선택한 인덱스(`pick`) == DB `study_task_choice_answer`.
      - **Typing**: 유저 입력 텍스트(`text`) == DB `study_task_typing_answer` (앞뒤 공백 Trim 후 비교).
      - **Voice**: 유저 입력 텍스트(STT 결과) == DB `study_task_voice_answer` (앞뒤 공백 Trim 후 비교).
    - **Transaction (Atomic)**:
      1. **STATUS Upsert**:
         - 존재하지 않으면 Insert (try=1).
         - 존재하면 Update (`try_count` + 1, `is_solved` = `old.is_solved OR new.is_correct`, `last_attempt_at` = now).
      2. **LOG Insert**:
         - `action = 'finish'`, `is_correct = result`, `payload = user_submission`.
3.  **Error Policy**:
    - **400 Bad Request**: JSON 형식이 잘못됨, 필수 필드 누락, 빈 문자열 제출.
    - **422 Unprocessable Entity**: 도메인 제약 위반 (예: 선택지 인덱스가 1~4 범위를 벗어남, 음수 인덱스).
    - **401 Unauthorized**: 로그인하지 않은 사용자.
    - **404 Not Found**: 문항 ID 없음.

**CONTRACT (API Specification)**:

### Request: `POST /studies/tasks/{id}/answer`
- **Path**: `id` (`i32`)
- **Headers**: `Authorization: Bearer ...` (Required)
- **Body (`SubmitAnswerReq`)**:
  ```json
  // Case 1: Choice (객관식)
  { "kind": "choice", "pick": 2 }

  // Case 2: Typing/Voice (주관식/발음)
  { "kind": "typing", "text": "안녕하세요" }
  ```

### Response: `200 OK` (`SubmitAnswerRes`)
```json
{
  "is_correct": true,
  "correct_answer": "2",  // 오답일 경우 정답 공개 (String으로 통일)
  "explanation": null     // 추후 확장 대비 (Optional)
}
```

**IMPLEMENTATION STEPS**:

1.  **DTO Setup (`src/api/study/dto.rs`)**:
    - `SubmitAnswerReq` Enum 정의 (`#[serde(tag = "kind")]` 사용 권장).
      - `Choice { pick: i32 }`
      - `Typing { text: String }` (Voice도 text 필드 사용 공유 가능)
    - `SubmitAnswerRes` 정의.

2.  **Repository (`src/api/study/repo.rs`)**:
    - 함수 1: `find_answer_key(task_id: i32) -> Result<Option<AnswerKeyDto>>`.
      - 문항의 `kind`와 해당 테이블의 정답(`answer`)만 조회.
    - 함수 2: `submit_grade_tx(user_id: i64, task_id: i32, is_correct: bool, payload: Json)`.
      - `sqlx::Transaction` 시작.
      - `INSERT INTO study_task_status ... ON CONFLICT ... DO UPDATE` 쿼리 실행.
      - `INSERT INTO study_task_log` 쿼리 실행.
      - Commit.

3.  **Service (`src/api/study/service.rs`)**:
    - 함수: `submit_answer(user: AuthUser, task_id: i32, req: SubmitAnswerReq)`.
    - **Step 1**: `repo.find_answer_key` 호출 -> 없으면 404.
    - **Step 2 (Validation)**:
      - DB의 `kind`와 요청의 `kind`가 일치하는지 확인 -> 불일치 시 400.
      - `pick` 범위 확인 (예: 1 미만이면 422).
      - `text`가 비어있으면 400.
    - **Step 3 (Grading)**:
      - Logic에 따라 `is_correct` 판별.
    - **Step 4 (Persist)**:
      - `repo.submit_grade_tx` 호출.
    - **Step 5**: 결과 반환. 오답일 경우 DB에서 가져온 정답을 `correct_answer` 필드에 담아 반환.

4.  **Handler (`src/api/study/handler.rs`)**:
    - 함수: `submit_answer_handler`.
    - `AuthUser` 필수 추출.

5.  **Router (`src/api/study/router.rs`)**:
    - Route: `.route("/tasks/{id}/answer", post(handler::submit_answer_handler))`.

**FILE PATCHES**:
- `src/api/study/dto.rs` (Update)
- `src/api/study/repo.rs` (Update)
- `src/api/study/service.rs` (Update)
- `src/api/study/handler.rs` (Update)
- `src/api/study/router.rs` (Update)

**cURL SMOKE TEST**:
```bash
# 1. 객관식 정답 제출 (성공 예상)
curl -X POST "http://localhost:8080/api/studies/tasks/101/answer" \
     -H "Authorization: Bearer <TOKEN>" \
     -H "Content-Type: application/json" \
     -d '{ "kind": "choice", "pick": 2 }'

# 2. 주관식 오답 제출 (실패 예상)
curl -X POST "http://localhost:8080/api/studies/tasks/102/answer" \
     -H "Authorization: Bearer <TOKEN>" \
     -H "Content-Type: application/json" \
     -d '{ "kind": "typing", "text": "틀린답" }'

# 3. 유효성 검사 실패 (422 - 범위 오류)
curl -X POST "http://localhost:8080/api/studies/tasks/101/answer" \
     -H "Authorization: Bearer <TOKEN>" \
     -H "Content-Type: application/json" \
     -d '{ "kind": "choice", "pick": 99 }' -v
```