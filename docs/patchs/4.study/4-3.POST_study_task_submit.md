# PATCH — Phase 4-3 Study Task Submit & Grade (POST /studies/tasks/{id}/answer)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 4-3 `POST /studies/tasks/{id}/answer` 엔드포인트 구현.
- 사용자의 답안을 받아 채점(Grading)하고, 결과를 DB에 **트랜잭션(Transaction)**으로 저장.
- **Auth Required**: 로그인한 사용자만 제출 가능.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [4-3] 및 [5.4-3].
- **Logic (Grading)**:
  - **Choice**: `submission.pick == db.correct_index` (일치하면 100점, 아니면 0점).
  - **Typing**: `submission.text == db.answer_text` (공백 Trim 후 비교, 일치하면 100점).
  - **Voice**: MVP 단계이므로 `audio_url`이 존재하면 100점(Pass) 처리 (추후 AI 연동).
- **DB Transaction (Atomic)**:
  1. `STUDY_TASK_STATUS`: Upsert (Insert or Update).
     - `completed = true`
     - `best_score = GREATEST(old.score, new.score)` (기존 점수보다 높을 때만 갱신하거나 로직에 따라 처리).
  2. `STUDY_TASK_LOG`: Insert (History).
     - 매 시도마다 로그 적재.
- **Error Handling**:
  - **401**: Unauthorized.
  - **404**: Task not found.
  - **422**: Domain constraint (e.g., Choice index out of bounds).

CONTRACT (구현 명세):
- [HTTP] `POST /studies/tasks/{id}/answer`
- [Request] `SubmitAnswerReq` (Enum)
  - `#[serde(rename_all = "snake_case")]`
  - Variants: `Choice { pick: i32 }`, `Typing { text: String }`, `Voice { audio_url: String }`.
- [Response] `SubmitAnswerRes`
  ```json
  {
    "task_id": 1,
    "is_correct": true,
    "score": 100,
    "correct_answer": "2" // 틀렸을 때 정답 공개 (String 변환)
  }
  ```

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/study/dto.rs`)**:
    - `SubmitAnswerReq`: 채점 요청용 Enum 정의.
    - `SubmitAnswerRes`: 결과 응답용 Struct 정의.
2.  **Repo (`src/api/study/repo.rs`)**:
    - `find_answer_key`: 채점을 위해 정답 데이터(`correct`, `answer`)를 포함하여 조회.
    - `record_submission_tx`: `STUDY_TASK_STATUS` (Upsert) + `STUDY_TASK_LOG` (Insert)를 하나의 트랜잭션으로 처리.
3.  **Service (`src/api/study/service.rs`)**:
    - `submit_answer`:
      1. Repo에서 정답 키 조회 (없으면 404).
      2. 요청 `kind`와 DB `kind` 일치 여부 검증 (400/422).
      3. **채점 로직(Grading)** 수행.
      4. Repo 트랜잭션 호출.
      5. 결과 반환.
4.  **Handler & Router**:
    - `handler.rs`: `submit_answer` (AuthUser 추출 필수).
    - `router.rs`: `POST /tasks/{id}/answer` 등록.
5.  **Docs (`src/docs.rs`)**:
    - **중요**: `SubmitAnswerReq`, `SubmitAnswerRes` 스키마 등록 및 핸들러 등록.

FILE PATCHES START
// src/api/study/dto.rs
// src/api/study/repo.rs
// src/api/study/service.rs
// src/api/study/handler.rs
// src/api/study/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. Choice 정답 제출 (ID: 15, 정답: 2번 가정)
curl -v -X POST "http://localhost:3000/studies/tasks/15/answer" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{ "choice": { "pick": 2 } }'

# 2. Typing 오답 제출 (ID: 1)
curl -v -X POST "http://localhost:3000/studies/tasks/1/answer" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{ "typing": { "text": "틀린답" } }'
```