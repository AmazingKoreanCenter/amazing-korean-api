# PATCH — Phase 4-1 Study List (GET /studies)

**ROLE**:
- 당신은 Amazing Korean 프로젝트의 **"지능형 구현 전문가(Intelligent Implementation Specialist)"**입니다.
- `AMK_BACKEND_STRICT_MODE_PROTOCOL.md`와 `AMK_API_MASTER.md`의 규칙을 엄격히 준수합니다.
- **Tech Stack**: Rust, Axum 0.8, SQLx 0.7+, Utoipa 5, PostgreSQL.

**OBJECTIVE**:
- **Phase 4-1 `GET /studies`** 엔드포인트를 구현하십시오.
- `study` 테이블에서 학습 목록을 조회합니다.
- **Error Handling**: **400 (Bad Request)**와 **422 (Unprocessable Entity)**의 경계를 명확히 구분하여 구현하십시오.
- **Type Safety**: 데이터베이스 컬럼(`BIGINT`)과 Rust 타입(`i64`) 간의 매핑을 엄격히 준수하십시오.

**CONTEXT (SSOT & Rules)**:
1.  **Schema (`study` table)**:
    - `study_id` (INT) -> Rust `i32`
    - `updated_by_user_id` (BIGINT) -> Rust **`i64`** (필수 준수)
    - `study_program` (ENUM) -> Rust Enum으로 매핑 (`src/types.rs` 또는 모듈 내 정의)
    - `study_state` (ENUM) -> 공개 엔드포인트이므로 기본적으로 `'open'` 상태만 조회합니다.
2.  **Error Policy (Spec 5.4-1)**:
    - **400 Bad Request**: JSON 문법 오류, 필수 필드 누락, 파싱 실패 (예: `page=abc`). (Axum `Query` 추출기가 자동 처리하는 영역 포함)
    - **422 Unprocessable Entity**: 도메인 제약 조건 위반 (예: `program`이 유효한 Enum 값이 아님, `per_page > 100`).
3.  **Types**:
    - 공통 타입은 `src/types.rs`를 우선 사용하고, 도메인 특화 Enum은 `dto.rs`에 정의하되 `strum::EnumString`을 활용하십시오.

**CONTRACT (API Specification)**:

### Request: `GET /studies`
- **Query Parameters (`StudyListReq`)**:
  - `page`: `Option<u32>` (기본값: 1)
  - `per_page`: `Option<u32>` (기본값: 10, 최대값: 100 -> 초과 시 422 에러 반환)
  - `program`: `Option<String>` (대상: `study_program_enum`. 유효하지 않은 문자열 -> 422 에러 반환)
  - `sort`: `Option<String>` (허용 값: `'latest'`, `'oldest'`, `'alphabetical'`. 기본값: `'latest'`)

### Response: `200 OK` (`StudyListResp`)
```json
{
  "list": [
    {
      "study_id": 1,         // i32
      "study_idx": "basic-1",
      "program": "basic_word", // Enum string
      "title": "Korean Alphabet",
      "subtitle": "Consonants",
      "state": "open",       // Enum string
      "created_at": "2026-01-20T12:00:00Z"
    }
  ],
  "meta": {
    "page": 1,            // u32
    "per_page": 10,       // u32
    "total_count": 50,    // i64 or u32 (DB count는 i64이나 JSON은 u32 호환)
    "total_pages": 5      // u32
  }
}
```

**IMPLEMENTATION STEPS**:

1.  **Module Setup**:
    - `src/api/study/` 폴더를 생성합니다.
    - 내부 파일 생성: `mod.rs`, `router.rs`, `handler.rs`, `service.rs`, `repo.rs`, `dto.rs`.
    - `src/api/mod.rs`에 모듈을 등록합니다.

2.  **Step 1: DTO & Enums (`src/api/study/dto.rs`)**:
    - `StudyProgram` enum을 정의합니다 (DB `study_program_enum`과 일치: `basic_pronunciation`, `basic_word` 등).
    - `StudyListReq` 구조체를 정의합니다. `validator` 크레이트를 쓰거나 Service에서 수동 검증합니다.
    - `StudySummaryDto` 및 `StudyListResp`를 정의합니다.

3.  **Step 2: Repository (`src/api/study/repo.rs`)**:
    - 함수: `find_open_studies(params: StudyListReq)`.
    - `sqlx::QueryBuilder`를 사용하여 동적 필터링을 구현합니다.
    - **Clause**: `WHERE study_state = 'open'::study_state_enum`.
    - **Clause**: `AND study_program = ${program}::study_program_enum` (파라미터가 있을 경우).
    - **Sorting**: `sort` 파라미터에 대해 SQL Injection을 방지하기 위해 화이트리스트 검사 후 `ORDER BY`를 적용합니다.
    - **Type Check**: `updated_by_user_id` 컬럼은 반드시 `i64`로 매핑해야 합니다.

4.  **Step 3: Service (`src/api/study/service.rs`)**:
    - 함수: `list_studies(query: StudyListReq)`.
    - **Validation Logic**:
      - `per_page > 100`이면 `AppError::UnprocessableEntity`를 반환합니다.
      - `program` 문자열이 제공되었으나 `StudyProgram::from_str()` 실패 시 `AppError::UnprocessableEntity`를 반환합니다.
    - Repo를 호출하고 Entity를 DTO로 변환합니다.

5.  **Step 4: Handler (`src/api/study/handler.rs`)**:
    - 함수: `list_studies_handler(Query(req): Query<StudyListReq>)`.
    - `AppResult`를 사용하여 에러를 전파합니다.
    - 참고: `Query` 추출 실패(예: 타입 불일치) 시 Axum이 자동으로 400 에러를 리턴하며, 이는 의도된 동작입니다.

6.  **Step 5: Router (`src/api/study/router.rs`)**:
    - 경로: `.route("/", get(handler::list_studies_handler))`로 등록합니다.

**FILE PATCHES**:
- `src/api/mod.rs` (Add `mod study;`)
- `src/api/study/mod.rs` (New)
- `src/api/study/dto.rs` (New)
- `src/api/study/repo.rs` (New)
- `src/api/study/service.rs` (New)
- `src/api/study/handler.rs` (New)
- `src/api/study/router.rs` (New)

**cURL SMOKE TEST**:
```bash
# 정상 요청
curl -X GET "http://localhost:8080/api/studies?page=1&per_page=5&program=basic_word&sort=latest"

# 422 에러 테스트 (유효하지 않은 Program)
curl -X GET "http://localhost:8080/api/studies?program=INVALID_PROGRAM" -v

# 422 에러 테스트 (페이지 크기 초과)
curl -X GET "http://localhost:8080/api/studies?per_page=999" -v
```