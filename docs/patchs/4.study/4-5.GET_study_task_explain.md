# PATCH — Phase 4-5 Study Task Explain (GET /studies/tasks/{id}/explain)

**ROLE**:
- 당신은 Amazing Korean 프로젝트의 **"지능형 구현 전문가(Intelligent Implementation Specialist)"**입니다.
- **Tech Stack**: Rust, Axum 0.8, SQLx 0.7+, Utoipa 5, PostgreSQL.

**OBJECTIVE**:
- **Phase 4-5 `GET /studies/tasks/{id}/explain`** 엔드포인트를 구현하십시오.
- 특정 문항(Task)의 **해설(Explanation)** 및 **참조 리소스(Media)**를 조회합니다.
- **Policy Enforcement (중요)**: "최소 1회 시도 후 열람" 정책을 적용합니다. 사용자가 해당 문제를 한 번도 풀지 않았다면(`try_count == 0`), 해설 데이터가 존재하더라도 **403 Forbidden**을 반환해야 합니다.

**CONTEXT (SSOT & Rules)**:
1.  **Schema**:
    - `study_task_explain`: `study_task_id`, `explain_title`, `explain_text`, `explain_media_url`.
    - `study_task_status`: `study_task_status_try_count` (시도 횟수 확인용).
2.  **Logic (Spec 5.4-5)**:
    - **Step 1 (Auth & Policy)**: 로그인한 사용자의 `study_task_status`를 조회.
      - 레코드가 없거나 `try_count < 1`인 경우 -> **403 Forbidden**.
    - **Step 2 (Data Fetch)**: `study_task_explain` 테이블 조회.
      - 해설 데이터가 없는 경우 -> **404 Not Found**.
    - **Step 3 (Logging)**: 조회 성공 시 `STUDY_TASK_LOG`에 `action='explain'`으로 로그 저장.
3.  **Data Transformation**:
    - DB의 `explain_media_url` (Nullable String) -> API의 `resources` (Array `Vec<String>`).
      - 값이 있으면 `vec![url]`, 없으면 빈 배열 `[]`.

**CONTRACT (API Specification)**:

### Request: `GET /studies/tasks/{id}/explain`
- **Path**: `id` (`i32`)
- **Headers**: `Authorization: Bearer ...` (Required)

### Response: `200 OK` (`TaskExplainRes`)
```json
{
  "title": "Why is this the answer?",
  "explanation": "Because '사과' means Apple in Korean...",
  "resources": [
    "[https://example.com/audio/explanation.mp3](https://example.com/audio/explanation.mp3)"
  ]
}
```

**IMPLEMENTATION STEPS**:

1.  **DTO Setup (`src/api/study/dto.rs`)**:
    - `TaskExplainRes` 구조체를 정의합니다. (`Serialize`, `ToSchema`)

2.  **Repository (`src/api/study/repo.rs`)**:
    - 함수 1: `get_try_count(user_id: i64, task_id: i32) -> Result<i32>`
      - `study_task_status` 테이블에서 `try_count` 조회. (없으면 0 반환).
    - 함수 2: `find_task_explain(task_id: i32) -> Result<Option<ExplainRow>>`
      - `study_task_explain` 테이블 조회.

3.  **Service (`src/api/study/service.rs`)**:
    - 함수: `get_task_explain(auth_user: AuthUser, task_id: i32)`.
    - **Policy Check**: `repo.get_try_count` < 1 이면 `AppError::Forbidden` 반환.
    - **Fetch**: `repo.find_task_explain` 호출 -> 없으면 `AppError::NotFound`.
    - **Mapping**: `explain_media_url`을 `resources` 벡터로 변환.
    - **Logging**: `repo.log_task_action(..., 'explain')` 호출 (Fire-and-forget).

4.  **Handler (`src/api/study/handler.rs`)**:
    - 함수: `get_task_explain_handler`.
    - `AuthUser` 필수.

5.  **Router (`src/api/study/router.rs`)**:
    - Route: `.route("/tasks/{id}/explain", get(handler::get_task_explain_handler))`.

**FILE PATCHES**:
- `src/api/study/dto.rs` (Update)
- `src/api/study/repo.rs` (Update)
- `src/api/study/service.rs` (Update)
- `src/api/study/handler.rs` (Update)
- `src/api/study/router.rs` (Update)

**cURL SMOKE TEST**:
```bash
# 1. 안 푼 문제 해설 조회 (403 Forbidden 예상)
curl -X GET "http://localhost:8080/api/studies/tasks/106/explain" \
     -H "Authorization: Bearer <TOKEN>" -v

# 2. 푼 문제 해설 조회 (200 OK 예상)
# (먼저 POST /answer로 정답 제출 후 실행 필요)
curl -X GET "http://localhost:8080/api/studies/tasks/101/explain" \
     -H "Authorization: Bearer <TOKEN>"
```