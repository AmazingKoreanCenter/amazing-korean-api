# PATCH — Phase 4-5 Study Task Explain (GET /studies/tasks/{id}/explain)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 4-5 `GET /studies/tasks/{id}/explain` 엔드포인트 구현.
- 특정 문항(Task)의 **해설(Explanation)** 및 **참조 리소스(Media)** 조회.
- **Policy Enforcement**: 사용자가 해당 문제를 최소 1회 이상 시도하지 않았을 경우 **403 Forbidden** 반환.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [4-5] 및 [5.4-5].
- **Schema**:
  - Table: `study_task_explain` (Updated Naming Convention).
  - Columns: `study_task_id`, `explain_text`, `explain_media_url` (Nullable Text).
- **Logic**:
  1. **Permission Check (403)**:
     - Check `study_task_log` (or `study_task_answers`) for `user_id` & `task_id` count.
     - If `attempts == 0` -> Return `AppError::Forbidden`.
  2. **Data Fetch (404)**:
     - Query `study_task_explain` table.
     - If no row found -> Return `AppError::NotFound`.
  3. **Response Mapping**:
     - `explain_text` -> `explanation`.
     - `explain_media_url` -> `resources` (Convert single `Option<String>` to `Vec<String>`).

CONTRACT (구현 명세):
- [HTTP] `GET /studies/tasks/{id}/explain`
- [Response] `TaskExplainRes`
  ```json
  {
    "task_id": 1,
    "explanation": "해설 텍스트...",
    "resources": ["[https://example.com/video.mp4](https://example.com/video.mp4)"] // Single URL wrapped in list, or empty list
  }
  ```

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/study/dto.rs`)**:
    - `TaskExplainRes` 구조체 정의 (`Serialize`, `ToSchema`).
2.  **Repo (`src/api/study/repo.rs`)**:
    - `has_attempted(user_id, task_id)`: 시도 여부 확인 쿼리.
    - `find_task_explanation(task_id)`: `study_task_explain` 테이블 조회 쿼리.
      - Query: `SELECT explain_text, explain_media_url FROM study_task_explain WHERE study_task_id = $1`
3.  **Service (`src/api/study/service.rs`)**:
    - `get_task_explanation`:
      1. Check `repo.has_attempted` -> 403 if false.
      2. Check `repo.find_task_explanation` -> 404 if none.
      3. Map `explain_media_url` (Some/None) to `Vec<String>`.
4.  **Handler & Router**:
    - `handler.rs`: `get_task_explanation` (AuthUser required).
    - `router.rs`: Route registration.
5.  **Docs (`src/docs.rs`)**:
    - Schema registration.

FILE PATCHES START
// src/api/study/dto.rs
// src/api/study/repo.rs
// src/api/study/service.rs
// src/api/study/handler.rs
// src/api/study/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 시도한 문항 (ID: 16 - 데이터 있음) -> 성공 예상
curl -v -X GET "http://localhost:3000/studies/tasks/16/explain" \
  -H "Authorization: Bearer $TOKEN"

# 2. 시도하지 않은 문항 (ID: 999) -> 403 Forbidden 예상
curl -v -X GET "http://localhost:3000/studies/tasks/999/explain" \
  -H "Authorization: Bearer $TOKEN"
```