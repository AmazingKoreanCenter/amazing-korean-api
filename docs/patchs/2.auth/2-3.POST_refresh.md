# PATCH — Phase 2-3 Token Refresh (POST /auth/refresh)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 2-3 `POST /auth/refresh` 엔드포인트 구현.
- Refresh Token Rotation (RTR) 및 재사용 탐지(Reuse Detection) 로직 적용.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.2-3] 참조.
- **Security Logic (RTR)**:
  1. 클라이언트가 `Old Refresh Token` 제출.
  2. 서버는 DB의 현재 해시와 비교.
  3. **Match**: 정상 -> `New Access` + `New Refresh` 발급 -> DB 업데이트 -> `Old Refresh` 무효화.
  4. **Mismatch (Reuse Attempt)**: 이미 로테이션된(폐기된) 토큰을 제출함 -> **토큰 탈취 의심** -> 해당 세션(`session_id`) 즉시 **전체 무효화(Revoke)** -> 409 Conflict.
- **Table**:
  - `login` (Update): `refresh_token_hash`, `updated_at` 갱신. `login_state` 변경(탈취 시).
  - `login_log` (Insert): 'rotate' 또는 'reuse_detected' 이벤트 기록.

CONTRACT (구현 명세):
- [HTTP] `POST /auth/refresh`
- [Request] `RefreshReq` { refresh_token: String }
- [Logic]
  1. **Validate**: 입력된 Refresh Token 서명/만료 검증. (`claims` 추출)
  2. **Hash**: 입력된 토큰을 해싱 (`incoming_hash`).
  3. **Transaction Start**.
  4. **Lock & Get**: `session_id`로 `login` 레코드 조회 (`FOR UPDATE`로 동시성 방어 권장).
  5. **Reuse Detection**:
     - IF `db.refresh_hash != incoming_hash`:
       - **CRITICAL**: 탈취 감지.
       - Action: 세션 상태 -> 'compromised', 로그 기록 -> 'reuse_detected'.
       - Return: 409 Conflict.
  6. **Rotation (Success Case)**:
     - `New Access`, `New Refresh` 생성.
     - DB Update: `refresh_hash` = `new_hash`.
     - Log: 'rotate'.
  7. **Commit**.
  8. **Redis Sync**: Old Key 삭제, New Key 등록.
- [Response]
  - **200 OK**: `LoginRes` (new tokens).

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/auth/dto.rs`)**:
    - `RefreshReq` 정의.
2.  **Repo (`src/api/auth/repo.rs`)**:
    - `update_refresh_token_tx`: 해시 교체.
    - `revoke_session_tx`: 세션 강제 종료 (재사용 탐지 시).
3.  **Service (`src/api/auth/service.rs`)**:
    - `refresh` 함수 구현.
    - **핵심**: Reuse Detection 로직 (`if db_hash != req_hash`).
4.  **Handler (`src/api/auth/handler.rs`)**:
    - `refresh` 핸들러 구현.
5.  **Router (`src/api/auth/router.rs`)**:
    - `/auth/refresh` 등록.

FILE PATCHES START
// src/api/auth/dto.rs
// src/api/auth/repo.rs
// src/api/auth/service.rs
// src/api/auth/handler.rs
// src/api/auth/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인 (토큰 A 획득)
# 2. 리프레시 시도 (토큰 A -> 토큰 B 교체) - 성공 200
curl -v -X POST http://localhost:3000/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{ "refresh_token": "<TOKEN_A>" }'

# 3. 리프레시 재시도 (이미 쓴 토큰 A 제출) - 실패 409 (Reuse Detected)
curl -v -X POST http://localhost:3000/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{ "refresh_token": "<TOKEN_A>" }'

# 4. 토큰 B로 시도 - 실패 401 (세션이 이미 폭파됨)
```