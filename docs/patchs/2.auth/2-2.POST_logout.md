# PATCH — Phase 2-2 Logout (POST /auth/logout)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 2-2 `POST /auth/logout` 엔드포인트 구현.
- 현재 접속 중인 세션을 만료 처리하고, 로그아웃 이력을 남김.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.2-2] 참조.
- **Table**:
  - `login` (Update): `login_state`를 'logged_out'으로 변경.
  - `login_log` (Insert): 로그아웃 이벤트 기록.
- **Auth**: `AuthUser` Extractor를 통해 요청을 보낸 사용자의 `session_id`를 식별해야 함.
- **Pattern**:
  - Transaction 사용 (`Update Login` + `Insert Log`).
  - `insert_logout_log_tx` 함수 활용 (Phase 1에서 정의됨 - `login` 테이블의 정보를 복사해서 로그 생성).

CONTRACT (구현 명세):
- [HTTP] `POST /auth/logout`
- [Auth] `AuthUser` 필수 (Access Token의 `session_id` 필요).
- [Logic]
  1. **Identify Session**: 토큰(Claims)에서 `session_id` 추출.
  2. **Transaction Start**.
  3. **Expire Session**: `login` 테이블에서 해당 `session_id`의 상태를 `logged_out` (또는 `revoked`)으로 변경.
  4. **Log Event**: `login_log` 테이블에 'logout' 이벤트 기록.
     - *Tip*: `repo.rs`의 `insert_logout_log_tx`는 `login` 테이블의 기존 데이터(IP, Device 등)를 조회하여 로그를 남기므로 별도 파라미터가 적게 듦.
  5. **Commit**.
- [Response]
  - **204 No Content**: 본문 없음.

IMPLEMENTATION STEPS:
1.  **Repo (`src/api/auth/repo.rs`)**:
    - `update_login_state_by_session_tx` 함수 확인 (Phase 1에서 이미 구현됨).
    - `insert_logout_log_tx` 함수 확인 (Phase 1에서 이미 구현됨).
2.  **Service (`src/api/auth/service.rs`)**:
    - `logout` 함수 구현.
    - 트랜잭션 내에서 위 두 Repo 함수 호출.
3.  **Handler (`src/api/auth/handler.rs`)**:
    - `logout` 핸들러 구현.
    - `AuthUser`에서 `session_id`를 꺼내 Service에 전달.
    - 성공 시 `StatusCode::NO_CONTENT` 반환.
4.  **Router (`src/api/auth/router.rs`)**:
    - `/auth/logout` 경로 등록.

FILE PATCHES START
// src/api/auth/service.rs
// src/api/auth/handler.rs
// src/api/auth/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인 (토큰 획득)
# TOKEN="..."

# 2. 로그아웃 요청
curl -v -X POST http://localhost:3000/auth/logout \
  -H "Authorization: Bearer $TOKEN"

# 3. 결과 확인
# HTTP/1.1 204 No Content
# DB: SELECT login_state FROM login WHERE login_session_id = '...'; -> 'logged_out' 확인
```