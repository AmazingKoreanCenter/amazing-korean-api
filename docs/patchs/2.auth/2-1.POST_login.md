# PATCH — Phase 2-1 Login (POST /auth/login)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 2-1 `POST /auth/login` 엔드포인트 구현.
- 이메일/비밀번호 검증 후 JWT(Access/Refresh) 토큰 발급 및 세션 DB 저장.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.2-1] 참조.
- **Table**: `users` (Read), `login` (Insert - Session), `login_log` (Insert - Audit).
- **Security**:
  - **Enumeration Safety**: 이메일이 존재하지 않아도, 존재하는 것처럼 가장하여 비밀번호 검증 시간을 소모(Dummy Verification) 후 동일하게 401 반환.
  - **Inactive User**: `user_state == false`이면 403 Forbidden.
- **Pattern**:
  - Phase 1에서 정비한 `auth/repo.rs`의 `insert_login_record_tx`, `insert_login_log_tx` 활용.
  - `Argon2` 패스워드 검증, `JWT` 발급 로직 필요.

CONTRACT (구현 명세):
- [HTTP] `POST /auth/login`
- [Validation] `400 Bad Request` (Email 형식, 필수값).
- [Logic]
  1. **User Lookup**: 이메일로 `users` 조회 (Password Hash 포함).
  2. **Credential Check**:
     - User 있음: `Argon2`로 비밀번호 검증.
     - User 없음: **Timing Attack 방지**를 위해 더미 해시 검증 수행 후 401 반환.
     - 비번 불일치: 401 반환.
  3. **State Check**: `!user_state` -> 403 반환.
  4. **Token Gen**: Access Token (짧은 만료), Refresh Token (긴 만료) 생성.
  5. **Transaction Start**:
     - `login` 테이블 INSERT (Session ID, Refresh Hash, Device Info 등).
     - `login_log` 테이블 INSERT (Event: 'login', Success: true).
  6. **Commit & Response**.
- [Response]
  - **200 OK**: `LoginRes` (access_token, refresh_token, token_type, expires_in).

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/auth/dto.rs`)**:
    - `LoginReq` (email, password).
    - `LoginRes` (access_token, refresh_token, ...).
2.  **Repo (`src/api/auth/repo.rs`)**:
    - Phase 1에서 수정된 코드 확인.
    - `find_user_by_email` (Password 포함 조회) 확인.
3.  **Service (`src/api/auth/service.rs`)**:
    - `login` 함수 구현.
    - 패스워드 검증(`utils::hash`), JWT 발급(`utils::jwt`), 트랜잭션 처리.
4.  **Handler (`src/api/auth/handler.rs`)**:
    - `login` 핸들러 구현. (UserAgent, Client IP 추출 필요).
5.  **Router (`src/api/auth/router.rs`)**:
    - `/auth/login` 경로 등록.

FILE PATCHES START
// src/api/auth/dto.rs
// src/api/auth/repo.rs
// src/api/auth/service.rs
// src/api/auth/handler.rs
// src/api/auth/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 로그인 성공 (Phase 1에서 가입한 계정)
curl -v -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test_me@example.com",
    "password": "Password123!"
  }'

# 2. 로그인 실패 (비밀번호 틀림) -> 401 Expected
curl -v -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test_me@example.com",
    "password": "WrongPassword!"
  }'

# 3. 로그인 실패 (존재하지 않는 계정) -> 401 Expected (Time safe)
curl -v -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "ghost@example.com",
    "password": "AnyPassword"
  }'
```