# 📝 Dev Notes: Phase 2-5 Implementation (POST /auth/reset-pw)

## 📋 개요
- **작업**: 비밀번호 재설정 및 세션 일괄 파기 API (`POST /auth/reset-pw`)
- **기간**: 2025.12.30
- **성격**: Security Critical (계정 탈취 대응), Session Management

---

## 🛠️ 트러블슈팅 및 주요 논의 (Troubleshooting & Discussions)

### 1. 토큰 출처 (Token Source for MVP)
- **이슈**: 현재 이메일 발송 서비스가 연동되지 않아, 비밀번호 재설정용 전용 토큰(`reset_token`)을 발급하고 전달할 방법이 없음.
- **해결**: MVP 단계에서는 기존의 **JWT Access Token**을 `reset_token` 대신 사용하여 신원을 검증하기로 함. (토큰 내 `sub`(user_id) 클레임 활용)

### 2. 로그 의미론 (Log Semantics: Refresh vs Reset)
- **논의**: 비밀번호 변경 시 기존 토큰들을 정리하고 새로 시작하므로 `refresh` 이벤트로 기록하자는 의견이 있었음.
- **결정**: `refresh`는 '세션 연장'을, `reset_pw`는 '권한 박탈 및 재설정'을 의미함. 해킹 사고 조사 시 혼동을 피하기 위해 **`USERS_LOG`에 `reset_pw`로 기록**하고, 세션 처리는 `refresh`가 아닌 **`revoke`**(강제 로그아웃) 개념으로 명확히 구분함.

### 3. N+1 조회 이슈와 기기 제한 (Potential N+1 & Device Limit)
- **이슈**: 특정 유저의 모든 세션을 삭제할 때, Redis에서 세션 ID 목록을 가져와 루프를 돌며 DB를 조회/삭제하는 로직이 포함됨. 이론상 기기가 많으면 DB 부하(N+1 문제) 발생 가능.
- **결정**:
  - 일반적인 유저가 수십, 수백 개의 기기로 동시에 로그인하는 경우는 드물기 때문에 현재 로직을 유지.
  - **Future Plan**: 향후 **Phase 5**에서 **"계정당 최대 동시 접속 기기 수 제한(예: 3대)"** 정책을 도입하여, 루프 횟수를 물리적으로 제한함으로써 성능 문제를 근본적으로 해결하기로 함.

---

## 🔑 확립된 핵심 개발 패턴 (Key Patterns)

### 1. Total Session Revocation (전체 세션 파기)
- **보안 원칙**: 비밀번호가 변경된 순간, 해당 계정의 **모든 활성 세션은 즉시 무효화**되어야 함.
- **구현**:
  - **DB**: `users` 테이블의 `user_password` 변경 + `login` 테이블의 상태를 `revoked`로 일괄 업데이트.
  - **Redis**: 해당 유저의 `user_sessions` Set을 순회하며 Access Token, Refresh Token 매핑 정보를 모두 `DEL` 처리.

### 2. Password Policy Validation
- **정책**: 단순 길이 체크뿐만 아니라 `validate_password_policy` 함수를 도입하여 **8자 이상 + 영문/숫자 혼용** 조건을 강제함. 위반 시 `422 Unprocessable Entity` 반환.

---

## ✅ 결론
- **보안 강화**: 비밀번호 변경 시 "기존 기기 강제 로그아웃" 로직을 통해 계정 탈취 시나리오에 대한 방어책 완성.
- **Phase 2 완료**: 로그인, 로그아웃, 토큰 재발급(RTR), 아이디 찾기, 비밀번호 재설정까지 **인증(Auth) 관련 핵심 기능 구현 종료**.
- **다음 단계**: **Phase 3 (사용자 관리 - 회원가입, 정보수정, 탈퇴)** 개발로 이동.