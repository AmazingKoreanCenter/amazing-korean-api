# 📝 Dev Notes: Phase 2-3 Implementation (POST /auth/refresh)

## 📋 개요
- **작업**: 토큰 재발급 API (`POST /auth/refresh`)
- **기간**: 2025.12.30
- **성격**: RTR(Refresh Token Rotation), 토큰 재사용 탐지(Reuse Detection), 보안 강화

---

## 🛠️ 트러블슈팅 (Troubleshooting)

### 1. Swagger UI에서 Set-Cookie 미표시
- **증상**: API 호출은 성공(200 OK)했으나, Swagger UI의 Response Headers 패널에 `Set-Cookie`가 보이지 않음.
- **원인**: 브라우저 보안 정책. `HttpOnly` 옵션이 설정된 쿠키는 자바스크립트(Swagger UI)에서 접근이 차단됨.
- **확인**: 개발자 도구(F12) > Network 탭에서는 정상적으로 `Set-Cookie` 헤더가 수신됨을 확인. **(정상 동작)**

### 2. 쿠키 값 이중 인코딩 (Double Encoding)
- **증상**: 쿠키 값이 `ak_refresh=ak_refresh%3D...` 형태로 이름이 중복되어 저장됨.
- **원인**: `AuthService`가 이미 완성된 `Cookie` 객체를 반환했는데, 핸들러에서 이를 문자열로 변환한 뒤 다시 `Cookie::new()`에 넣는 실수 발생.
- **해결**: 핸들러에서 `Cookie` 객체를 재조립하지 않고, `jar.add(cookie)`로 바로 추가하도록 수정.

### 3. 미들웨어 혼동 및 정리
- **이슈**: 초기 `tower_cookies` 미들웨어 누락으로 쿠키가 동작하지 않음.
- **해결**: `axum-extra`의 `CookieJar`를 사용하는 방식으로 통일하고, 불필요해진 `tower_cookies` 라이브러리 및 관련 코드를 `main.rs`에서 제거하여 의존성 최적화.

---

## 🔑 확립된 핵심 개발 패턴 (Key Patterns)

### 1. RTR & Reuse Detection (보안 핵심)
- **Rotation**: 리프레시 토큰 사용 시, 기존 토큰을 폐기(`rotate` 로그)하고 **완전히 새로운 토큰 쌍**을 발급.
- **Detection**: 이미 폐기된(Rotation된) 토큰을 다시 사용하려 하면:
  1. DB 해시 불일치 감지.
  2. 해당 세션을 즉시 `compromised` 상태로 변경.
  3. `reuse_detected` 로그 기록.
  4. Redis 세션/토큰 정보 즉시 삭제 (409 Conflict 반환).

### 2. 고성능 토큰 조회
- **변경**: 기존 `Opaque Token` -> `Base64(session_id:uuid)` 구조로 변경.
- **효과**: DB 전체 스캔 없이 `session_id`로 타겟 레코드를 즉시 조회(`FOR UPDATE` 잠금)하여 동시성 제어 및 성능 확보.

---

## ✅ 결론
- **보안 수준 격상**: 단순 갱신이 아닌 '교체 및 탈취 감지' 시스템 구축 완료.
- **로그 정책 확립**: `refresh`(단순 연장) 대신 **`rotate`**(교체) 이벤트를 사용하여 RTR 동작을 명확히 기록.
- **다음 단계**: Phase 2의 마지막 단계인 **비밀번호 변경(2-4)** 및 **계정 찾기** 등의 인증 심화 기능으로 이동.