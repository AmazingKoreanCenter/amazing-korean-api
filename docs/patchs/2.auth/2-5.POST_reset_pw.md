# PATCH — Phase 2-5 Reset Password (POST /auth/reset-pw)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 2-5 `POST /auth/reset-pw` 엔드포인트 구현.
- 유효한 토큰(JWT)과 새로운 비밀번호를 받아, 비밀번호를 변경하고 **모든 활성 세션을 무효화**함.

CONTEXT (SSOT & Rules):
- **Spec**: `docs/AMK_API_MASTER.md`의 [5.2-5] 참조.
- **Security (Session Revocation)**: 비밀번호가 변경되면 **해당 유저의 모든 활성 세션(Redis)을 즉시 삭제**해야 함. (해킹 의심 상황 대응)
- **Token**: 아직 '비밀번호 찾기 메일 발송' 기능이 없으므로, `reset_token`은 현재 우리가 사용하는 **JWT Access Token 규격**을 그대로 사용한다고 가정함. (User ID가 포함된 유효한 JWT면 통과)
- **Password Policy**: 새 비밀번호는 최소 길이를 검증해야 함 (예: 8자 이상). 위반 시 422 Unprocessable Entity 반환.
- **Log**: 성공 시 `users_log`에 `reset_pw` 이벤트 기록.

CONTRACT (구현 명세):
- [HTTP] `POST /auth/reset-pw`
- [Request] `ResetPwReq` { reset_token: String, new_password: String }
- [Logic]
  1. **Rate Limit**: Redis `rl:reset_pw:{ip}` 체크. (429)
  2. **Validation**:
     - `new_password` 길이/복잡성 검사 -> 실패 시 **422**.
     - `reset_token` JWT 서명/만료 검증 -> 실패 시 **401**.
  3. **Extract**: 토큰에서 `user_id` 추출.
  4. **Action (Transaction)**:
     - New Password Hashing (`Argon2`).
     - DB Update: `users` 테이블의 `user_password` 업데이트.
     - Log: `users_log` 테이블에 `reset_pw` 기록.
  5. **Revocation (Redis)**:
     - 해당 `user_id`의 모든 세션(`ak:user_sessions:{user_id}`) 조회 후 삭제.
     - 개별 세션 키(`ak:session:{sid}`) 및 리프레시 키(`ak:refresh:{hash}`) 모두 삭제.
  6. **Response**: 200 OK `{ "message": "Password has been reset. All active sessions are invalidated." }`

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/auth/dto.rs`)**:
    - `ResetPwReq` (token, new_password).
2.  **Repo (`src/api/auth/repo.rs`)**:
    - `update_user_password_tx`: 비밀번호 해시 업데이트.
3.  **Service (`src/api/auth/service.rs`)**:
    - `reset_password` 함수 구현.
    - 토큰 검증 로직 (기존 `jwt::verify` 활용 가능).
    - **핵심**: 비밀번호 변경 후 `logout_all` 로직과 유사하게 Redis 세션 정리.
4.  **Handler (`src/api/auth/handler.rs`)**:
    - `reset_password` 핸들러.
5.  **Router (`src/api/auth/router.rs`)**:
    - `/auth/reset-pw` 등록.

FILE PATCHES START
// src/api/auth/dto.rs
// src/api/auth/repo.rs
// src/api/auth/service.rs
// src/api/auth/handler.rs
// src/api/auth/router.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. (가정) 유효한 JWT 토큰 확보 (로그인 후 access_token 사용)
TOKEN="eyJhbGciOiJIUzI1Ni..."

# 2. 비밀번호 재설정 요청 -> 200 OK
curl -v -X POST http://localhost:3000/auth/reset-pw \
  -H "Content-Type: application/json" \
  -d "{\"reset_token\": \"$TOKEN\", \"new_password\": \"newStrongPassword123!\"}"

# 3. 기존 토큰으로 다른 API 호출 시도 -> 401 Unauthorized (세션 폭파 확인)
```