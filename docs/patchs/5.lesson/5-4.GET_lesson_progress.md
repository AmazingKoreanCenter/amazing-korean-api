# PATCH — Phase 5-4 Get Lesson Progress (GET /lessons/{id}/progress)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 5-4 `GET /lessons/{id}/progress` 엔드포인트 구현.
- 로그인한 사용자의 특정 수업 진행도(`LESSON_PROGRESS`) 조회.
- **Spec Compliance**:
  - 성공(기록 있음): 200 OK (DB 값 반환).
  - 성공(기록 없음): 200 OK (Default: 0%, null seq/time).
  - 실패(미인증): 401 Unauthorized (via AuthGuard).
  - 실패(없는 수업): 404 Not Found.

CONTEXT (SSOT & Rules):
- **Spec**: `GET /lessons/{id}/progress`.
- **Auth**: Required (`AuthUser`).
- **Schema**:
  - Table: `lesson_progress` (Composite Key: `lesson_id` + `user_id`).
  - Columns:
    - `lesson_progress_percent` (int, default 0)
    - `lesson_progress_last_item_seq` (int, nullable)
    - `lesson_progress_last_progress_at` (timestamptz, nullable)
- **Logic**:
  1. **Auth**: Extract `user_id`.
  2. **Check Lesson**: Call `repo.exists_lesson(lesson_id)`. If false -> **404 Error**.
  3. **Fetch Progress**: Query `lesson_progress` by `lesson_id` AND `user_id`.
  4. **Handle Result**:
     - If row exists -> Return data.
     - If row missing -> Return default `{ percent: 0, last_seq: null, updated_at: null }` (Do NOT return 404 for missing progress).

CONTRACT (구현 명세):
- [HTTP] `GET /lessons/{id}/progress`
- [Header] `Authorization: Bearer <token>`
- [Response] `LessonProgressRes`
  ```json
  {
    "percent": 50,
    "last_seq": 5,
    "updated_at": "2024-01-01T12:00:00Z" // or null
  }
  ```

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/lesson/dto.rs`)**:
    - `LessonProgressRes`: Struct (`Serialize`, `ToSchema`, `FromRow`).
2.  **Repo (`src/api/lesson/repo.rs`)**:
    - `find_progress(lesson_id, user_id)`: Returns `Option<LessonProgressRes>`.
      - Query: `SELECT lesson_progress_percent as percent, lesson_progress_last_item_seq as last_seq, lesson_progress_last_progress_at as updated_at FROM lesson_progress WHERE ...`
3.  **Service (`src/api/lesson/service.rs`)**:
    - `get_lesson_progress(user_id, lesson_id)`:
      1. Check `repo.exists_lesson`. If false -> 404.
      2. Call `repo.find_progress`.
      3. If None, return default `LessonProgressRes { percent: 0, ... }`.
4.  **Handler & Router**:
    - `src/api/lesson/handler.rs`: `get_lesson_progress` (Add `AuthUser` extractor).
    - `src/api/lesson/router.rs`: Register route.
5.  **Docs (`src/docs.rs`)**:
    - Register schema/path (Add security scheme).

FILE PATCHES START
// src/api/lesson/dto.rs
// src/api/lesson/repo.rs
// src/api/lesson/service.rs
// src/api/lesson/handler.rs
// src/api/lesson/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 미인증 요청 (401 Expected)
curl -v "http://localhost:3000/lessons/1/progress"

# 2. 정상 조회 (기록 없음 -> 0% 반환 예상)
curl -v "http://localhost:3000/lessons/1/progress" \
  -H "Authorization: Bearer $TOKEN"

# 3. 없는 수업 조회 (404 Expected)
curl -v "http://localhost:3000/lessons/999/progress" \
  -H "Authorization: Bearer $TOKEN"
```