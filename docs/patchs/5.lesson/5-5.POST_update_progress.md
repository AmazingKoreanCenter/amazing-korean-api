# PATCH — Phase 5-5 Update Lesson Progress (POST /lessons/{id}/progress)

ROLE: Senior Rust Backend (Axum 0.8, SQLx 0.7+, utoipa 5) AI Assistant

OBJECTIVE:
- Phase 5-5 `POST /lessons/{id}/progress` 엔드포인트 구현.
- 수업 진행도를 갱신(UPSERT)하고, 최신 상태를 반환.
- **Spec Compliance**:
  - 성공: 200 OK (Updated Progress Snapshot).
  - 실패(범위 위반): 422 Unprocessable Entity (e.g., percent < 0 or > 100).
  - 실패(미인증): 401 Unauthorized.
  - 실패(없는 수업): 404 Not Found.

CONTEXT (SSOT & Rules):
- **Spec**: `POST /lessons/{id}/progress`.
- **Auth**: Required (`AuthUser`).
- **Schema**: `lesson_progress` table.
- **Validation**:
  - `percent`: Must be between 0 and 100 (inclusive). If not -> 422 Error.
  - `last_seq`: Optional positive integer.
- **Logic (UPSERT)**:
  1. Check if lesson exists. If not -> **404**.
  2. Validate input (0 <= percent <= 100). If not -> **422**.
  3. Perform UPSERT on `lesson_progress`:
     - Keys: `(lesson_id, user_id)`
     - Update: `lesson_progress_percent`, `lesson_progress_last_item_seq`, `lesson_progress_last_progress_at = NOW()`.
  4. Return updated record.

CONTRACT (구현 명세):
- [HTTP] `POST /lessons/{id}/progress`
- [Header] `Authorization: Bearer <token>`
- [Body] `LessonProgressUpdateReq`
  ```json
  {
    "percent": 80,
    "last_seq": 8
  }
  ```
- [Response] `LessonProgressRes` (Same as GET response)
  ```json
  {
    "percent": 80,
    "last_seq": 8,
    "updated_at": "..."
  }
  ```

IMPLEMENTATION STEPS:
1.  **DTO (`src/api/lesson/dto.rs`)**:
    - `LessonProgressUpdateReq`: Input struct (`Deserialize`, `ToSchema`).
2.  **Repo (`src/api/lesson/repo.rs`)**:
    - `upsert_progress(lesson_id, user_id, percent, last_seq)`:
      - Use `INSERT ... ON CONFLICT (lesson_id, user_id) DO UPDATE ... RETURNING ...`.
      - Return `LessonProgressRes`.
3.  **Service (`src/api/lesson/service.rs`)**:
    - `update_lesson_progress(user_id, lesson_id, req)`:
      1. Check existence (404).
      2. Validate `req.percent` (0~100) -> Return 422 if invalid.
      3. Call `repo.upsert_progress`.
      4. Return result.
4.  **Handler & Router**:
    - `src/api/lesson/handler.rs`: `update_lesson_progress`.
    - `src/api/lesson/router.rs`: Register `POST /lessons/{id}/progress`.
5.  **Docs (`src/docs.rs`)**:
    - Register schema/path.

FILE PATCHES START
// src/api/lesson/dto.rs
// src/api/lesson/repo.rs
// src/api/lesson/service.rs
// src/api/lesson/handler.rs
// src/api/lesson/router.rs
// src/docs.rs
FILE PATCHES END

# cURL SMOKE TEST
```bash
# 1. 정상 갱신 (80%)
curl -v -X POST "http://localhost:3000/lessons/1/progress" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"percent": 80, "last_seq": 8}'

# 2. 범위 오류 (150% -> 422)
curl -v -X POST "http://localhost:3000/lessons/1/progress" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"percent": 150}'

# 3. 없는 수업 (404)
curl -v -X POST "http://localhost:3000/lessons/999/progress" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"percent": 50}'
```