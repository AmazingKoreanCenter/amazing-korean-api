# PATCH REQUEST — FRONTEND Phase 3-4 (Video Progress POST)

**ROLE**:
- 당신은 **Amazing Korean API의 프론트엔드 전담 AI 에이전트**입니다.
- **Tech Stack**: React (Vite), TypeScript, Tailwind CSS, Shadcn/ui, TanStack Query.
- **AMK_API_MASTER.md**의 Phase 3-4 스펙과 **상태 축(State Axis)** 정의를 엄격히 준수합니다.

**OBJECTIVE**:
- **비디오 상세 페이지(`VideoDetailPage`)**에서 사용자의 학습 진도율을 서버에 저장(Upsert)합니다.
- **Trigger Policy**:
    1.  **일시정지(Pause)** 시 저장.
    2.  **영상 종료(Ended)** 시 저장 (`progress_rate: 100` 전송).
    3.  (Optional) 페이지 이탈(`unmount`) 시 저장 시도.

**CONTEXT (Spec & State)**:
1.  **Endpoint**: `POST /videos/{id}/progress`
2.  **Request Body**:
    - **Schema**: `export const videoProgressUpdateReqSchema = z.object({ progress_rate: z.number().int().min(0).max(100) });`
    - **Caution**: `is_completed`나 `last_watched_at` 필드는 보내지 않습니다. 오직 **`progress_rate`** 하나만 보냅니다.
3.  **State Axis Flow (Form Lifecycle)**:
    - **Pristine** (대기) → **Dirty** (재생 위치 변경) → **Validating** (0~100 범위 확인) → **Submitting** (API 요청) → **Success** (200/204) 또는 **Error** (4xx).
4.  **Error Handling**:
    - **400**: 형식 오류 (숫자 아님).
    - **422**: 범위 오류 (0 미만, 100 초과).
    - **401**: 인증 만료 (Interceptor가 처리).

**MCP ACTIONS (필수 수행)**:
작업 시작 전 다음 파일들을 읽고 컨텍스트를 확보하십시오.
1.  **Read Types**: `src/types.ts` (VideoProgressUpdateReq 타입 확인, 없다면 Zod 스키마 기반으로 정의).
2.  **Read Component**: `src/category/video/page/VideoDetailPage.tsx` (Vimeo Player 이벤트 핸들러 위치 파악).
3.  **Read API**: `src/api/video.ts`.

**IMPLEMENTATION STEPS**:

1.  **Step 1. API Function (`src/api/video.ts`)**:
    - `updateVideoProgress(videoId: number, data: VideoProgressUpdateReq)` 함수를 추가하십시오.
    - **Body**: `{ progress_rate: number }`.

2.  **Step 2. Custom Hook (`src/category/video/hook/useVideoProgress.ts`)**:
    - `useUpdateVideoProgress` (Mutation)을 추가하십시오.
    - **OnSuccess**: `['video-progress', videoId]` 쿼리를 `invalidate`하여 최신 데이터(완료 여부 등)를 다시 가져오도록 하십시오.
    - **OnError**: 사용자 경험을 방해하지 않도록 `console.error`로 로그만 남기고 조용히 처리(Silent Fail)하십시오.

3.  **Step 3. Event Integration (`src/category/video/page/VideoDetailPage.tsx`)**:
    - **Client-side Validation (State: Validating)**:
        - API를 호출하기 전에 `progress_rate`가 0~100 사이의 정수(Integer)인지 확인하고, `Math.floor` 및 `Math.min/max`로 값을 보정(Clamp)하십시오. (422 에러 방지)
    - **Handlers**:
        - `onPause`: `duration > 0`일 때 백분율 계산 후 Mutation 실행. (Debounce 500ms 권장)
        - `onEnded`: 무조건 `progress_rate: 100`으로 Mutation 실행.

**PATCH RULES (Iron Rules)**:
1.  **Minimize 422 Errors**: 서버가 422를 뱉기 전에 클라이언트가 먼저 값을 0~100으로 자르고(Clamp) 정수로 변환해서 보내야 합니다.
2.  **Strict Type Compliance**: DTO에 정의되지 않은 필드(예: `last_watched_at`)를 임의로 추가하여 전송하지 마십시오.
3.  **Console Logging**: 개발 확인을 위해 전송 시점에 `[VideoProgress] Updating: { progress_rate: 55 }` 형태의 로그를 남기십시오.