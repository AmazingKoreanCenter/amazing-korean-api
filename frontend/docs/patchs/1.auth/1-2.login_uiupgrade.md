# 🚀 Backlog: Login UI & Logic Upgrade Plan (Phase 1-2+)

## 📋 개요
Phase 1-2(MVP) 로그인 기능의 **사용자 경험(UX), 보안 감사(Audit), 세션 관리(Session Management)**를 엔터프라이즈 급으로 고도화하기 위한 과제 목록입니다.
특히 **상세한 접속 로그 기록**과 **소셜 로그인** 확장에 중점을 둡니다.

---

## 1. UX 및 피드백 개선 (User Experience)

### ✅ 비밀번호 유효성 메시지 커스텀 (Custom Validation Message)
- **현재**: Zod 기본 메시지 `"Too small: expected string to have >=6 characters"` 노출.
- **개선**: 사용자 친화적이고 다국어 지원이 가능한 메시지로 변경.
  - 예: "비밀번호는 최소 6자 이상이어야 합니다." / "Password must be at least 6 characters."
- **Tech**: Zod `errorMap` 또는 `.min(6, { message: "..." })` 적용.

### ✅ 비밀번호 찾기/재설정 프로세스 (Account Recovery)
- **현재**: UI에 링크(`비밀번호를 잊으셨나요?`)만 존재하고 기능 없음.
- **구현**:
  1. **요청**: 이메일 입력 -> 백엔드에서 일회용 링크 발송.
  2. **재설정**: 링크 클릭 -> 프론트엔드 비밀번호 변경 폼 진입 (`/reset-password`).
  3. **완료**: 변경 후 기존 세션 만료 처리(Redis).

---

## 2. 보안 감사 및 로그 시스템 (Security & Logging)

### 🕵️ 정밀 접속 정보 수집 (Advanced Telemetry)
백엔드의 `LOGIN` (활성 세션) 및 `LOGIN_LOG` (이력) 테이블을 채우기 위한 데이터 수집 로직입니다.

1.  **프론트엔드 역할**:
    - `ua-parser-js` 라이브러리를 통해 브라우저, OS, 디바이스 정보 1차 파싱.
    - 화면 해상도, 시간대(TimeZone) 정보를 헤더나 바디에 포함하여 전송.
2.  **백엔드 역할 (Middleware)**:
    - **IP 분석**: 접속 IP를 GeoIP 데이터베이스(MaxMind 등)와 대조하여 `Country`, `ASN`(통신사), `Org`(기관) 추출.
    - **User-Agent 분석**: 프론트에서 보낸 정보 검증 및 정규화.

### 📊 LOGIN / LOGIN_LOG 테이블 매핑 로직
- **`LOGIN` (Active Session)**:
  - 로그인 성공 시 **Upsert** (기기/브라우저 쌍이 동일하면 갱신, 다르면 추가).
  - `login_active_at`: API 요청이 있을 때마다 갱신 (Last Seen).
  - `login_expire_at`: Refresh Token 만료 시간과 동기화.
- **`LOGIN_LOG` (History)**:
  - 로그인 시도(성공/실패) 시마다 무조건 **Insert**.
  - `login_fail_reason_log`: 실패 시 구체적 사유 기록 (비번 틀림, 차단된 IP, 없는 계정 등).
  - `login_method_log`: `email`, `google`, `apple` 등 인증 방식 기록.

---

## 3. 소셜 로그인 확장 (OAuth 2.0)

### 🔐 구글/애플 로그인 (Social Auth)
- **UI**: 로그인 폼 하단에 "Google로 계속하기", "Apple로 계속하기" 버튼 배치.
- **Flow (Authorization Code Flow)**:
  1. 프론트: 해당 플랫폼 인증 페이지 팝업/리다이렉트.
  2. 백엔드: Callback URL에서 코드를 받아 액세스 토큰 교환.
  3. DB: `users` 테이블 조회 후 없으면 자동 가입, 있으면 로그인 처리.
  4. 응답: 자체 JWT 발급하여 프론트에 전달.

---

## 4. 인프라 및 세션 관리 (Infrastructure)

### ⚡ Redis 세션 및 토큰 관리 (State Management)
- **목적**: 빠른 인증 검증 및 강제 로그아웃(Revoke) 기능 지원.
- **점검 항목**:
  1. **TTL 동기화**: Redis Key 만료 시간 == Refresh Token 만료 시간 (`login_expire_at`).
  2. **화이트리스트/블랙리스트**:
     - 현재 구조(화이트리스트): Redis에 있는 토큰만 유효. (보안성 높음)
     - 로그아웃 시: Redis에서 해당 `user_id:device_id` 키 즉시 삭제.
  3. **중복 로그인 제어**: 정책에 따라 동시 접속 허용 개수 제한 로직 추가.

### 🚫 강제 로그아웃 및 차단 (Session Revocation)
- **시나리오**: 관리자가 특정 유저 차단 or 유저가 "모든 기기에서 로그아웃" 클릭.
- **로직**:
  - `LOGIN` 테이블에서 `login_revoked_reason` 업데이트.
  - Redis에서 해당 유저의 모든 세션 Key 삭제.
  - 프론트엔드: 다음 API 요청 시 401 응답 -> 로그인 화면으로 튕김.

---

## 5. 실행 로드맵 (Roadmap)

| 우선순위 | 작업명 | 관련 기술/테이블 | 난이도 |
| :--- | :--- | :--- | :--- |
| **High** | 비밀번호 에러 메시지 개선 | Zod Custom Map | 🟢 Low |
| **High** | Redis 세션 TTL 점검 | Redis, JWT | 🟡 Medium |
| **Mid** | 상세 로그(Country/OS) 구현 | `LOGIN`, `LOGIN_LOG`, GeoIP | 🔴 High |
| **Mid** | 구글 로그인 연동 | OAuth2, GCP Console | 🔴 High |
| **Low** | 애플 로그인 연동 | OAuth2, Apple Developer | 🔴 High |
| **Low** | 비밀번호 찾기(이메일 발송) | SMTP, Mailgun/SES | 🟡 Medium |